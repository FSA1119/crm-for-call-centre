<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ToplantÄ± Penceresi</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: rgba(0, 0, 0, 0.5);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 25px rgba(0,0,0,0.15);
      padding: 36px;
      width: 98%;
      max-width: 1200px;
      animation: slideUp 0.3s ease;
      position: relative;
    }
    
    .header {
      text-align: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .header h1 {
      color: #1f2937;
      margin: 0 0 8px 0;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    
    .header p {
      color: #6b7280;
      margin: 0;
      font-size: 14px;
      font-weight: 400;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #374151;
      font-weight: 600;
      font-size: 14px;
      letter-spacing: -0.2px;
    }
    
    .required {
      color: #ef4444;
      font-weight: 600;
    }
    
    .optional {
      color: #9ca3af;
      font-size: 12px;
      font-weight: 400;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s ease;
      box-sizing: border-box;
      background: #ffffff;
      color: #111827;
    }
    
    .form-group input:hover,
    .form-group textarea:hover,
    .form-group select:hover {
      border-color: #9ca3af;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background: #ffffff;
    }
    
    .form-row {
      display: flex;
      gap: 15px;
    }
    
    .form-row .form-group {
      flex: 1;
    }
    
    .form-row-3 {
      display: flex;
      gap: 15px;
    }
    
    .form-row-3 .form-group {
      flex: 1;
    }
    
    .form-row-3 .form-group:first-child {
      flex: 2;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 90px;
      font-family: inherit;
      line-height: 1.6;
      padding: 12px 14px;
    }
    
    .buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }
    
    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      letter-spacing: -0.2px;
    }
    
    .btn-secondary {
      background: #6b7280;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }
    
    .appointment-info {
      background: linear-gradient(135deg, #f8f9fa 0%, #f1f5f9 100%);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 24px;
      border-left: 4px solid #667eea;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .appointment-info h3 {
      margin: 0 0 16px 0;
      color: #1f2937;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: -0.3px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 14px;
      padding: 4px 0;
    }
    
    .info-row:last-child {
      margin-bottom: 0;
    }
    
    .info-label {
      font-weight: 500;
      color: #6b7280;
    }
    
    .info-value {
      color: #111827;
      font-weight: 600;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }
    
    .status-confirmed {
      background: #d4edda;
      color: #155724;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-cancelled {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“… ToplantÄ± Penceresi</h1>
      <p>SeÃ§ilen randevu iÃ§in toplantÄ± detaylarÄ±nÄ± girin</p>
    </div>
    
    <div class="appointment-info">
      <h3>ğŸ“‹ Randevu Bilgileri</h3>
      <div class="info-row">
        <span class="info-label">Temsilci:</span>
        <span class="info-value"><?= rowData && rowData.Kod ? rowData.Kod : '-' ?></span>
      </div>
      <div class="info-row">
        <span class="info-label">Åirket:</span>
        <span class="info-value"><?= rowData && rowData['Company name'] ? rowData['Company name'] : '-' ?></span>
      </div>
      <div class="info-row">
        <span class="info-label">Tarih:</span>
        <span class="info-value"><?= rowData && rowData['Randevu Tarihi'] ? rowData['Randevu Tarihi'] : '-' ?></span>
      </div>
      <div class="info-row">
        <span class="info-label">Saat:</span>
        <span class="info-value"><?= rowData && rowData['Saat'] ? rowData['Saat'] : '-' ?></span>
      </div>
      <div class="info-row">
        <span class="info-label">Durum:</span>
        <span class="info-value">
          <span class="status-badge status-confirmed"><?= rowData && rowData['Randevu durumu'] ? rowData['Randevu durumu'] : '-' ?></span>
        </span>
      </div>
    </div>
    
    <form id="meetingForm">
      <!-- ZORUNLU ALAN: ToplantÄ±yÄ± Yapan (sadece "ToplantÄ± GerÃ§ekleÅŸti" durumunda) -->
      <div class="form-group" id="toplantiYapanGroup" style="display: none;">
        <label for="toplantiYapan">ğŸ‘¤ ToplantÄ±yÄ± Yapan <span class="required">*</span></label>
        <select id="toplantiYapan" name="toplantiYapan">
          <option value="">SeÃ§iniz...</option>
        </select>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="meetingDate">ğŸ“… ToplantÄ± Tarihi *</label>
          <input type="date" id="meetingDate" name="meetingDate" required value="<?= defaultMeetingDate || '' ?>">
        </div>
        <div class="form-group">
          <label for="meetingTime">ğŸ• ToplantÄ± Saati *</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <select id="meetingHour" name="meetingHour" required style="flex: 1;">
              <option value="">Saat</option>
            </select>
            <span style="font-size: 18px; font-weight: bold;">:</span>
            <select id="meetingMinute" name="meetingMinute" required style="flex: 1;">
              <option value="">Dakika</option>
            </select>
          </div>
          <input type="hidden" id="meetingTime" name="meetingTime">
        </div>
      </div>
      
      <div class="form-group">
        <label for="meetingFormat">ğŸ“‹ ToplantÄ± FormatÄ± *</label>
        <select id="meetingFormat" name="meetingFormat" required>
          <option value="">Format seÃ§in</option>
        </select>
        <script>
          // Store HTML strings in JavaScript variables (will be set by backend via template)
          var meetingFormatsHTML = <?= JSON.stringify(meetingFormatsHTML || '') ?>;
          var toplantiYapanHTML = <?= JSON.stringify(toplantiYapanHTML || '') ?>;
          var toplantiSonucuHTML = <?= JSON.stringify(toplantiSonucuHTML || '') ?>;
          var teklifDetayiHTML = <?= JSON.stringify(teklifDetayiHTML || '') ?>;
          var satisPotansiyeliHTML = <?= JSON.stringify(satisPotansiyeliHTML || '') ?>;
          var isToplantiGerceklesti = <?= isToplantiGerceklesti ? 'true' : 'false' ?>;
          var defaultMeetingDate = <?= defaultMeetingDate ? JSON.stringify(defaultMeetingDate) : 'null' ?>;
          var defaultMeetingTime = <?= defaultMeetingTime ? JSON.stringify(defaultMeetingTime) : 'null' ?>;
          var defaultMeetingHour = <?= defaultMeetingHour ? JSON.stringify(defaultMeetingHour) : 'null' ?>;
          var defaultMeetingMinute = <?= defaultMeetingMinute ? JSON.stringify(defaultMeetingMinute) : 'null' ?>;
          var defaultMeetingFormat = <?= defaultMeetingFormat ? JSON.stringify(defaultMeetingFormat) : 'null' ?>;
          var defaultMeetingNotes = <?= defaultMeetingNotes ? JSON.stringify(defaultMeetingNotes) : '""' ?>;
          var defaultYoneticiNot = <?= defaultYoneticiNot ? JSON.stringify(defaultYoneticiNot) : '""' ?>;
          var defaultYeniTakipTarihi = <?= defaultYeniTakipTarihi ? JSON.stringify(defaultYeniTakipTarihi) : '""' ?>;
          var rowNumber = <?= (rowNumber && typeof rowNumber === 'number') ? rowNumber : (rowNumber ? parseInt(rowNumber, 10) || 0 : 0) ?>;
          var sourceSheetName = <?= JSON.stringify(sourceSheetName || '') ?>;
        </script>
      </div>
      
      <div class="form-group">
        <label for="meetingNotes">ğŸ“ Yorum</label>
        <textarea id="meetingNotes" name="meetingNotes" placeholder="ToplantÄ± ile ilgili yorumlarÄ±nÄ±zÄ± buraya yazÄ±n..." rows="4"></textarea>
      </div>
      
      <div class="form-group">
        <label for="yoneticiNot">ğŸ‘” YÃ¶netici Not</label>
        <textarea id="yoneticiNot" name="yoneticiNot" placeholder="YÃ¶netici notlarÄ±nÄ±zÄ± buraya yazabilirsiniz..." rows="3"></textarea>
      </div>
      
      <div class="form-group">
        <label for="meetingResult">âœ… ToplantÄ± Sonucu</label>
        <select id="meetingResult" name="meetingResult">
          <option value="">SonuÃ§ seÃ§in</option>
        </select>
      </div>
      
      <!-- CÄ°RO ALANI (sadece "SatÄ±ÅŸ YapÄ±ldÄ±" seÃ§ildiÄŸinde) -->
      <div class="form-group" id="ciroGroup" style="display: none;">
        <label for="ciro">ğŸ’° Ciro (â‚º) <span class="required">*</span></label>
        <input type="number" id="ciro" name="ciro" step="0.01" min="0" placeholder="Ã–rn: 5000 veya 5000.50" required>
        <small style="color: #666; font-size: 12px; display: block; margin-top: 4px;">SatÄ±ÅŸa dÃ¶nÃ¼ÅŸtÃ¼rmek iÃ§in ciro miktarÄ±nÄ± girin</small>
      </div>
      
      <!-- Ä°STEÄE BAÄLI ALANLAR (sadece "ToplantÄ± GerÃ§ekleÅŸti" durumunda) -->
      <div class="form-row" id="extraFieldsGroup" style="display: none;">
        <div class="form-group">
          <label for="teklifDetayi">ğŸ“¦ Teklif DetayÄ± <span class="optional">(Ä°steÄŸe BaÄŸlÄ±)</span></label>
          <select id="teklifDetayi" name="teklifDetayi">
            <option value="">SeÃ§iniz...</option>
          </select>
        </div>
      </div>
      
      <div class="form-row" id="extraFieldsGroup2" style="display: none;">
        <div class="form-group">
          <label for="satisPotansiyeli">ğŸ”¥ SatÄ±ÅŸ Potansiyeli <span class="optional">(Ä°steÄŸe BaÄŸlÄ±)</span></label>
          <select id="satisPotansiyeli" name="satisPotansiyeli">
            <option value="">SeÃ§iniz...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="yeniTakipTarihi">ğŸ“† Yeni Takip Tarihi <span class="optional">(Ä°steÄŸe BaÄŸlÄ±)</span></label>
          <input type="date" id="yeniTakipTarihi" name="yeniTakipTarihi">
        </div>
      </div>
      
      <div class="buttons">
        <button type="button" class="btn btn-secondary" onclick="closeDialog()">âŒ Ä°ptal</button>
        <button type="submit" class="btn btn-primary">ğŸ’¾ Kaydet ve ToplantÄ±ya GeÃ§</button>
      </div>
    </form>
  </div>
  
  <script>
    // Sayfa yÃ¼klendiÄŸinde
    window.onload = function() {
      // HÄ±zlÄ± kayÄ±t iÃ§in gereksiz loglar kaldÄ±rÄ±ldÄ±
      
      // Ã–NCE tarihi direkt set et (input zaten var) - escape karakterlerini temizle
      if (typeof defaultMeetingDate !== 'undefined' && defaultMeetingDate && defaultMeetingDate !== '' && defaultMeetingDate !== 'null' && defaultMeetingDate !== null) {
        const meetingDateInput = document.getElementById('meetingDate');
        if (meetingDateInput) {
          let tarihDegeri = String(defaultMeetingDate)
            .replace(/^"/, '').replace(/"$/, '') // BaÅŸÄ±ndaki ve sonundaki Ã§ift tÄ±rnaklarÄ± kaldÄ±r
            .replace(/\\"/g, '"') // Escape edilmiÅŸ tÄ±rnaklarÄ± dÃ¼zelt
            .trim();
          meetingDateInput.value = tarihDegeri;
          console.log('âœ… Tarih direkt set edildi (onload, temizlenmiÅŸ):', tarihDegeri);
        }
      }
      
      // Ã–NCE saati de direkt set et (dropdown'lar doldurulmadan Ã¶nce)
      const hourSelectOnLoad = document.getElementById('meetingHour');
      const minuteSelectOnLoad = document.getElementById('meetingMinute');
      if (hourSelectOnLoad && typeof defaultMeetingHour !== 'undefined' && defaultMeetingHour && defaultMeetingHour !== 'null' && defaultMeetingHour !== null) {
        let hourValue = String(defaultMeetingHour)
          .replace(/^"/, '').replace(/"$/, '')
          .replace(/\\"/g, '"')
          .trim();
        const hourNum = parseInt(hourValue) || 9;
        let finalHour = hourNum < 9 ? '09' : (hourNum > 21 ? '21' : hourNum.toString().padStart(2, '0'));
        hourSelectOnLoad.value = finalHour;
        console.log('âœ… Saat (Hour) direkt set edildi (onload):', finalHour);
      }
      if (minuteSelectOnLoad && typeof defaultMeetingMinute !== 'undefined' && defaultMeetingMinute && defaultMeetingMinute !== 'null' && defaultMeetingMinute !== null) {
        let minuteValue = String(defaultMeetingMinute)
          .replace(/^"/, '').replace(/"$/, '')
          .replace(/\\"/g, '"')
          .trim();
        const minute = parseInt(minuteValue) || 0;
        let roundedMinute = minute <= 7 ? '00' : (minute <= 22 ? '15' : (minute <= 37 ? '30' : (minute <= 52 ? '45' : '00')));
        minuteSelectOnLoad.value = roundedMinute;
        console.log('âœ… Dakika (Minute) direkt set edildi (onload):', roundedMinute);
      }
      
      // Ã–NCE Yeni Takip Tarihi'ni de direkt set et
      if (typeof defaultYeniTakipTarihi !== 'undefined' && defaultYeniTakipTarihi && defaultYeniTakipTarihi !== 'null' && defaultYeniTakipTarihi !== null) {
        const yeniTakipTarihiInput = document.getElementById('yeniTakipTarihi');
        if (yeniTakipTarihiInput) {
          let yeniTakipTarihiDegeri = String(defaultYeniTakipTarihi)
            .replace(/^"/, '').replace(/"$/, '') // BaÅŸÄ±ndaki ve sonundaki Ã§ift tÄ±rnaklarÄ± kaldÄ±r
            .replace(/\\"/g, '"') // Escape edilmiÅŸ tÄ±rnaklarÄ± dÃ¼zelt
            .trim();
          yeniTakipTarihiInput.value = yeniTakipTarihiDegeri;
          console.log('âœ… Yeni Takip Tarihi direkt set edildi (onload):', yeniTakipTarihiDegeri);
        }
      }
      
      fillTimeDropdowns();
      fillDropdowns();
      
      // ToplantÄ± Sonucu deÄŸiÅŸtiÄŸinde ciro input'unu gÃ¶ster/gizle
      const meetingResultSelect = document.getElementById('meetingResult');
      if (meetingResultSelect) {
        meetingResultSelect.addEventListener('change', function() {
          const ciroGroup = document.getElementById('ciroGroup');
          const ciroInput = document.getElementById('ciro');
          const selectedValue = this.value.toLowerCase();
          
          if (selectedValue.includes('satÄ±ÅŸ') || selectedValue === 'satÄ±ÅŸ yapÄ±ldÄ±') {
            // "SatÄ±ÅŸ YapÄ±ldÄ±" seÃ§ildiÄŸinde ciro input'unu gÃ¶ster
            if (ciroGroup) ciroGroup.style.display = 'block';
            if (ciroInput) ciroInput.setAttribute('required', 'required');
          } else {
            // DiÄŸer durumlarda gizle
            if (ciroGroup) ciroGroup.style.display = 'none';
            if (ciroInput) {
              ciroInput.removeAttribute('required');
              ciroInput.value = '';
            }
          }
        });
      }
      
      // VarsayÄ±lan deÄŸerleri dropdown'lar doldurulduktan sonra set et - HIZ iÃ§in minimum gecikme
      setTimeout(function() {
        fillDefaultValues();
        toggleConditionalFields();
      }, 100); // HÄ±zlÄ± kayÄ±t iÃ§in minimum gecikme
    };
    
    // Saat ve dakika dropdown'larÄ±nÄ± doldur
    function fillTimeDropdowns() {
      // Saat dropdown'u (09-21) - iÅŸ saatleri iÃ§in
      const hourSelect = document.getElementById('meetingHour');
      if (hourSelect) {
        for (let h = 9; h <= 21; h++) {
          const hour = h.toString().padStart(2, '0');
          const option = document.createElement('option');
          option.value = hour;
          option.textContent = hour;
          hourSelect.appendChild(option);
        }
      }
      
      // Dakika dropdown'u (00, 15, 30, 45) - hÄ±zlÄ± seÃ§im iÃ§in
      const minuteSelect = document.getElementById('meetingMinute');
      if (minuteSelect) {
        const minutes = ['00', '15', '30', '45'];
        minutes.forEach(min => {
          const option = document.createElement('option');
          option.value = min;
          option.textContent = min;
          minuteSelect.appendChild(option);
        });
      }
      
      // Saat deÄŸiÅŸtiÄŸinde hidden input'u gÃ¼ncelle
      if (hourSelect && minuteSelect) {
        const updateTimeInput = () => {
          const hour = hourSelect.value;
          const minute = minuteSelect.value;
          if (hour && minute) {
            document.getElementById('meetingTime').value = `${hour}:${minute}`;
          }
        };
        hourSelect.addEventListener('change', updateTimeInput);
        minuteSelect.addEventListener('change', updateTimeInput);
      }
    }
    
    // Conditional fields gÃ¶ster/gizle
    function toggleConditionalFields() {
      if (typeof isToplantiGerceklesti !== 'undefined' && isToplantiGerceklesti) {
        // "ToplantÄ± GerÃ§ekleÅŸti" durumunda ekstra alanlarÄ± gÃ¶ster
        const toplantiYapanGroup = document.getElementById('toplantiYapanGroup');
        const extraFieldsGroup = document.getElementById('extraFieldsGroup');
        const extraFieldsGroup2 = document.getElementById('extraFieldsGroup2');
        
        if (toplantiYapanGroup) {
          toplantiYapanGroup.style.display = 'block';
          // Zorunlu yap
          const toplantiYapanSelect = document.getElementById('toplantiYapan');
          if (toplantiYapanSelect) {
            toplantiYapanSelect.setAttribute('required', 'required');
          }
        }
        if (extraFieldsGroup) extraFieldsGroup.style.display = 'flex';
        if (extraFieldsGroup2) extraFieldsGroup2.style.display = 'flex';
      } else {
        // Normal durumda gizle
        const toplantiYapanGroup = document.getElementById('toplantiYapanGroup');
        const extraFieldsGroup = document.getElementById('extraFieldsGroup');
        const extraFieldsGroup2 = document.getElementById('extraFieldsGroup2');
        
        if (toplantiYapanGroup) {
          toplantiYapanGroup.style.display = 'none';
          // ZorunluluÄŸu kaldÄ±r
          const toplantiYapanSelect = document.getElementById('toplantiYapan');
          if (toplantiYapanSelect) {
            toplantiYapanSelect.removeAttribute('required');
          }
        }
        if (extraFieldsGroup) extraFieldsGroup.style.display = 'none';
        if (extraFieldsGroup2) extraFieldsGroup2.style.display = 'none';
      }
    }
    
    // Dropdown'larÄ± JavaScript deÄŸiÅŸkenlerinden doldur
    function fillDropdowns() {
      // Meeting Formats
      if (typeof meetingFormatsHTML !== 'undefined' && meetingFormatsHTML) {
        const meetingFormatSelect = document.getElementById('meetingFormat');
        if (meetingFormatSelect) {
          // HTML string'i direkt ekle (zaten escape edilmiÅŸ)
          meetingFormatSelect.innerHTML = meetingFormatSelect.innerHTML + meetingFormatsHTML;
        }
      }
      
      // ToplantÄ±yÄ± Yapan (sadece "ToplantÄ± GerÃ§ekleÅŸti" durumunda)
      if (typeof toplantiYapanHTML !== 'undefined' && toplantiYapanHTML) {
        const toplantiYapanSelect = document.getElementById('toplantiYapan');
        if (toplantiYapanSelect) {
          toplantiYapanSelect.innerHTML += toplantiYapanHTML;
        }
      }
      
      // ToplantÄ± Sonucu
      if (typeof toplantiSonucuHTML !== 'undefined' && toplantiSonucuHTML) {
        const meetingResultSelect = document.getElementById('meetingResult');
        if (meetingResultSelect) {
          meetingResultSelect.innerHTML += toplantiSonucuHTML;
        }
      }
      
      // Teklif DetayÄ± (sadece "ToplantÄ± GerÃ§ekleÅŸti" durumunda) - normal select
      if (typeof teklifDetayiHTML !== 'undefined' && teklifDetayiHTML) {
        const teklifDetayiSelect = document.getElementById('teklifDetayi');
        if (teklifDetayiSelect) {
          teklifDetayiSelect.innerHTML += teklifDetayiHTML;
        }
      }
      
      // SatÄ±ÅŸ Potansiyeli (sadece "ToplantÄ± GerÃ§ekleÅŸti" durumunda)
      if (typeof satisPotansiyeliHTML !== 'undefined' && satisPotansiyeliHTML) {
        const satisPotansiyeliSelect = document.getElementById('satisPotansiyeli');
        if (satisPotansiyeliSelect) {
          satisPotansiyeliSelect.innerHTML += satisPotansiyeliHTML;
        }
      }
    }
    
    // VarsayÄ±lan deÄŸerleri doldur - HIZ iÃ§in gereksiz loglar kaldÄ±rÄ±ldÄ±
    function fillDefaultValues() {
      
      // ToplantÄ± Tarihi: Randevu Tarihi veya bugÃ¼n - Ã–NCE SET ET
      const meetingDateInput = document.getElementById('meetingDate');
      if (meetingDateInput) {
        // Ã–nce defaultMeetingDate'i kontrol et - escape karakterlerini temizle
        let tarihDegeri = '';
        if (typeof defaultMeetingDate !== 'undefined' && defaultMeetingDate && defaultMeetingDate !== '' && defaultMeetingDate !== 'null' && defaultMeetingDate !== null) {
          tarihDegeri = String(defaultMeetingDate)
            .replace(/^"/, '').replace(/"$/, '') // BaÅŸÄ±ndaki ve sonundaki Ã§ift tÄ±rnaklarÄ± kaldÄ±r
            .replace(/\\"/g, '"') // Escape edilmiÅŸ tÄ±rnaklarÄ± dÃ¼zelt
            .trim();
          console.log('ğŸ” defaultMeetingDate bulundu (temizlenmiÅŸ):', tarihDegeri);
        }
        
        // EÄŸer hala boÅŸsa, bugÃ¼nÃ¼n tarihini kullan
        if (!tarihDegeri || tarihDegeri === '') {
          const today = new Date();
          const year = today.getFullYear();
          const month = (today.getMonth() + 1).toString().padStart(2, '0');
          const day = today.getDate().toString().padStart(2, '0');
          tarihDegeri = `${year}-${month}-${day}`;
          console.log('ğŸ” defaultMeetingDate boÅŸtu, bugÃ¼nÃ¼n tarihi kullanÄ±ldÄ±:', tarihDegeri);
        }
        
        // Input'a set et - HIZ iÃ§in retry'lar kaldÄ±rÄ±ldÄ± (zaten onload'da set ediliyor)
        if (tarihDegeri) {
          meetingDateInput.value = tarihDegeri;
        }
      } else {
        console.error('âŒ meetingDate input bulunamadÄ±!');
      }
      
      // ToplantÄ± FormatÄ±: Randevu'daki format - dropdown doldurulduktan SONRA set et
      const meetingFormatSelect = document.getElementById('meetingFormat');
      if (meetingFormatSelect) {
        console.log('ğŸ” Format dropdown bulundu, options:', meetingFormatSelect.options.length);
        console.log('ğŸ” defaultMeetingFormat:', typeof defaultMeetingFormat !== 'undefined' ? defaultMeetingFormat : 'UNDEFINED');
        
        // Dropdown'un doldurulduÄŸundan emin ol (en az 1 option olmalÄ± - "Format seÃ§in" + formatlar)
        if (meetingFormatSelect.options.length > 1) {
          if (typeof defaultMeetingFormat !== 'undefined' && defaultMeetingFormat && defaultMeetingFormat !== '' && defaultMeetingFormat !== null && defaultMeetingFormat !== 'null') {
            // Escape karakterlerini temizle ve normalize et
            const cleanHtmlEntity = (val) => val ? val
              .replace(/&quot;/g, '"').replace(/&#39;/g, "'")
              .replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>')
              .replace(/^"/, '').replace(/"$/, '') // BaÅŸÄ±ndaki ve sonundaki Ã§ift tÄ±rnaklarÄ± kaldÄ±r
              .replace(/\\"/g, '"') // Escape edilmiÅŸ tÄ±rnaklarÄ± dÃ¼zelt
              .trim() : '';
            
            let formatValue = cleanHtmlEntity(String(defaultMeetingFormat));
            console.log('ğŸ” Format deÄŸeri temizlendi:', formatValue);
            
            // TÃ¼m option'larÄ± ve deÄŸerlerini logla
            const allOptions = Array.from(meetingFormatSelect.options);
            console.log('ğŸ” ALL OPTIONS (value, text):', allOptions.map(opt => ({ 
              value: opt.value, 
              valueClean: cleanHtmlEntity(opt.value),
              text: opt.text, 
              textClean: cleanHtmlEntity(opt.text)
            })));
            
            // Dropdown'da bu deÄŸer var mÄ± kontrol et - hem value hem text hem de temizlenmiÅŸ hallerini kontrol et
            let optionExists = allOptions.some(opt => {
              const optValueClean = cleanHtmlEntity(opt.value);
              const optTextClean = cleanHtmlEntity(opt.text);
              return opt.value === formatValue || opt.text === formatValue || 
                     optValueClean === formatValue || optTextClean === formatValue ||
                     optValueClean.toLowerCase() === formatValue.toLowerCase() ||
                     optTextClean.toLowerCase() === formatValue.toLowerCase();
            });
            console.log('ğŸ” Format option exists (exact)?', optionExists, 'Looking for:', formatValue);
            console.log('ğŸ” Available option values (raw):', allOptions.map(opt => opt.value));
            console.log('ğŸ” Available option values (clean):', allOptions.map(opt => cleanHtmlEntity(opt.value)));
            
            if (optionExists) {
              // Bulunan option'Ä± set et
              const matchedOption = allOptions.find(opt => {
                const optValueClean = cleanHtmlEntity(opt.value);
                const optTextClean = cleanHtmlEntity(opt.text);
                return opt.value === formatValue || opt.text === formatValue || 
                       optValueClean === formatValue || optTextClean === formatValue ||
                       optValueClean.toLowerCase() === formatValue.toLowerCase() ||
                       optTextClean.toLowerCase() === formatValue.toLowerCase();
              });
              
              if (matchedOption) {
                meetingFormatSelect.value = matchedOption.value;
                console.log('âœ… Default meeting format set (exact match):', formatValue, 'â†’', matchedOption.value, 'Current value:', meetingFormatSelect.value);
              } else {
                meetingFormatSelect.value = formatValue;
                console.log('âœ… Default meeting format set (direct):', formatValue, 'Current value:', meetingFormatSelect.value);
              }
            } else {
              // EÄŸer tam eÅŸleÅŸme yoksa, benzer bir deÄŸer ara (bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf duyarsÄ±z)
              const similarOption = allOptions.find(opt => {
                const optValueClean = cleanHtmlEntity(opt.value);
                const optTextClean = cleanHtmlEntity(opt.text);
                return optValueClean.toLowerCase() === formatValue.toLowerCase() ||
                       optTextClean.toLowerCase() === formatValue.toLowerCase();
              });
              
              if (similarOption) {
                meetingFormatSelect.value = similarOption.value;
                console.log('âœ… Benzer format bulundu ve set edildi:', formatValue, 'â†’', similarOption.value);
              } else {
                // Son Ã§are: Ä°lk geÃ§erli option'Ä± seÃ§ (boÅŸ olmayan)
                const firstValidOption = allOptions.find(opt => opt.value && opt.value !== '');
                if (firstValidOption) {
                  meetingFormatSelect.value = firstValidOption.value;
                  console.log('âš ï¸ VarsayÄ±lan format bulunamadÄ±, ilk geÃ§erli option seÃ§ildi:', formatValue, 'â†’', firstValidOption.value);
                } else {
                  console.log('âš ï¸ Default format not found in dropdown (exact or similar):', formatValue);
                }
              }
            }
          } else {
            console.log('âš ï¸ defaultMeetingFormat boÅŸ veya undefined:', defaultMeetingFormat);
          }
        }
      } else {
        console.error('âŒ meetingFormat select bulunamadÄ±!');
      }
      
      // ToplantÄ± Saati: Randevu'daki saat - saat ve dakika dropdown'larÄ±na ayÄ±r
      const hourSelect = document.getElementById('meetingHour');
      const minuteSelect = document.getElementById('meetingMinute');
      
      if (hourSelect && typeof defaultMeetingHour !== 'undefined' && defaultMeetingHour && defaultMeetingHour !== 'null' && defaultMeetingHour !== null) {
        // Escape karakterlerini temizle
        let hourValue = String(defaultMeetingHour)
          .replace(/^"/, '').replace(/"$/, '') // BaÅŸÄ±ndaki ve sonundaki Ã§ift tÄ±rnaklarÄ± kaldÄ±r
          .replace(/\\"/g, '"') // Escape edilmiÅŸ tÄ±rnaklarÄ± dÃ¼zelt
          .trim();
        
        const hourNum = parseInt(hourValue) || 9;
        // Saati 09-21 aralÄ±ÄŸÄ±na sÄ±nÄ±rla
        let finalHour = '09';
        if (hourNum < 9) {
          finalHour = '09';
        } else if (hourNum > 21) {
          finalHour = '21';
        } else {
          finalHour = hourNum.toString().padStart(2, '0');
        }
        
        hourSelect.value = finalHour;
        console.log('âœ… ToplantÄ± Saati (Hour) set edildi:', finalHour, 'Input value:', hourSelect.value);
      }
      
      if (minuteSelect && typeof defaultMeetingMinute !== 'undefined' && defaultMeetingMinute && defaultMeetingMinute !== 'null' && defaultMeetingMinute !== null) {
        // Escape karakterlerini temizle
        let minuteValue = String(defaultMeetingMinute)
          .replace(/^"/, '').replace(/"$/, '') // BaÅŸÄ±ndaki ve sonundaki Ã§ift tÄ±rnaklarÄ± kaldÄ±r
          .replace(/\\"/g, '"') // Escape edilmiÅŸ tÄ±rnaklarÄ± dÃ¼zelt
          .trim();
        
        // Dakika deÄŸerini en yakÄ±n 15 dakikalÄ±k aralÄ±ÄŸa yuvarla
        const minute = parseInt(minuteValue) || 0;
        let roundedMinute = '00';
        if (minute > 0 && minute <= 7) {
          roundedMinute = '00';
        } else if (minute > 7 && minute <= 22) {
          roundedMinute = '15';
        } else if (minute > 22 && minute <= 37) {
          roundedMinute = '30';
        } else if (minute > 37 && minute <= 52) {
          roundedMinute = '45';
        } else {
          roundedMinute = '00';
        }
        document.getElementById('meetingMinute').value = roundedMinute;
      }
      
      // Hidden time input'u gÃ¼ncelle
      const hour = document.getElementById('meetingHour').value;
      const minute = document.getElementById('meetingMinute').value;
      if (hour && minute) {
        document.getElementById('meetingTime').value = `${hour}:${minute}`;
      }
      
      // ToplantÄ± NotlarÄ±: Randevu'daki Yorum
      if (typeof defaultMeetingNotes !== 'undefined' && defaultMeetingNotes) {
        document.getElementById('meetingNotes').value = defaultMeetingNotes;
      }
      
      // YÃ¶netici Not: Randevu'daki YÃ¶netici Not
      if (typeof defaultYoneticiNot !== 'undefined' && defaultYoneticiNot && defaultYoneticiNot !== 'null' && defaultYoneticiNot !== '' && defaultYoneticiNot !== null) {
        const yoneticiNotValue = String(defaultYoneticiNot).replace(/^"/, '').replace(/"$/, '').replace(/\\"/g, '"');
        if (yoneticiNotValue && yoneticiNotValue !== 'null') {
          document.getElementById('yoneticiNot').value = yoneticiNotValue;
        }
      }
      
      // Yeni Takip Tarihi: ToplantÄ± tarihinden 3 gÃ¼n sonra (eÄŸer set edilmemiÅŸse)
      const yeniTakipTarihiInput = document.getElementById('yeniTakipTarihi');
      if (yeniTakipTarihiInput && (!yeniTakipTarihiInput.value || yeniTakipTarihiInput.value === '')) {
        if (typeof defaultYeniTakipTarihi !== 'undefined' && defaultYeniTakipTarihi && defaultYeniTakipTarihi !== 'null' && defaultYeniTakipTarihi !== null) {
          let yeniTakipTarihiDegeri = String(defaultYeniTakipTarihi)
            .replace(/^"/, '').replace(/"$/, '') // BaÅŸÄ±ndaki ve sonundaki Ã§ift tÄ±rnaklarÄ± kaldÄ±r
            .replace(/\\"/g, '"') // Escape edilmiÅŸ tÄ±rnaklarÄ± dÃ¼zelt
            .trim();
          yeniTakipTarihiInput.value = yeniTakipTarihiDegeri;
          console.log('âœ… Yeni Takip Tarihi set edildi (fillDefaultValues):', yeniTakipTarihiDegeri);
        }
      }
    }
    
    // Randevu bilgilerini gÃ¶ster - ArtÄ±k server-side'dan direkt gÃ¶steriliyor
    function fillAppointmentInfo() {
      // Bu fonksiyon artÄ±k gerekli deÄŸil, bilgiler server-side'dan direkt gÃ¶steriliyor
      // Ama hala dropdown'lar ve varsayÄ±lan deÄŸerler iÃ§in kullanÄ±labilir
    }
    
    function closeDialog() {
      if (typeof google !== 'undefined' && google.script) {
        google.script.host.close();
      }
    }
    
    // Form gÃ¶nderimi - Ã‡oklu submit'i Ã¶nle
    let isSubmitting = false;
    document.getElementById('meetingForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Ã‡oklu submit kontrolÃ¼
      if (isSubmitting) {
        console.log('âš ï¸ Form zaten gÃ¶nderiliyor, tekrar gÃ¶nderim engellendi');
        return;
      }
      
      // "ToplantÄ± GerÃ§ekleÅŸti" durumunda ToplantÄ±yÄ± Yapan zorunlu kontrolÃ¼
      if (typeof isToplantiGerceklesti !== 'undefined' && isToplantiGerceklesti) {
        const toplantiYapan = document.getElementById('toplantiYapan').value;
        if (!toplantiYapan) {
          alert('âš ï¸ LÃ¼tfen "ToplantÄ±yÄ± Yapan" kiÅŸiyi seÃ§in!');
          return;
        }
      }
      
      // Submit flag'ini set et
      isSubmitting = true;
      const submitButton = document.querySelector('button[type="submit"]');
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'â³ Kaydediliyor...';
      }
      
      // Form verilerini topla (unified format)
      const formData = {
        // Support both old and new field names
        toplantiTarihi: document.getElementById('meetingDate').value,
        meetingDate: document.getElementById('meetingDate').value, // Backward compatibility
        toplantiSaati: document.getElementById('meetingTime').value || (document.getElementById('meetingHour').value + ':' + document.getElementById('meetingMinute').value),
        meetingTime: document.getElementById('meetingTime').value || (document.getElementById('meetingHour').value + ':' + document.getElementById('meetingMinute').value), // Backward compatibility
        toplantiFormat: document.getElementById('meetingFormat').value,
        meetingFormat: document.getElementById('meetingFormat').value, // Backward compatibility
        yorum: document.getElementById('meetingNotes').value,
        meetingNotes: document.getElementById('meetingNotes').value, // Backward compatibility
        yoneticiNot: document.getElementById('yoneticiNot').value,
        toplantiSonucu: document.getElementById('meetingResult').value,
        meetingResult: document.getElementById('meetingResult').value, // Backward compatibility
        ciro: document.getElementById('ciro').value || 0, // Ciro (SatÄ±ÅŸ YapÄ±ldÄ± iÃ§in)
        satisCiro: document.getElementById('ciro').value || 0 // Backward compatibility
      };
      
      // "ToplantÄ± GerÃ§ekleÅŸti" durumunda ekstra alanlar
      if (typeof isToplantiGerceklesti !== 'undefined' && isToplantiGerceklesti) {
        formData.toplantiYapan = document.getElementById('toplantiYapan').value;
        
        // Teklif DetayÄ± - normal select
        formData.teklifDetayi = document.getElementById('teklifDetayi').value;
        
        formData.satisPotansiyeli = document.getElementById('satisPotansiyeli').value;
        formData.yeniTakipTarihi = document.getElementById('yeniTakipTarihi').value;
      }
      
      // Google Apps Script'e veriyi gÃ¶nder
      if (typeof google !== 'undefined' && google.script) {
        google.script.run
          .withSuccessHandler(function(result) {
            isSubmitting = false; // Reset flag
            if (result.success) {
              // Dialog'u kapat (Ã‡alÄ±ÅŸÄ±yor mesajÄ± sorununu Ã¶nlemek iÃ§in daha uzun setTimeout)
              // Google Sheets'in loading indicator'Ä±nÄ±n kaybolmasÄ± iÃ§in yeterli sÃ¼re ver
              // Script'in tamamlanmasÄ± iÃ§in 1 saniye bekle
              setTimeout(function() {
                try {
                  google.script.host.close();
                } catch (e) {
                  // Dialog zaten kapalÄ±ysa hata verme
                }
              }, 1000);
            } else {
              if (submitButton) {
                submitButton.disabled = false;
                submitButton.textContent = 'ğŸ’¾ Kaydet ve ToplantÄ±ya GeÃ§';
              }
              alert('âŒ Hata: ' + (result.message || 'Bilinmeyen hata'));
            }
          })
          .withFailureHandler(function(error) {
            isSubmitting = false; // Reset flag
            if (submitButton) {
              submitButton.disabled = false;
              submitButton.textContent = 'ğŸ’¾ Kaydet ve ToplantÄ±ya GeÃ§';
            }
            alert('âŒ Hata: ' + error.message);
          })
          .processMeetingForm(formData, rowNumber, sourceSheetName);
      } else {
        // Reset flag if google.script is not available
        isSubmitting = false;
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = 'ğŸ’¾ Kaydet ve ToplantÄ±ya GeÃ§';
        }
      }
    });
  </script>
</body>
</html>
