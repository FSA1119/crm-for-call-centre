// ========================================
// GOOGLE SHEETS CRM SYSTEM - BACKEND
// ========================================
// Version: 1.0
// Author: CRM Development Team
// Date: 2025-07-08

console.log('ðŸ”§ DEBUG: backend.js dosyasÄ± yÃ¼klendi - Test mesajÄ±!');

// ========================================
// GLOBAL CONSTANTS & VARIABLES
// ========================================

// Global variable to store selected row data for HTML dialogs
let SELECTED_ROW_DATA = null;
// let SELECTED_ROW_NUMBER = null;

const CRM_CONFIG = {
  // Employee codes
  EMPLOYEE_CODES: {
    'LG 001': 'Lale GÃ¼l',
    'NT 002': 'Neslihan TÃ¼rk', 
    'KO 003': 'Kadir Ã–ztÃ¼rk',
    'SB 004': 'Sinem BakalcÄ±',
    'KM 005': 'KÃ¼bra Murat',
    'GÅž 006': 'Gamze ÅžafaklÄ±oÄŸlu',
    'BH 007': 'Bilge Hin',
    'TD 008': 'TuÄŸÃ§e Duman'
  },
  
  // Manager file
  MANAGER_FILE: 'FSA_019 - Yonetici Takip Dosyasi',
  MANAGER_FILE_ID: '11IsZpaGgXtgpxrie9F_uVwp6uJPcueGhqB73WhZn60A',
  
  // ðŸŽ¨ Centralized Color System - Visual Harmony (SYNCED WITH RENK_KODLARI.md)
  COLOR_CODES: {
    // Primary Status Colors - GÃ¶rseldeki Renkler
    'Randevu AlÄ±ndÄ±': 'rgb(232, 245, 232)',      // #E8F5E8 - Light Green
    'Ä°leri Tarih Randevu': 'rgb(245, 245, 245)', // #F5F5F5 - Light Gray
    'Randevu Teyitlendi': 'rgb(232, 245, 232)',  // #E8F5E8 - Light Green
    'Randevu Ertelendi': 'rgb(255, 243, 224)',   // #FFF3E0 - Soft Orange
    'Randevu Ä°ptal oldu': 'rgb(255, 235, 238)',  // #FFEBEE - Light Red (AÃ§Ä±k KÄ±rmÄ±zÄ±)
    
    // Opportunity Colors - GÃ¶rseldeki Renkler
    'FÄ±rsat Ä°letildi': 'rgb(255, 235, 238)',     // #FFEBEE - Light Red
    'Bilgi Verildi': 'rgb(243, 229, 245)',       // #F3E5F5 - Light Purple
    'Yeniden Aranacak': 'rgb(227, 242, 253)',    // #E3F2FD - Light Blue
    
    // Negative Status Colors - GÃ¶rseldeki Renkler
    'Ä°lgilenmiyor': 'rgb(255, 248, 225)',        // #FFF8E1 - Light Yellow
    'UlaÅŸÄ±lamadÄ±': 'rgb(255, 235, 238)',         // #FFEBEE - Light Red (Yeniden arama iÃ§in farklÄ±)
    'GeÃ§ersiz Numara': 'rgb(158, 158, 158)',     // #9E9E9E - Dark Gray
    
    // Meeting Colors
    'ToplantÄ± TamamlandÄ±': 'rgb(200, 230, 201)',  // Light Green
    'ToplantÄ± Teklif': 'rgb(165, 214, 167)',      // Darker Green
    'ToplantÄ± Beklemede': 'rgb(255, 243, 224)',   // Soft Orange
    'ToplantÄ± Ä°ptal': 'rgb(255, 235, 238)',       // Light Red
    'SatÄ±ÅŸ YapÄ±ldÄ±': 'rgb(187, 222, 251)',        // Light Blue
    'Potansiyel SÄ±cak': 'rgb(255, 224, 178)',     // Light Orange
    'Potansiyel Orta': 'rgb(225, 245, 254)',      // Light Blue
    'Potansiyel SoÄŸuk': 'rgb(236, 239, 241)'      // Light Gray
  },
  
  // Activity options (all)
  ACTIVITY_OPTIONS: [
    'Randevu AlÄ±ndÄ±',
    'Ä°leri Tarih Randevu',
    'Yeniden Aranacak',
    'Bilgi Verildi',
    'FÄ±rsat Ä°letildi',
    'Ä°lgilenmiyor',
    'UlaÅŸÄ±lamadÄ±',
    'GeÃ§ersiz Numara'
  ],
  
  // Appointment activity options (only for appointment dialog)
  APPOINTMENT_ACTIVITY_OPTIONS: [
    'Randevu AlÄ±ndÄ±',
    'Ä°leri Tarih Randevu'
  ],
  
  // Meeting format options
  MEETING_FORMAT_OPTIONS: [
    'YÃ¼z YÃ¼ze',
    'Online', 
    'Telefon'
  ],
  
  // Batch processing
  BATCH_SIZE: 50,
  TIMEOUT_SECONDS: 5
};

// ========================================
// ðŸ”§ UTILITY FUNCTIONS - FOUNDATION LAYER
// ========================================

/**
 * ðŸ“… Date Validation - Temporal Integrity
 * @param {*} date - Date to validate
 * @returns {boolean} - Validation result
 */
function isValidDate(date) {
  if (!date || date === '' || date === null || date === undefined || date === '30.12.1899') return false;
  
  if (date === 'Invalid Date' || date === 'NaN') return false;
  
  try {
    // Handle Date objects directly
    if (date instanceof Date) {
      if (isNaN(date.getTime())) return false;
      const year = date.getFullYear();
      if (year < 1900 || year > 2100) return false;
      return true;
    }
    
    const testDate = new Date(date);
    
    if (isNaN(testDate.getTime())) return false;
    
    const year = testDate.getFullYear();
    if (year < 1900 || year > 2100) return false;
    
    return true;
  } catch (error) {
    console.log('ðŸ“… Date validation error:', error, 'for date:', date);
    return false;
  }
}

/**
 * ðŸ• Time Value Formatting - Temporal Display
 * @param {*} value - Time value to format
 * @returns {string} - Formatted time
 */
function formatTimeValue(value) {
  try {
    if (!value || value === '' || value === null || value === undefined) return '';
    
    // Handle Date objects
    if (value instanceof Date) {
      const hours = value.getHours().toString().padStart(2, '0');
      const minutes = value.getMinutes().toString().padStart(2, '0');
      return `${hours}:${minutes}`;
    }
    
    // Handle string dates (like "30.12.1899")
    if (typeof value === 'string') {
      const date = new Date(value);
      if (!isNaN(date.getTime()) && date.getFullYear() !== 1899) {
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
      }
    }
    
    // Handle invalid dates
    if (value === '30.12.1899' || value === 'Invalid Date') {
      return '';
    }
    
    return value.toString();
    
  } catch (error) {
    console.log('ðŸ• Time formatting error:', error, 'for value:', value);
    return '';
  }
}

/**
 * ðŸ“… Date Value Formatting - Temporal Display
 * @param {*} value - Date value to format
 * @returns {string} - Formatted date
 */
function formatDateValue(value) {
  try {
    if (!value || value === '' || value === null || value === undefined) return '';
    
    // Handle Date objects
    if (value instanceof Date) {
      const day = value.getDate().toString().padStart(2, '0');
      const month = (value.getMonth() + 1).toString().padStart(2, '0');
      const year = value.getFullYear();
      return `${day}.${month}.${year}`;
    }
    
    // Handle string dates
    if (typeof value === 'string') {
      const date = new Date(value);
      if (!isNaN(date.getTime()) && date.getFullYear() !== 1899) {
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
      }
    }
    
    // Handle invalid dates
    if (value === '30.12.1899' || value === 'Invalid Date') {
      return '';
    }
    
    return value.toString();
    
  } catch (error) {
    console.log('ðŸ“… Date formatting error:', error, 'for value:', value);
    return '';
  }
}

/**
 * ðŸ›¡ï¸ Input Validation - Data Integrity Guardian
 * @param {Object} parameters - Input parameters to validate
 * @returns {boolean} - Validation result
 */
function validateInput(parameters) {
  if (!parameters || typeof parameters !== 'object') {
    console.error('Invalid parameters: must be an object');
    return false;
  }
  return true;
}

/**
 * ðŸ“ Universal Column Width Optimizer - Professional Layout
 * @param {Sheet} sheet - Target sheet
 * @param {string} sheetType - Type of sheet for specific optimizations
 */
function optimizeColumnWidths(sheet, sheetType = 'default') {
  console.log(`ðŸ“ Optimizing column widths for ${sheetType} sheet`);
  
  try {
    if (!sheet) {
      console.error('âŒ Invalid sheet for column width optimization');
      return;
    }
    
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    
    headers.forEach((header, index) => {
      const columnIndex = index + 1;
      const optimalWidth = getOptimalColumnWidth(header, sheetType);
      sheet.setColumnWidth(columnIndex, optimalWidth);
    });
    
    console.log(`âœ… Column widths optimized for ${sheetType} sheet`);
    
  } catch (error) {
    console.error(`âŒ Error optimizing column widths for ${sheetType}:`, error);
  }
}

/**
 * ðŸ“ Get Optimal Column Width - Smart Sizing
 * @param {string} header - Column header
 * @param {string} sheetType - Sheet type
 * @returns {number} - Optimal width in pixels
 */
function getOptimalColumnWidth(header, sheetType) {
  // Base widths for different column types
  const widthMap = {
    // Employee/Manager Codes
    'Kod': 120,
    'Temsilci Kodu': 120,
    
    // Company Information
    'Company name': 200,
    'Kaynak': 100,
    'Keyword': 150,
    'Location': 120,
    'Category': 120,
    'Website': 200,
    
    // Contact Information
    'Phone': 130,
    'Yetkili Tel': 130,
    'Mail': 180,
    'Ä°sim Soyisim': 150,
    
    // Status and Activity
    'Aktivite': 140,
    'Randevu durumu': 140,
    'FÄ±rsat Durumu': 140,
    'ToplantÄ± durumu': 140,
    'Durum': 140,
    
    // Dates and Times
    'Tarih': 100,
    'Randevu Tarihi': 120,
    'FÄ±rsat Tarihi': 120,
    'ToplantÄ± Tarihi': 120,
    'Aktivite Tarihi': 120,
    'Saat': 80,
    
    // Notes and Comments
    'Yorum': 250,
    'YÃ¶netici Not': 200,
    
    // Technical Information
    'CMS AdÄ±': 120,
    'CMS Grubu': 120,
    'E-Ticaret Ä°zi': 120,
    'Site HÄ±zÄ±': 100,
    'Site TrafiÄŸi': 120,
    'Log': 100,
    'ToplantÄ± formatÄ±': 120,
    
    // Address Information
    'Address': 300,
    'City': 100,
    
    // Analytics
    'Rating count': 100,
    'Review': 100,
    'ToplantÄ± Sonucu': 150,
    
    // Links
    'Maplink': 200
  };
  
  // Return optimal width or default
  return widthMap[header] || 100;
}

/**
 * Gets current employee code from sheet name
 * @returns {string} - Employee code
 */
function getCurrentEmployeeCode() {
  const sheet = SpreadsheetApp.getActiveSheet();
  const sheetName = sheet.getName();
  
  console.log('Current sheet name:', sheetName);
  
  // Extract employee code from sheet name (before tire)
  const match = sheetName.match(/([A-Z]{2}_\d{3})/);
  if (match) {
    console.log('Found employee code (underscore format):', match[1]);
    return match[1];
  }
  
  // Alternative: extract from sheet name before tire (keep space format)
  const beforeTire = sheetName.split(' - ')[0];
  console.log('Before tire:', beforeTire);
  
  if (beforeTire && beforeTire.match(/^[A-Z]{2}\s\d{3}$/)) {
    // Keep "KO 003" format (with space)
    console.log('Found employee code (space format):', beforeTire);
    return beforeTire;
  }
  
  console.warn('Employee code not found in sheet name:', sheetName);
  console.log('Returning default: LG_001');
  return 'LG_001'; // Default fallback
}

/**
 * Logs activity with timestamp
 * @param {string} action - Action performed
 * @param {Object} data - Related data
 */
function logActivity(action, data = {}) {
  const timestamp = new Date().toISOString();
  const employeeCode = getCurrentEmployeeCode();
  const logEntry = { timestamp, employee: employeeCode, action, data };
  console.log('Activity logged:', logEntry);
  return logEntry;
}

// ========================================
// FUNCTION 1: CREATE NEW TABLE
// ========================================

/**
 * Creates new Format Tablo from Ham veri
 * @param {Object} parameters - Function parameters
 * @returns {Object} - Result object
 */
function createNewTable(parameters) {
  try {
    if (!validateInput(parameters)) {
      throw new Error('Invalid input provided');
    }
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const hamVeriSheet = spreadsheet.getSheetByName('Ham veri');
    if (!hamVeriSheet) {
      throw new Error('Ham veri sayfasÄ± bulunamadÄ±');
    }
    const ui = SpreadsheetApp.getUi();
    const response = ui.prompt('Yeni Tablo OluÅŸtur', 'Yeni Format Tablo iÃ§in isim girin (Ã¶rn: t10):', ui.ButtonSet.OK_CANCEL);
    if (response.getSelectedButton() === ui.Button.OK) {
      const tableName = response.getResponseText().trim();
      if (!tableName) {
        throw new Error('Tablo ismi boÅŸ olamaz');
      }
      const existingSheet = spreadsheet.getSheetByName(tableName);
      if (existingSheet) {
        throw new Error(`"${tableName}" isimli tablo zaten mevcut`);
      }
      const result = createFormatTable(spreadsheet, hamVeriSheet, tableName);
      logActivity('createNewTable', { tableName, rowCount: result.rowCount });
      return result;
    } else {
      return { success: false, message: 'Ä°ÅŸlem iptal edildi' };
    }
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/**
 * Creates Format Tablo with standardized structure
 * @param {Spreadsheet} spreadsheet - Active spreadsheet
 * @param {Sheet} hamVeriSheet - Ham veri sheet
 * @param {string} tableName - New table name
 * @returns {Object} - Result object
 */
function createFormatTable(spreadsheet, hamVeriSheet, tableName) {
  const newSheet = spreadsheet.insertSheet(tableName);
  newSheet.activate();
  const formatTableColumns = [
    'Kod', 'Keyword', 'Location', 'Company name', 'Category', 'Website',
    'CMS AdÄ±', 'CMS Grubu',
    'Phone', 'Yetkili Tel', 'Mail', 'Ä°sim Soyisim', 'Aktivite',
    'Aktivite Tarihi', 'Yorum', 'YÃ¶netici Not',
    'E-Ticaret Ä°zi', 'Site HÄ±zÄ±', 'Site TrafiÄŸi', 'Log', 'ToplantÄ± formatÄ±',
    'Address', 'City', 'Rating count', 'Review', 'Maplink'
  ];
  newSheet.getRange(1, 1, 1, formatTableColumns.length).setValues([formatTableColumns]);
  const hamVeriData = hamVeriSheet.getDataRange().getValues();
  const hamVeriHeaders = hamVeriData[0];
  const hamVeriRows = hamVeriData.slice(1);
  const mappedData = mapHamVeriToFormatTable(hamVeriRows, hamVeriHeaders, formatTableColumns, tableName);
  if (mappedData.length > 0) {
    newSheet.getRange(2, 1, mappedData.length, formatTableColumns.length).setValues(mappedData);
    const reviewColumnIndex = formatTableColumns.indexOf('Review') + 1;
    if (reviewColumnIndex > 0 && mappedData.length > 0) {
      const reviewRange = newSheet.getRange(2, reviewColumnIndex, mappedData.length, 1);
      reviewRange.setNumberFormat('@');
    }
    const kodColumnIndex = formatTableColumns.indexOf('Kod') + 1;
    if (kodColumnIndex > 0 && mappedData.length > 0) {
      const kodRange = newSheet.getRange(2, kodColumnIndex, mappedData.length, 1);
      kodRange.setNumberFormat('@');
    }
  }
  applyFormatTableStyling(newSheet);
  return { success: true, tableName, rowCount: mappedData.length, message: `${tableName} baÅŸarÄ±yla oluÅŸturuldu. ${mappedData.length} satÄ±r aktarÄ±ldÄ±.` };
}

/**
 * Decodes URL-encoded Turkish characters
 * @param {string} text - URL-encoded text
 * @returns {string} - Decoded text
 */
function decodeTurkishText(text) {
  if (!text || typeof text !== 'string') {
    return text;
  }
  
  try {
    // First decode URL encoding
    let decoded = decodeURIComponent(text);
    
    // Handle common Turkish character replacements
    const turkishReplacements = {
      '%C4%B0': 'Ä°', // Ä° (capital I with dot)
      '%C4%B1': 'Ä±', // Ä± (lowercase i without dot)
      '%C3%96': 'Ã–', // Ã–
      '%C3%B6': 'Ã¶', // Ã¶
      '%C3%9C': 'Ãœ', // Ãœ
      '%C3%BC': 'Ã¼', // Ã¼
      '%C5%9E': 'Åž', // Åž
      '%C5%9F': 'ÅŸ', // ÅŸ
      '%C4%9E': 'Äž', // Äž
      '%C4%9F': 'ÄŸ', // ÄŸ
      '%C3%87': 'Ã‡', // Ã‡
      '%C3%A7': 'Ã§'  // Ã§
    };
    
    // Apply Turkish character replacements
    Object.keys(turkishReplacements).forEach(encoded => {
      decoded = decoded.replace(new RegExp(encoded, 'g'), turkishReplacements[encoded]);
    });
    
    console.log(`Decoded: "${text}" â†’ "${decoded}"`);
    return decoded;
  } catch (error) {
    console.warn('Error decoding text:', text, error);
    return text; // Return original if decoding fails
  }
}

/**
 * Maps data from Ham veri to Format Tablo structure
 * @param {Array} hamVeriRows - Ham veri rows
 * @param {Array} hamVeriHeaders - Ham veri headers
 * @param {Array} formatTableColumns - Format Tablo columns
 * @param {string} tableName - New table name
 * @returns {Array} - Mapped data
 */
function mapHamVeriToFormatTable(hamVeriRows, hamVeriHeaders, formatTableColumns, tableName) {
  const mappedData = [];
  const employeeCode = getCurrentEmployeeCode();
  hamVeriRows.forEach((row) => {
    const mappedRow = new Array(formatTableColumns.length).fill('');
    formatTableColumns.forEach((formatCol, formatIndex) => {
      const hamVeriIndex = hamVeriHeaders.indexOf(formatCol);
      if (hamVeriIndex !== -1 && row[hamVeriIndex]) {
        if (formatCol === 'Review') {
          let reviewValue = row[hamVeriIndex];
          if (reviewValue instanceof Date) {
            const month = reviewValue.getMonth() + 1;
            const day = reviewValue.getDate();
            reviewValue = `${month}.${day}`;
          }
          mappedRow[formatIndex] = `R${String(reviewValue)}`;
        } else {
          mappedRow[formatIndex] = decodeTurkishText(row[hamVeriIndex]);
        }
      } else {
        switch (formatCol) {
          case 'Kod':
            const sheetName = SpreadsheetApp.getActiveSpreadsheet().getName();
            const beforeTire = sheetName.split(' - ')[0];
            mappedRow[formatIndex] = beforeTire || 'Unknown';
            break;
          case 'Aktivite':
            mappedRow[formatIndex] = '';
            break;
          case 'Aktivite Tarihi':
            mappedRow[formatIndex] = ''; // BoÅŸ bÄ±rak, aktivite seÃ§ildiÄŸinde otomatik doldurulacak
            break;
          case 'Log':
            mappedRow[formatIndex] = `Ham veri'den aktarÄ±ldÄ± - ${new Date().toLocaleString('tr-TR')}`;
            break;
          case 'Maplink':
            const cidIndex = hamVeriHeaders.indexOf('Cid');
            if (cidIndex !== -1 && row[cidIndex]) {
              const cid = row[cidIndex];
              const cidMatch = cid.match(/cid=(\d+)/);
              if (cidMatch) {
                mappedRow[formatIndex] = `https://maps.google.com/?cid=${cidMatch[1]}`;
              } else {
                mappedRow[formatIndex] = `https://maps.google.com/?cid=${cid}`;
              }
            }
            break;
          default:
            mappedRow[formatIndex] = '';
        }
      }
    });
    mappedData.push(mappedRow);
  });
  return mappedData;
}

/**
 * Applies styling to Format Tablo
 * @param {Sheet} sheet - Target sheet
 */
function applyFormatTableStyling(sheet) {
  const headerRange = sheet.getRange(1, 1, 1, sheet.getLastColumn());
  headerRange.setBackground('#4285f4');
  headerRange.setFontColor('white');
  headerRange.setFontWeight('bold');
  sheet.setFrozenRows(1);
  sheet.autoResizeColumns(1, sheet.getLastColumn());
  const dataRange = sheet.getDataRange();
  dataRange.setBorder(true, true, true, true, true, true);
}

/**
 * Sets data validation for dropdown columns
 * @param {Sheet} sheet - Target sheet
 */
function setDataValidation(sheet) {
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const aktiviteIndex = headers.indexOf('Aktivite') + 1;
  const toplantiFormatIndex = headers.indexOf('ToplantÄ± formatÄ±') + 1;
  
  if (aktiviteIndex > 0) {
    const aktiviteRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(CRM_CONFIG.ACTIVITY_OPTIONS, true)
      .setAllowInvalid(true) // GeÃ§ersiz deÄŸerlere izin ver
      .build();
    const minRows = 1000;
    const lastRow = Math.max(sheet.getLastRow(), 2);
    const rowsToValidate = Math.max(minRows, lastRow - 1);
    const validationRange = sheet.getRange(2, aktiviteIndex, rowsToValidate, 1);
    validationRange.clearDataValidations();
    validationRange.setDataValidation(aktiviteRule);
  }
  
  if (toplantiFormatIndex > 0) {
    const toplantiRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(CRM_CONFIG.MEETING_FORMAT_OPTIONS, true)
      .setAllowInvalid(true) // GeÃ§ersiz deÄŸerlere izin ver
      .build();
    const minRows = 1000;
    const lastRow = Math.max(sheet.getLastRow(), 2);
    const rowsToValidate = Math.max(minRows, lastRow - 1);
    const toplantiValidationRange = sheet.getRange(2, toplantiFormatIndex, rowsToValidate, 1);
    toplantiValidationRange.clearDataValidations();
    toplantiValidationRange.setDataValidation(toplantiRule);
  }
}

// ========================================
// FUNCTION 2: TAKE APPOINTMENT
// ========================================

/**
 * Takes appointment from Format Tablo to RandevularÄ±m
 * @param {Object} parameters - Function parameters
 * @returns {Object} - Result object
 */
function takeAppointment(parameters) {
  console.log('Function started: takeAppointment', parameters);
  
  try {
    // Input validation
    if (!validateInput(parameters)) {
      throw new Error('Invalid input provided');
    }
    
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const activeSheet = SpreadsheetApp.getActiveSheet();
    const activeRange = SpreadsheetApp.getActiveRange();
    
    // Check if we're on a Format Tablo or FÄ±rsatlarÄ±m
    console.log('Active sheet name:', activeSheet.getName());
    const sheetName = activeSheet.getName();
    
    // Allow both Format Tablo and FÄ±rsatlarÄ±m sheets
    if (!isFormatTable(activeSheet) && sheetName !== 'FÄ±rsatlarÄ±m') {
      throw new Error(`Bu iÅŸlem sadece Format Tablo veya FÄ±rsatlarÄ±m sayfalarÄ±nda yapÄ±labilir. Mevcut sayfa: "${sheetName}"`);
    }
    
    console.log('âœ… Valid sheet for appointment:', sheetName);
    
    // Check if a row is selected
    if (!activeRange || activeRange.getRow() === 1) {
      throw new Error('LÃ¼tfen bir satÄ±r seÃ§in (baÅŸlÄ±k satÄ±rÄ± hariÃ§)');
    }
    
    // Get selected row data
    const selectedRowData = getSelectedRowData(activeSheet, activeRange.getRow());
    
    // Check if row already has appointment (for both Format Tablo and FÄ±rsatlarÄ±m)
    if (isFormatTable(activeSheet) && selectedRowData.Aktivite === 'Randevu AlÄ±ndÄ±') {
      throw new Error('Bu satÄ±r zaten randevu alÄ±nmÄ±ÅŸ durumda');
    }
    
    // Check if FÄ±rsatlarÄ±m row already has appointment
    if (sheetName === 'FÄ±rsatlarÄ±m') {
      // Check if this row already exists in RandevularÄ±m using Phone + Company name
      const randevularimSheet = spreadsheet.getSheetByName('RandevularÄ±m');
      if (randevularimSheet) {
        const randevularimData = randevularimSheet.getDataRange().getValues();
        const randevularimHeaders = randevularimData[0];
        const phoneIndex = randevularimHeaders.indexOf('Phone');
        const companyIndex = randevularimHeaders.indexOf('Company name');
        
        if (companyIndex !== -1 && selectedRowData['Company name'] && selectedRowData['Company name'].toString().trim() !== '') {
          
          const selectedPhone = selectedRowData.Phone ? selectedRowData.Phone.toString().trim() : '';
          const selectedCompany = selectedRowData['Company name'].toString().trim();
          
          const existingAppointment = randevularimData.slice(1).find(row => {
            const rowPhone = row[phoneIndex];
            const rowCompany = row[companyIndex];
            
            const companyMatch = rowCompany && rowCompany.toString().trim() === selectedCompany;
            
            // EÄŸer telefon boÅŸsa sadece company name kontrol et
            let phoneMatch = true;
            if (selectedPhone !== '') {
              phoneMatch = rowPhone && rowPhone.toString().trim() === selectedPhone;
            }
            
            return phoneMatch && companyMatch;
          });
          
          if (existingAppointment) {
            throw new Error('Bu satÄ±r zaten randevu alÄ±nmÄ±ÅŸ durumda (RandevularÄ±m sayfasÄ±nda mevcut)');
          }
        }
      }
    }
    
    // Show appointment dialog directly
    showAppointmentDialog(selectedRowData);
    
    // Since dialog doesn't return data, we'll handle the processing in the HTML dialog
    // The dialog will call processAppointmentForm which will handle the rest
    return { success: true, message: 'Randevu dialog\'u aÃ§Ä±ldÄ±' };
    
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/**
 * Checks if sheet is a Format Tablo
 * @param {Sheet} sheet - Target sheet
 * @returns {boolean} - Is Format Tablo
 */
function isFormatTable(sheet) {
  const sheetName = sheet.getName();
  console.log('Checking if sheet is Format Table:', sheetName);
  
  // Exclude known non-format table sheets
  const excludedSheets = [
    'Ham veri',
    'ham veri',
    'RandevularÄ±m',
    'FÄ±rsatlarÄ±m', 
    'ToplantÄ±larÄ±m',
    'RaporlarÄ±m',
    'GÃ¼nlÃ¼k Rapor',
    'HaftalÄ±k Rapor',
    'DetaylÄ± Rapor',
    'Config',
    'config',
    'CONFIG'
  ];
  
  // If it's an excluded sheet, it's not a format table
  if (excludedSheets.includes(sheetName)) {
    console.log('Is Format Table: false (excluded sheet)');
    return false;
  }
  
  // If it's not an excluded sheet, it's a format table (user-created table)
  console.log('Is Format Table: true (user-created table)');
  return true;
}

/**
 * Gets selected row data as object
 * @param {Sheet} sheet - Source sheet
 * @param {number} rowNumber - Row number
 * @returns {Object} - Row data object
 */
function getSelectedRowData(sheet, rowNumber) {
  console.log('getSelectedRowData - rowNumber:', rowNumber);
  
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const rowData = sheet.getRange(rowNumber, 1, 1, sheet.getLastColumn()).getValues()[0];
  
  console.log('getSelectedRowData - headers:', headers);
  console.log('getSelectedRowData - rowData:', rowData);
  
  const rowObject = {};
  headers.forEach((header, index) => {
    rowObject[header] = rowData[index];
  });
  
  console.log('getSelectedRowData - rowObject:', rowObject);
  return rowObject;
}

/**
 * Shows appointment dialog with pre-filled data
 * @param {Object} rowData - Selected row data
 * @returns {Object|null} - Appointment data or null if cancelled
 */
function showAppointmentDialog(rowData) {
  console.log('Showing appointment dialog for:', rowData.Kod);
  
  const ui = SpreadsheetApp.getUi();
  
  // Create HTML template for dialog
  const htmlTemplate = HtmlService.createTemplateFromFile('appointmentDialog');
  htmlTemplate.rowData = rowData;
  htmlTemplate.meetingFormats = CRM_CONFIG.MEETING_FORMAT_OPTIONS;
  
  const htmlOutput = htmlTemplate.evaluate()
    .setWidth(600)
    .setHeight(500);
  
  // Show dialog and wait for user input
  ui.showModalDialog(htmlOutput, 'Randevu Al');
  
  // Since modal dialog doesn't return data directly, we need to use a different approach
  // The HTML dialog will call processAppointmentForm via google.script.run
  // For now, return null to indicate dialog was shown
  return null;
}

/**
 * Processes appointment form data from HTML dialog
 * @param {Object} formData - Form data from HTML
 * @returns {Object} - Result object
 */
function processAppointmentForm(formData, selectedRowData = null, rowNumber = null) {
  console.log('Processing appointment form data:', formData);
  
  try {
    // Validate form data
    if (!formData.isimSoyisim || !formData.randevuTarihi) {
      throw new Error('Gerekli alanlar eksik');
    }
    
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const activeSheet = SpreadsheetApp.getActiveSheet();
    
    // Use provided row data or get from active range
    let rowData = selectedRowData;
    let rowNum = rowNumber;
    
    if (!rowData || !rowNum) {
      const activeRange = SpreadsheetApp.getActiveRange();
      if (!activeRange || activeRange.getRow() === 1) {
        throw new Error('GeÃ§erli bir satÄ±r seÃ§ili deÄŸil. LÃ¼tfen bir satÄ±r seÃ§in ve tekrar deneyin.');
      }
      rowData = getSelectedRowData(activeSheet, activeRange.getRow());
      rowNum = activeRange.getRow();
    }
    
    // Add source sheet information to rowData
    console.log('ðŸ“‹ Setting source information for sheet:', activeSheet.getName());
    
    if (isFormatTable(activeSheet)) {
      rowData.Kaynak = activeSheet.getName();
      console.log('ðŸ“‹ Source set to Format Tablo:', activeSheet.getName());
    } else if (activeSheet.getName() === 'FÄ±rsatlarÄ±m') {
      rowData.Kaynak = 'Format Tablo'; // Default for FÄ±rsatlarÄ±m
      console.log('ðŸ“‹ Source set to Format Tablo (from FÄ±rsatlarÄ±m)');
    }
    
    // Create appointment in RandevularÄ±m
    const result = createAppointmentInRandevularim(spreadsheet, rowData, formData);
    
      // Update Format Tablo row with selected activity and form data (only for Format Tablo sheets)
  if (isFormatTable(activeSheet)) {
    console.log('ðŸ“‹ Updating Format Tablo row with activity:', formData.aktivite);
    const activity = formData.aktivite || 'Randevu AlÄ±ndÄ±';
    updateFormatTableRow(activeSheet, rowNum, activity, formData);
    
    // Apply color coding to Format Tablo row
    console.log('ðŸŽ¨ Applying color coding to Format Tablo row for activity:', activity);
    applyFormatTableColorCoding(activeSheet, rowNum, activity);
  }
    
    // Apply appointment color coding to FÄ±rsatlarÄ±m row (if from FÄ±rsatlarÄ±m)
    if (activeSheet.getName() === 'FÄ±rsatlarÄ±m') {
      console.log('ðŸ“‹ Applying appointment color coding to FÄ±rsatlarÄ±m row');
      // FÄ±rsatlarÄ±m iÃ§in renklendirme - applyOpportunityColorCoding kullanÄ±lÄ±yor
    }
    
    console.log('Processing complete:', result);
    logActivity('takeAppointment', { 
      rowId: rowData.Kod,
      appointmentData: formData 
    });
    
    // Return success to close dialog
    return {
      success: true,
      appointmentData: formData,
      message: 'Randevu baÅŸarÄ±yla oluÅŸturuldu!'
    };
    
  } catch (error) {
    console.error('Form processing failed:', error);
    return {
      success: false,
      message: error.message
    };
  }
}

/**
 * Saves appointment data from HTML dialog
 * @param {Object} formData - Form data from HTML
 * @returns {Object} - Result object
 */
function saveAppointmentData(formData) {
  console.log('Saving appointment data from HTML dialog:', formData);
  
  try {
    // Convert HTML form data to backend format
    const appointmentData = {
      isimSoyisim: formData.isimSoyisim,
      randevuTarihi: formData.randevuTarihi,
      saat: formData.saat,
      yorum: formData.yorum,
      aktivite: formData.aktivite || 'Randevu AlÄ±ndÄ±',
      toplantiFormat: formData.toplantiFormat || 'YÃ¼z YÃ¼ze'
    };
    
    // Get current active range to determine row number
    const activeRange = SpreadsheetApp.getActiveRange();
    const activeSheet = SpreadsheetApp.getActiveSheet();
    const rowNumber = activeRange ? activeRange.getRow() : null;
    
    console.log('ðŸ” Active range from saveAppointmentData:', activeRange ? activeRange.getA1Notation() : 'No active range');
    console.log('ðŸ” Row number from saveAppointmentData:', rowNumber);
    
    if (!rowNumber || rowNumber === 1) {
      throw new Error('GeÃ§erli bir satÄ±r seÃ§ili deÄŸil. LÃ¼tfen bir satÄ±r seÃ§in ve tekrar deneyin.');
    }
    
    // Get selected row data
    const selectedRowData = getSelectedRowData(activeSheet, rowNumber);
    console.log('ðŸ” Selected row data from saveAppointmentData:', selectedRowData);
    
    // Call processAppointmentForm with converted data and row info
    return processAppointmentForm(appointmentData, selectedRowData, rowNumber);
    
  } catch (error) {
    console.error('Save appointment data failed:', error);
    return {
      success: false,
      error: error.message
    };
  }
}

/**
 * Creates appointment in RandevularÄ±m sheet
 * @param {Spreadsheet} spreadsheet - Active spreadsheet
 * @param {Object} rowData - Original row data
 * @param {Object} appointmentData - Appointment form data
 * @returns {Object} - Result object
 */
function createAppointmentInRandevularim(spreadsheet, rowData, appointmentData) {
  console.log('Creating appointment in RandevularÄ±m');
  
  let randevularimSheet = spreadsheet.getSheetByName('RandevularÄ±m');
  
  // Create RandevularÄ±m sheet if it doesn't exist
  if (!randevularimSheet) {
    randevularimSheet = createRandevularimSheet(spreadsheet);
  }
  
  // Define RandevularÄ±m columns based on sayfa_kolonlari.md
  const randevularimColumns = [
    'Kod',
    'Kaynak',
    'Keyword',
    'Location',
    'Company name',
    'Category',
    'Website',
    'Phone',
    'Yetkili Tel',
    'Mail',
    'Ä°sim Soyisim',
    'Randevu durumu',
    'Randevu Tarihi',
    'Saat',
    'Yorum',
    'YÃ¶netici Not',
    'CMS AdÄ±',
    'CMS Grubu',
    'E-Ticaret Ä°zi',
    'Site HÄ±zÄ±',
    'Site TrafiÄŸi',
    'Log',
    'ToplantÄ± formatÄ±',
    'Address',
    'City',
    'Rating count',
    'Review',
    'ToplantÄ± Sonucu',
    'ToplantÄ± Tarihi',
    'Maplink'
  ];
  
  // Prepare appointment row data
  const appointmentRow = prepareAppointmentRow(rowData, appointmentData, randevularimColumns, randevularimSheet);
  
  // Add to RandevularÄ±m
  const nextRow = randevularimSheet.getLastRow() + 1;
  randevularimSheet.getRange(nextRow, 1, 1, randevularimColumns.length).setValues([appointmentRow]);
  // Force Kod column to be text format for the new row
  const kodColumnIndex = randevularimColumns.indexOf('Kod') + 1;
  if (kodColumnIndex > 0) {
    randevularimSheet.getRange(nextRow, kodColumnIndex, 1, 1).setNumberFormat('@');
  }
  
  // Apply color coding with detailed logging
  console.log('ðŸŽ¨ Applying color coding to new appointment row:', nextRow);
  console.log('ðŸŽ¨ Appointment data:', appointmentData);
  console.log('ðŸŽ¨ Activity type:', appointmentData.aktivite);
  
  applyAppointmentColorCoding(randevularimSheet, nextRow);
  
  // Force refresh the color coding for all appointment types
  if (appointmentData.aktivite === 'Randevu AlÄ±ndÄ±' || appointmentData.aktivite === 'Ä°leri Tarih Randevu') {
    console.log('ðŸŽ¨ Special handling for appointment type:', appointmentData.aktivite);
    
    // Get the Randevu Durumu column index
    const headers = randevularimSheet.getRange(1, 1, 1, randevularimSheet.getLastColumn()).getValues()[0];
    const randevuDurumuIndex = headers.indexOf('Randevu durumu');
    
    if (randevuDurumuIndex !== -1) {
      // Set the status explicitly
      randevularimSheet.getRange(nextRow, randevuDurumuIndex + 1).setValue(appointmentData.aktivite);
      console.log('ðŸŽ¨ Set Randevu Durumu to:', appointmentData.aktivite);
      
      // Apply color coding again
      updateRandevularimRowColor(randevularimSheet, nextRow, appointmentData.aktivite);
      console.log('ðŸŽ¨ Applied color coding for:', appointmentData.aktivite);
    }
  }
  
  // Sort by date after adding new appointment
  console.log('ðŸ“… Sorting RandevularÄ±m by date after adding new appointment');
  sortRandevularimByDate(randevularimSheet);
  
  // Activate RandevularÄ±m sheet to show the new appointment
  randevularimSheet.activate();
  
  const result = {
    success: true,
    appointmentId: rowData.Kod,
    message: `Randevu baÅŸarÄ±yla oluÅŸturuldu: ${rowData['Company name']} - RandevularÄ±m sayfasÄ±na yÃ¶nlendiriliyorsunuz`
  };
  
  console.log('Appointment created successfully:', result);
  return result;
}

/**
 * Creates RandevularÄ±m sheet with proper structure
 * @param {Spreadsheet} spreadsheet - Active spreadsheet
 * @returns {Sheet} - Created sheet
 */
function createRandevularimSheet(spreadsheet) {
  console.log('Creating RandevularÄ±m sheet');
  
  const sheet = spreadsheet.insertSheet('RandevularÄ±m');
  
  // Define columns
  const columns = [
    'Kod', 'Kaynak', 'Keyword', 'Location', 'Company name', 'Category', 'Website',
    'Phone', 'Yetkili Tel', 'Mail', 'Ä°sim Soyisim', 'Randevu durumu', 'Randevu Tarihi',
    'Saat', 'Yorum', 'YÃ¶netici Not', 'CMS AdÄ±', 'CMS Grubu', 'E-Ticaret Ä°zi',
    'Site HÄ±zÄ±', 'Site TrafiÄŸi', 'Log', 'ToplantÄ± formatÄ±', 'Address', 'City',
    'Rating count', 'Review', 'ToplantÄ± Sonucu', 'ToplantÄ± Tarihi', 'Maplink'
  ];
  
  // Set headers
  sheet.getRange(1, 1, 1, columns.length).setValues([columns]);
  
  // Force Kod column to be text format
  const kodColumnIndex = columns.indexOf('Kod') + 1;
  if (kodColumnIndex > 0) {
    sheet.getRange(1, kodColumnIndex, 1000, 1).setNumberFormat('@');
    console.log('Kod column forced to text format');
  }
  
  // Apply styling
  applyRandevularimStyling(sheet);
  
  return sheet;
}

/**
 * Prepares appointment row data
 * @param {Object} rowData - Original row data
 * @param {Object} appointmentData - Appointment form data
 * @param {Array} columns - Column names
 * @param {Sheet} sheet - RandevularÄ±m sheet
 * @returns {Array} - Row data array
 */
function prepareAppointmentRow(rowData, appointmentData, columns, sheet) {
  console.log('Preparing appointment row data');
  
  const row = new Array(columns.length).fill('');
  
  columns.forEach((column, index) => {
    switch (column) {
      case 'Kod':
        // Use original format, but if empty, get from current employee code
        let kodValue = String(rowData.Kod || '').trim();
        if (!kodValue || kodValue === '' || kodValue === 'undefined' || kodValue === 'null') {
          // Kod boÅŸsa, temsilci kodunu otomatik al
          kodValue = getCurrentEmployeeCode();
          console.log('ðŸ”§ Kod boÅŸtu, otomatik dolduruldu:', kodValue);
        }
        row[index] = kodValue;
        break;
      case 'Kaynak':
        // Use the source sheet name from rowData or determine the source
        // rowData should contain the original source sheet information
        if (rowData.Kaynak) {
          // If rowData already has Kaynak info, use it
          row[index] = rowData.Kaynak;
        } else {
          // Fallback: determine source based on current context
          const activeSheet = SpreadsheetApp.getActiveSheet();
          const sheetName = activeSheet.getName();
          
          if (sheetName === 'FÄ±rsatlarÄ±m') {
            // For FÄ±rsatlarÄ±m, the source is the original Format Tablo
            row[index] = 'Format Tablo';
          } else if (isFormatTable(activeSheet)) {
            // For Format Tablo sheets, use the sheet name
            row[index] = sheetName;
          } else {
            // Default fallback
            row[index] = 'Format Tablo';
          }
        }
        break;
      case 'Keyword':
      case 'Location':
      case 'Company name':
      case 'Category':
      case 'Website':
      case 'Phone':
      case 'Address':
      case 'City':
      case 'Rating count':
        row[index] = rowData[column] || '';
        break;
      case 'Yetkili Tel':
        row[index] = appointmentData.yetkiliTel || '';
        break;
      case 'Mail':
        row[index] = appointmentData.mail || '';
        break;
      case 'Ä°sim Soyisim':
        row[index] = appointmentData.isimSoyisim || '';
        break;
      case 'Randevu durumu':
        // Set the correct status based on activity type
        let randevuDurumu = appointmentData.aktivite || 'Randevu AlÄ±ndÄ±';
        
        // Special handling for Ä°leri Tarih Randevu
        if (randevuDurumu === 'Ä°leri Tarih Randevu') {
          console.log('ðŸŽ¨ Setting Randevu Durumu to Ä°leri Tarih Randevu');
        }
        
        row[index] = randevuDurumu;
        console.log('ðŸŽ¨ Randevu Durumu set to:', randevuDurumu);
        break;
      case 'Randevu Tarihi':
        // Format date as DD.MM.YYYY
        let randevuTarihi = appointmentData.randevuTarihi || '';
        if (randevuTarihi && randevuTarihi.includes('-')) {
          // Convert from YYYY-MM-DD to DD.MM.YYYY
          const parts = randevuTarihi.split('-');
          if (parts.length === 3) {
            randevuTarihi = `${parts[2]}.${parts[1]}.${parts[0]}`;
          }
        } else if (randevuTarihi instanceof Date) {
          const day = randevuTarihi.getDate().toString().padStart(2, '0');
          const month = (randevuTarihi.getMonth() + 1).toString().padStart(2, '0');
          const year = randevuTarihi.getFullYear();
          randevuTarihi = `${day}.${month}.${year}`;
        }
        row[index] = randevuTarihi;
        break;
      case 'Saat':
        row[index] = appointmentData.saat || '';
        break;
      case 'Yorum':
        row[index] = appointmentData.yorum || '';
        break;
      case 'Review':
        // Preserve Review as text to prevent date conversion
        row[index] = String(rowData[column] || '');
        break;
      case 'Maplink':
        // Preserve Maplink as text
        row[index] = String(rowData[column] || '');
        break;

      case 'CMS AdÄ±':
      case 'CMS Grubu':
      case 'E-Ticaret Ä°zi':
      case 'Site HÄ±zÄ±':
      case 'Site TrafiÄŸi':
        row[index] = rowData[column] || '';
        break;
      case 'Log':
        row[index] = `Randevu alÄ±ndÄ± - ${new Date().toLocaleString('tr-TR')}`;
        break;
      case 'ToplantÄ± formatÄ±':
        row[index] = appointmentData.toplantiFormat || 'YÃ¼z YÃ¼ze';
        break;
      case 'ToplantÄ± Sonucu':
        row[index] = '';
        break;
      case 'ToplantÄ± Tarihi':
        row[index] = '';
        break;
    }
  });
  
  return row;
}

/**
 * Updates Format Tablo row activity
 * @param {Sheet} sheet - Format Tablo sheet
 * @param {number} rowNumber - Row number
 * @param {string} activity - New activity
 */
function updateFormatTableRow(sheet, rowNumber, activity, formData = {}) {
  console.log('Updating Format Tablo row activity:', activity, 'formData:', formData);
  
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const aktiviteIndex = headers.indexOf('Aktivite') + 1;
  const aktiviteTarihiIndex = headers.indexOf('Aktivite Tarihi') + 1;
  const logIndex = headers.indexOf('Log') + 1;
  
  // Update activity
  if (aktiviteIndex > 0) {
    sheet.getRange(rowNumber, aktiviteIndex).setValue(activity);
  }
  
  // Update activity date
  if (aktiviteTarihiIndex > 0) {
    sheet.getRange(rowNumber, aktiviteTarihiIndex).setValue(new Date());
  }
  
  // Update form data fields if provided
  if (formData) {
    // Yetkili Tel
    const yetkiliTelIndex = headers.indexOf('Yetkili Tel') + 1;
    if (yetkiliTelIndex > 0 && formData.yetkiliTel) {
      sheet.getRange(rowNumber, yetkiliTelIndex).setValue(formData.yetkiliTel);
    }
    
    // Mail
    const mailIndex = headers.indexOf('Mail') + 1;
    if (mailIndex > 0 && formData.mail) {
      sheet.getRange(rowNumber, mailIndex).setValue(formData.mail);
    }
    
    // Ä°sim Soyisim
    const isimSoyisimIndex = headers.indexOf('Ä°sim Soyisim') + 1;
    if (isimSoyisimIndex > 0 && formData.isimSoyisim) {
      sheet.getRange(rowNumber, isimSoyisimIndex).setValue(formData.isimSoyisim);
    }
    
    // ToplantÄ± formatÄ±
    const toplantiFormatIndex = headers.indexOf('ToplantÄ± formatÄ±') + 1;
    if (toplantiFormatIndex > 0 && formData.toplantiFormat) {
      sheet.getRange(rowNumber, toplantiFormatIndex).setValue(formData.toplantiFormat);
    }
  }
  
  // Update log
  if (logIndex > 0) {
    const currentLog = sheet.getRange(rowNumber, logIndex).getValue();
    const newLog = `${activity} - ${new Date().toLocaleString('tr-TR')}`;
    sheet.getRange(rowNumber, logIndex).setValue(newLog);
  }
  
  // Apply color coding to the row
  console.log('ðŸŽ¨ Applying color coding to row for activity:', activity);
  applyFormatTableColorCoding(sheet, rowNumber, activity);
  
  console.log('ðŸ” Debug - updateFormatTableRow completed for activity:', activity);
}

/**
 * Applies color coding to Format Tablo row based on activity
 * @param {Sheet} sheet - Format Tablo sheet
 * @param {number} rowNumber - Row number
 * @param {string} activity - Activity status
 */
/**
 * ðŸŽ¨ Format Table Color Coding - Visual Status
 * @param {Sheet} sheet - Target sheet
 * @param {number} rowNumber - Row number
 * @param {string} activity - Activity status
 */
function applyFormatTableColorCoding(sheet, rowNumber, activity) {
  console.log('ðŸŽ¨ Applying Format Tablo color coding to row:', rowNumber, 'activity:', activity);
  
  try {
    if (!sheet || !rowNumber) {
      console.error('âŒ Invalid parameters for color coding');
      return;
    }
    
    // Normalize activity (trim + fuzzy match for known variants)
    const actRaw = activity ? activity.toString().trim() : '';
    const actLower = actRaw.toLowerCase();
    let normalizedActivity = actRaw;
    
    // Fuzzy normalization for "FÄ±rsat Ä°letildi"
    if (actLower.includes('fÄ±rsat') && actLower.includes('iletildi')) {
      normalizedActivity = 'FÄ±rsat Ä°letildi';
    }
    
    // If normalized differs, try to fix the cell value to exact label for future consistency
    try {
      const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
      const aktiviteIdx = headers.indexOf('Aktivite');
      if (aktiviteIdx !== -1 && normalizedActivity && normalizedActivity !== actRaw) {
        sheet.getRange(rowNumber, aktiviteIdx + 1).setValue(normalizedActivity);
        console.log(`ðŸ”§ Aktivite dÃ¼zeltildi: "${actRaw}" â†’ "${normalizedActivity}"`);
      }
    } catch (fixErr) {
      console.log('Aktivite normalizasyonu sÄ±rasÄ±nda uyarÄ±:', fixErr);
    }
    
    let color = 'rgb(255, 255, 255)'; // Default white
    
    // Check if activity is empty, null, or undefined
    if (!normalizedActivity) {
      console.log('âš ï¸ Empty activity - applying white color');
      color = 'rgb(255, 255, 255)'; // White
    }
    // Map activity to color using centralized system
    else if (normalizedActivity === 'Randevu AlÄ±ndÄ±') {
      color = CRM_CONFIG.COLOR_CODES['Randevu AlÄ±ndÄ±'];
    } else if (normalizedActivity === 'Ä°leri Tarih Randevu') {
      color = CRM_CONFIG.COLOR_CODES['Ä°leri Tarih Randevu'];
    } else if (normalizedActivity === 'Randevu Teyitlendi') {
      color = CRM_CONFIG.COLOR_CODES['Randevu Teyitlendi'];
    } else if (normalizedActivity === 'Randevu Ertelendi') {
      color = CRM_CONFIG.COLOR_CODES['Randevu Ertelendi'];
    } else if (normalizedActivity === 'Randevu Ä°ptal oldu') {
      color = CRM_CONFIG.COLOR_CODES['Randevu Ä°ptal oldu'];
    } else if (normalizedActivity === 'FÄ±rsat Ä°letildi') {
      color = CRM_CONFIG.COLOR_CODES['FÄ±rsat Ä°letildi'];
      console.log('ðŸ” Debug - FÄ±rsat Ä°letildi color found:', color);
    } else if (normalizedActivity === 'Bilgi Verildi') {
      color = CRM_CONFIG.COLOR_CODES['Bilgi Verildi'];
    } else if (normalizedActivity === 'Yeniden Aranacak') {
      color = CRM_CONFIG.COLOR_CODES['Yeniden Aranacak'];
    } else if (normalizedActivity === 'Ä°lgilenmiyor') {
      color = CRM_CONFIG.COLOR_CODES['Ä°lgilenmiyor'];
    } else if (normalizedActivity === 'UlaÅŸÄ±lamadÄ±') {
      color = CRM_CONFIG.COLOR_CODES['UlaÅŸÄ±lamadÄ±'];
    } else if (normalizedActivity === 'GeÃ§ersiz Numara') {
      color = CRM_CONFIG.COLOR_CODES['GeÃ§ersiz Numara'];
    } else if (normalizedActivity === 'ToplantÄ± TamamlandÄ±') {
      color = CRM_CONFIG.COLOR_CODES['ToplantÄ± TamamlandÄ±'];
    } else {
      console.log('âš ï¸ Unknown activity:', normalizedActivity, '- using default white');
      console.log('ðŸ” Debug - Available colors:', Object.keys(CRM_CONFIG.COLOR_CODES));
    }
    
    // Apply color to entire row
    const range = sheet.getRange(rowNumber, 1, 1, sheet.getLastColumn());
    console.log(`ðŸ” Debug - About to apply color ${color} to range ${range.getA1Notation()}`);
    
    try {
      range.setBackground(color);
      console.log(`âœ… Successfully applied color ${color} to row ${rowNumber} for activity: ${normalizedActivity}`);
    } catch (setBackgroundError) {
      console.error(`âŒ Error setting background color:`, setBackgroundError);
      throw setBackgroundError;
    }
    
  } catch (error) {
    console.error('âŒ Error applying Format Tablo color coding:', error);
  }
}

/**
 * Applies styling to RandevularÄ±m sheet
 * @param {Sheet} sheet - Target sheet
 */
function applyRandevularimStyling(sheet) {
  console.log('Applying RandevularÄ±m styling');
  
  // Header styling
  const headerRange = sheet.getRange(1, 1, 1, sheet.getLastColumn());
  headerRange.setBackground('#34a853');
  headerRange.setFontColor('white');
  headerRange.setFontWeight('bold');
  
  // Freeze header row
  sheet.setFrozenRows(1);
  
  // Auto-resize columns
  sheet.autoResizeColumns(1, sheet.getLastColumn());
  
  // Manual column width adjustments for better readability
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  headers.forEach((header, index) => {
    const columnIndex = index + 1;
    switch (header) {
      case 'Kod':
        sheet.setColumnWidth(columnIndex, 120);
        break;
      case 'Company name':
        sheet.setColumnWidth(columnIndex, 200);
        break;
      case 'Phone':
      case 'Yetkili Tel':
        sheet.setColumnWidth(columnIndex, 130);
        break;
      case 'Mail':
        sheet.setColumnWidth(columnIndex, 180);
        break;
      case 'Ä°sim Soyisim':
        sheet.setColumnWidth(columnIndex, 150);
        break;
      case 'Randevu Tarihi':
      case 'ToplantÄ± Tarihi':
        sheet.setColumnWidth(columnIndex, 120);
        break;
      case 'Saat':
        sheet.setColumnWidth(columnIndex, 80);
        break;
      case 'Yorum':
      case 'YÃ¶netici Not':
        sheet.setColumnWidth(columnIndex, 250);
        break;
      case 'Address':
        sheet.setColumnWidth(columnIndex, 300);
        break;
      case 'Website':
        sheet.setColumnWidth(columnIndex, 200);
        break;
      default:
        // Default width for other columns
        if (sheet.getColumnWidth(columnIndex) < 100) {
          sheet.setColumnWidth(columnIndex, 100);
        }
    }
  });
  
  // Add borders
  const dataRange = sheet.getDataRange();
  dataRange.setBorder(true, true, true, true, true, true);
  
  // Auto-sort by date (newest first)
  sortRandevularimByDate(sheet);
  
  console.log('RandevularÄ±m styling completed with optimized column widths and date sorting');
}

/**
 * Sets data validation for RandevularÄ±m sheet
 * @param {Sheet} sheet - Target sheet
 */
function setRandevularimDataValidation(sheet) {
  console.log('Setting RandevularÄ±m data validation');
  
  // If no sheet parameter provided, get the active sheet
  if (!sheet) {
    console.log('No sheet parameter provided, getting active sheet');
    try {
      sheet = SpreadsheetApp.getActiveSheet();
      console.log('Active sheet found:', sheet.getName());
    } catch (error) {
      console.error('Could not get active sheet:', error);
      throw new Error('No active sheet found. Please open a sheet first.');
    }
  }
  
  // Check if sheet parameter is valid
  if (!sheet) {
    console.error('Sheet parameter is undefined or null');
    throw new Error('Sheet parameter is required');
  }
  
  console.log('Sheet name:', sheet.getName());
  console.log('Sheet last row:', sheet.getLastRow());
  console.log('Sheet last column:', sheet.getLastColumn());
  
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  
  // Minimum 1000 rows for data validation
  const minRows = 1000;
  const currentRows = Math.max(2, sheet.getLastRow());
  const validationRows = Math.max(minRows, currentRows - 1);
  
  console.log(`Applying validation to ${validationRows} rows`);
  
  // Randevu durumu validation (dropdown)
  const randevuDurumuIndex = headers.indexOf('Randevu durumu') + 1;
  if (randevuDurumuIndex > 0) {
    const randevuDurumuOptions = ['Randevu AlÄ±ndÄ±', 'Ä°leri Tarih Randevu', 'Randevu Teyitlendi', 'Randevu Ertelendi', 'Randevu Ä°ptal oldu'];
    const randevuRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(randevuDurumuOptions, true)
      .setAllowInvalid(false) // GeÃ§ersiz deÄŸerlere izin verme
      .build();
    
    sheet.getRange(2, randevuDurumuIndex, validationRows, 1).setDataValidation(randevuRule);
    console.log('Applied Randevu durumu validation');
  }
  
  // Randevu Tarihi validation (datepicker)
  const randevuTarihiIndex = headers.indexOf('Randevu Tarihi') + 1;
  if (randevuTarihiIndex > 0) {
    const tarihRule = SpreadsheetApp.newDataValidation()
      .requireDate()
      .setAllowInvalid(false)
      .build();
    
    sheet.getRange(2, randevuTarihiIndex, validationRows, 1).setDataValidation(tarihRule);
    console.log('Applied Randevu Tarihi validation');
  }
  
  // Saat validation (time picker)
  const saatIndex = headers.indexOf('Saat') + 1;
  if (saatIndex > 0) {
    const saatOptions = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00'];
    const saatRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(saatOptions, true)
      .setAllowInvalid(false)
      .build();
    
    sheet.getRange(2, saatIndex, validationRows, 1).setDataValidation(saatRule);
    console.log('Applied Saat validation');
  }
  
  // ToplantÄ± formatÄ± validation (dropdown)
  const toplantiFormatIndex = headers.indexOf('ToplantÄ± formatÄ±') + 1;
  if (toplantiFormatIndex > 0) {
    const toplantiRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(CRM_CONFIG.MEETING_FORMAT_OPTIONS, true)
      .setAllowInvalid(false) // GeÃ§ersiz deÄŸerlere izin verme
      .build();
    
    sheet.getRange(2, toplantiFormatIndex, validationRows, 1).setDataValidation(toplantiRule);
    console.log('Applied ToplantÄ± formatÄ± validation');
  }
  
  // ToplantÄ± Sonucu validation (dropdown) - RandevularÄ±m'da bu sÃ¼tun yok
  // Bu validation sadece ToplantÄ±larÄ±m sayfasÄ±nda olmalÄ±
  
  // ToplantÄ± Tarihi validation (datepicker)
  const toplantiTarihiIndex = headers.indexOf('ToplantÄ± Tarihi') + 1;
  if (toplantiTarihiIndex > 0) {
    const toplantiTarihRule = SpreadsheetApp.newDataValidation()
      .requireDate()
      .setAllowInvalid(false) // GeÃ§ersiz deÄŸerlere izin verme
      .build();
    
    sheet.getRange(2, toplantiTarihiIndex, validationRows, 1).setDataValidation(toplantiTarihRule);
    console.log('Applied ToplantÄ± Tarihi validation');
  }
  
  console.log('RandevularÄ±m data validation completed');
}

/**
 * ðŸŽ¨ Appointment Color Coding - Visual Status
 * @param {Sheet} sheet - RandevularÄ±m sheet
 * @param {number} rowNumber - Row number
 */
function applyAppointmentColorCoding(sheet, rowNumber) {
  console.log('ðŸŽ¨ Applying appointment color coding to row:', rowNumber);
  
  try {
    if (!sheet || !rowNumber) {
      console.error('âŒ Invalid parameters for appointment color coding');
      return;
    }
    
    // Get the status from the Randevu Durumu column (display values, case-insensitive)
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getDisplayValues()[0];
    const lowered = headers.map(h => String(h||'').toLowerCase());
    let randevuDurumuIndex = lowered.indexOf('randevu durumu');
    if (randevuDurumuIndex === -1) randevuDurumuIndex = lowered.indexOf('randevu durumu'.toLowerCase());
    
    if (randevuDurumuIndex === -1) {
      console.error('âŒ Randevu Durumu column not found');
      return;
    }
    
    const rawStatus = sheet.getRange(rowNumber, randevuDurumuIndex + 1).getDisplayValue();
    const norm = String(rawStatus || '').toLowerCase();
    let status = '';
    if (norm.includes('iptal')) status = 'Randevu Ä°ptal oldu';
    else if (norm.includes('erte')) status = 'Randevu Ertelendi';
    else if (norm.includes('teyit')) status = 'Randevu Teyitlendi';
    else if (norm.includes('ileri')) status = 'Ä°leri Tarih Randevu';
    else if (norm.includes('alÄ±nd') || norm.includes('alindi') || norm.includes('alÄ±n') || norm === 'randevu alÄ±ndÄ±') status = 'Randevu AlÄ±ndÄ±';
    else status = String(rawStatus || '').trim();
    
    console.log('ðŸ“‹ Status found:', status, 'in row:', rowNumber);
    
    // Use updateRandevularimRowColor for consistent color logic (includes ToplantÄ± Sonucu override)
    updateRandevularimRowColor(sheet, rowNumber, status);
    
  } catch (error) {
    console.error('âŒ Error applying appointment color coding:', error);
  }
}

/**
 * Shows take appointment dialog
 */
function showTakeAppointmentDialog() {
  console.log('Showing take appointment dialog');
  takeAppointment({});
}

// ========================================
// FUNCTION 3: ADD OPPORTUNITY
// ========================================

/**
 * Adds opportunity from Format Tablo to FÄ±rsatlarÄ±m
 * @param {Object} parameters - Function parameters
 * @returns {Object} - Result object
 */
function addOpportunity(parameters) {
  console.log('Function started: addOpportunity', parameters);
  
  try {
    // Input validation
    if (!validateInput(parameters)) {
      throw new Error('Invalid input provided');
    }
    
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const activeSheet = SpreadsheetApp.getActiveSheet();
    const activeRange = SpreadsheetApp.getActiveRange();
    
    // Check if we're on a Format Tablo
    console.log('Active sheet name:', activeSheet.getName());
    if (!isFormatTable(activeSheet)) {
      throw new Error(`Bu iÅŸlem sadece Format Tablo sayfalarÄ±nda yapÄ±labilir. Mevcut sayfa: "${activeSheet.getName()}"`);
    }
    
    // Check if a row is selected
    if (!activeRange || activeRange.getRow() === 1) {
      throw new Error('LÃ¼tfen bir satÄ±r seÃ§in (baÅŸlÄ±k satÄ±rÄ± hariÃ§)');
    }
    
    // Get selected row data - Use more reliable method
    let selectedRow = activeRange.getRow();
    
    // Additional safety check - ensure we're not on header row
    if (selectedRow === 1) {
      throw new Error('LÃ¼tfen bir satÄ±r seÃ§in (baÅŸlÄ±k satÄ±rÄ± hariÃ§)');
    }
    
    // Log the selected row for debugging
    console.log('Selected row number:', selectedRow);
    console.log('Active range:', activeRange.getA1Notation());
    
    const selectedRowData = getSelectedRowData(activeSheet, selectedRow);
    
    // Check if row already has opportunity (only if Aktivite field exists and is not empty)
    if (selectedRowData.Aktivite && selectedRowData.Aktivite.toString().trim() === 'FÄ±rsat Ä°letildi') {
      throw new Error('Bu satÄ±r zaten fÄ±rsat olarak iÅŸaretlenmiÅŸ');
    }
    
    // Check if this row already exists in FÄ±rsatlarÄ±m using Phone + Company name
    const firsatlarimSheet = spreadsheet.getSheetByName('FÄ±rsatlarÄ±m');
    if (firsatlarimSheet) {
      const firsatlarimData = firsatlarimSheet.getDataRange().getValues();
      const firsatlarimHeaders = firsatlarimData[0];
      const phoneIndex = firsatlarimHeaders.indexOf('Phone');
      const companyIndex = firsatlarimHeaders.indexOf('Company name');
      
      console.log('Debug - selectedRowData.Phone:', selectedRowData.Phone);
      console.log('Debug - selectedRowData.Company name:', selectedRowData['Company name']);
      console.log('Debug - phoneIndex:', phoneIndex, 'companyIndex:', companyIndex);
      console.log('Debug - FÄ±rsatlarÄ±m data rows:', firsatlarimData.length);
      
      if (companyIndex !== -1 && selectedRowData['Company name'] && selectedRowData['Company name'].toString().trim() !== '') {
        console.log('Debug - Starting duplicate check...');
        
        const selectedPhone = selectedRowData.Phone ? selectedRowData.Phone.toString().trim() : '';
        const selectedCompany = selectedRowData['Company name'].toString().trim();
        
        console.log('Debug - Checking for existing opportunity with Company:', selectedCompany, 'Phone:', selectedPhone || 'BOÅž');
        
        // TemizlenmiÅŸ ve geliÅŸtirilmiÅŸ kontrol - sadece gerÃ§ekten dolu ve anlamlÄ± satÄ±rlarÄ± bul
        console.log('Debug - Searching through FÄ±rsatlarÄ±m data for duplicates...');
        
        // Ã–nce seÃ§ilen satÄ±rÄ±n Kod deÄŸerini al
        const selectedKod = selectedRowData.Kod ? selectedRowData.Kod.toString().trim() : '';
        console.log('Debug - Selected row Kod:', selectedKod);
        
        // FÄ±rsatlarÄ±m'daki tÃ¼m satÄ±rlarÄ± kontrol et (baÅŸlÄ±k hariÃ§)
        const existingOpportunity = firsatlarimData.slice(1).find((row, index) => {
          // BoÅŸ satÄ±rlarÄ± hemen atla (hÄ±zlÄ± kontrol)
          if (!row || row.every(cell => !cell || cell.toString().trim() === '')) {
            console.log(`Debug - Row ${index + 2} is empty, skipping`);
            return false;
          }
          
          // Gerekli deÄŸerleri al
          const kodIndex = firsatlarimHeaders.indexOf('Kod');
          const rowKod = kodIndex >= 0 && row[kodIndex] ? row[kodIndex].toString().trim() : '';
          
          // Kod boÅŸsa, bu geÃ§erli bir kayÄ±t deÄŸil
          if (!rowKod) {
            console.log(`Debug - Row ${index + 2} has no Kod, skipping`);
            return false;
          }
          
          // Kod eÅŸleÅŸmesi kontrolÃ¼ - bu en gÃ¼venilir yÃ¶ntem
          if (selectedKod && rowKod && selectedKod === rowKod) {
            console.log(`Debug - EXACT KOD MATCH FOUND at row ${index + 2}: ${rowKod}`);
            return true;
          }
          
          // Kod eÅŸleÅŸmesi yoksa, telefon ve ÅŸirket adÄ± kontrolÃ¼ yap
          const rowPhone = phoneIndex >= 0 && row[phoneIndex] ? row[phoneIndex].toString().trim() : '';
          const rowCompany = companyIndex >= 0 && row[companyIndex] ? row[companyIndex].toString().trim() : '';
          
          // Åžirket adÄ± boÅŸsa, bu muhtemelen geÃ§erli bir kayÄ±t deÄŸil
          if (!rowCompany) {
            console.log(`Debug - Row ${index + 2} has no Company name, skipping`);
            return false;
          }
          
          // Company name karÅŸÄ±laÅŸtÄ±rmasÄ±
          const companyMatch = rowCompany && selectedCompany && rowCompany === selectedCompany;
          
          // Phone karÅŸÄ±laÅŸtÄ±rmasÄ± (telefon boÅŸsa atla)
          let phoneMatch = true; // VarsayÄ±lan olarak true
          if (selectedPhone && selectedPhone !== '') {
            phoneMatch = rowPhone && rowPhone === selectedPhone;
          }
          
          const match = phoneMatch && companyMatch;
          
          console.log(`Debug - Row ${index + 2} comparison:`, {
            rowNumber: index + 2,
            kod: rowKod,
            company: rowCompany,
            phone: rowPhone,
            companyMatch: companyMatch,
            phoneMatch: phoneMatch,
            finalMatch: match
          });
          
          return match;
        });
        
        if (existingOpportunity) {
          console.log('Debug - Found existing opportunity:', existingOpportunity);
          
          // FÄ±rsat Durumu kontrolÃ¼ - eÄŸer satÄ±r silindi olarak iÅŸaretlendiyse izin ver
          const firsatDurumuIndex = firsatlarimHeaders.indexOf('FÄ±rsat Durumu');
          if (firsatDurumuIndex >= 0) {
            const firsatDurumu = existingOpportunity[firsatDurumuIndex];
            console.log('Debug - Existing opportunity status:', firsatDurumu);
            
            // Her durumda iÅŸleme devam et - mÃ¼kerrer kontrolÃ¼nÃ¼ tamamen kaldÄ±r
            console.log('Debug - Skipping duplicate check, allowing all opportunities');
            
            // KullanÄ±cÄ±ya bilgi ver ama iÅŸlemi engelleme
            if (firsatDurumu) {
              console.log('Debug - Found existing opportunity with status:', firsatDurumu);
            }
          } else {
            // MÃ¼kerrer kontrolÃ¼nÃ¼ tamamen kaldÄ±r - her durumda izin ver
            console.log('Debug - Skipping Kod check, allowing all opportunities');
          }
        }
      } else {
        console.log('Debug - Skipping check: phoneIndex =', phoneIndex, 'companyIndex =', companyIndex);
        console.log('Debug - selectedRowData.Phone =', selectedRowData.Phone, 'selectedRowData.Company name =', selectedRowData['Company name']);
      }
    }
    
    // Show opportunity dialog directly
    showOpportunityDialog(selectedRowData);
    
    // Since dialog doesn't return data, we'll handle the processing in the HTML dialog
    // The dialog will call processOpportunityForm which will handle the rest
    return { success: true, message: 'FÄ±rsat dialog\'u aÃ§Ä±ldÄ±' };
    
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/**
 * Shows opportunity dialog with pre-filled data
 * @param {Object} rowData - Selected row data
 * @returns {Object|null} - Opportunity data or null if cancelled
 */
function showOpportunityDialog(rowData) {
  console.log('Showing opportunity dialog for:', rowData.Kod);
  
  const ui = SpreadsheetApp.getUi();
  
  // Create HTML template for dialog
  const htmlTemplate = HtmlService.createTemplateFromFile('opportunityDialog');
  htmlTemplate.rowData = rowData;
  htmlTemplate.meetingFormats = CRM_CONFIG.MEETING_FORMAT_OPTIONS;
  
  const htmlOutput = htmlTemplate.evaluate()
    .setWidth(600)
    .setHeight(500);
  
  const response = ui.showModalDialog(htmlOutput, 'FÄ±rsat Ekle');
  
  console.log('Dialog response:', response);
  
  if (response && response.success) {
    return response;
  }
  
  return null;
}

/**
 * Processes opportunity form data from HTML dialog
 * @param {Object} formData - Form data from HTML
 * @returns {Object} - Result object
 */
function processOpportunityForm(formData) {
  console.log('Processing opportunity form data:', formData);
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const activeSheet = SpreadsheetApp.getActiveSheet();
    const activeRange = SpreadsheetApp.getActiveRange();
    
    // Get selected row data - Use more reliable method
    let selectedRow = activeRange.getRow();
    
    // Additional safety check - ensure we're not on header row
    if (selectedRow === 1) {
      throw new Error('LÃ¼tfen bir satÄ±r seÃ§in (baÅŸlÄ±k satÄ±rÄ± hariÃ§)');
    }
    
    // Log the selected row for debugging
    console.log('Selected row number:', selectedRow);
    console.log('Active range:', activeRange.getA1Notation());
    
    const selectedRowData = getSelectedRowData(activeSheet, selectedRow);
    
    // Add source sheet information to rowData
    if (isFormatTable(activeSheet)) {
      selectedRowData.Kaynak = activeSheet.getName();
    }
    
      // Create opportunity in FÄ±rsatlarÄ±m
  const result = createOpportunityInFirsatlarim(spreadsheet, selectedRowData, formData);
  
  // Normalize activity label for Format Tablo
  let newActivity = (formData.firsatDurumu || '').toString().trim();
  const newActLower = newActivity.toLowerCase();
  if (newActLower.includes('fÄ±rsat') && newActLower.includes('iletildi')) newActivity = 'FÄ±rsat Ä°letildi';
  else if (newActLower.includes('bilgi') && newActLower.includes('verildi')) newActivity = 'Bilgi Verildi';
  else if (newActLower.includes('yeniden') && newActLower.includes('aranacak')) newActivity = 'Yeniden Aranacak';
  if (!newActivity) newActivity = 'FÄ±rsat Ä°letildi';

  // Update Format Tablo row with selected activity and form data
  console.log('ðŸ” Debug - Updating Format Tablo row with activity:', newActivity);
  updateFormatTableRow(activeSheet, selectedRow, newActivity, formData);
    
    // Apply color coding to the updated row - SIMPLE AND DIRECT
    console.log('ðŸŽ¨ Applying color directly to row:', selectedRow);
    
    try {
      const range = activeSheet.getRange(selectedRow, 1, 1, activeSheet.getLastColumn());
      const color = 'rgb(255, 235, 238)'; // Light Red for FÄ±rsat Ä°letildi
      range.setBackground(color);
      console.log('âœ… Color applied successfully to row:', selectedRow);
    } catch (colorError) {
      console.error('âŒ Error applying color:', colorError);
    }
    
    console.log('Processing complete:', result);
    logActivity('FÄ±rsat Ä°letildi', { 
      rowId: selectedRowData.Kod,
      opportunityData: formData 
    });
    
    // Return success to close dialog
    return {
      success: true,
      opportunityData: formData,
      message: 'FÄ±rsat baÅŸarÄ±yla oluÅŸturuldu!'
    };
    
  } catch (error) {
    console.error('Form processing failed:', error);
    return {
      success: false,
      message: error.message
    };
  }
}

/**
 * Creates opportunity in FÄ±rsatlarÄ±m sheet
 * @param {Spreadsheet} spreadsheet - Active spreadsheet
 * @param {Object} rowData - Original row data
 * @param {Object} opportunityData - Opportunity form data
 * @returns {Object} - Result object
 */
function createOpportunityInFirsatlarim(spreadsheet, rowData, opportunityData) {
  console.log('Creating opportunity in FÄ±rsatlarÄ±m');
  
  let firsatlarimSheet = spreadsheet.getSheetByName('FÄ±rsatlarÄ±m');
  
  // Create FÄ±rsatlarÄ±m sheet if it doesn't exist
  if (!firsatlarimSheet) {
    firsatlarimSheet = createFirsatlarimSheet(spreadsheet);
  }
  
  // Columns: use existing sheet headers to avoid misalignment
  const firsatlarimColumns = firsatlarimSheet.getRange(1, 1, 1, firsatlarimSheet.getLastColumn()).getValues()[0];
  
  // Prepare opportunity row data
  const opportunityRow = prepareOpportunityRow(rowData, opportunityData, firsatlarimColumns, firsatlarimSheet);
  
  // Add to FÄ±rsatlarÄ±m
  const nextRow = firsatlarimSheet.getLastRow() + 1;
  firsatlarimSheet.getRange(nextRow, 1, 1, firsatlarimColumns.length).setValues([opportunityRow]);
  // Force Kod column to be text format for the new row
  const kodColumnIndex = firsatlarimColumns.indexOf('Kod') + 1;
  if (kodColumnIndex > 0) {
    firsatlarimSheet.getRange(nextRow, kodColumnIndex, 1, 1).setNumberFormat('@');
  }
  
  // Apply color coding
  console.log('ðŸ” Debug - Applying color coding to row:', nextRow);
  console.log('ðŸ” Debug - Opportunity data:', opportunityData);
  applyOpportunityColorCoding(firsatlarimSheet, nextRow);
  
  // Sort by date after adding new opportunity
  console.log('ðŸ“… Sorting FÄ±rsatlarÄ±m by date after adding new opportunity');
  sortFirsatlarimByDate(firsatlarimSheet);
  
  // Activate FÄ±rsatlarÄ±m sheet to show the new opportunity
  firsatlarimSheet.activate();
  
  const result = {
    success: true,
    opportunityId: rowData.Kod,
    message: `FÄ±rsat baÅŸarÄ±yla oluÅŸturuldu: ${rowData['Company name']} - FÄ±rsatlarÄ±m sayfasÄ±na yÃ¶nlendiriliyorsunuz`
  };
  
  console.log('Opportunity created successfully:', result);
  return result;
}

/**
 * Creates FÄ±rsatlarÄ±m sheet with proper structure
 * @param {Spreadsheet} spreadsheet - Active spreadsheet
 * @returns {Sheet} - Created sheet
 */
function createFirsatlarimSheet(spreadsheet) {
  console.log('Creating FÄ±rsatlarÄ±m sheet');
  
  const sheet = spreadsheet.insertSheet('FÄ±rsatlarÄ±m');
  
  // Define columns (FÄ±rsatlarÄ±m'da Aktivite sÃ¼tunu yok)
  const columns = [
    'Kod', 'Kaynak', 'Keyword', 'Location', 'Company name', 'Category', 'Website',
    'Phone', 'Yetkili Tel', 'Mail', 'Ä°sim Soyisim', 'FÄ±rsat Durumu', 'FÄ±rsat Tarihi',
    'Yorum', 'YÃ¶netici Not', 'CMS AdÄ±', 'CMS Grubu', 'E-Ticaret Ä°zi', 'Site HÄ±zÄ±',
    'Site TrafiÄŸi', 'Log', 'ToplantÄ± formatÄ±', 'Address', 'City', 'Rating count',
    'Review', 'Maplink'
  ];
  
  // Set headers
  sheet.getRange(1, 1, 1, columns.length).setValues([columns]);
  
  // Force Kod column to be text format
  const kodColumnIndex = columns.indexOf('Kod') + 1;
  if (kodColumnIndex > 0) {
    sheet.getRange(1, kodColumnIndex, 1000, 1).setNumberFormat('@');
    console.log('Kod column forced to text format');
  }
  
  // Apply styling
  applyFirsatlarimStyling(sheet);
  
  return sheet;
}

/**
 * Prepares opportunity row data
 * @param {Object} rowData - Original row data
 * @param {Object} opportunityData - Opportunity form data
 * @param {Array} columns - Column names
 * @param {Sheet} sheet - FÄ±rsatlarÄ±m sheet
 * @returns {Array} - Row data array
 */
function prepareOpportunityRow(rowData, opportunityData, columns, sheet) {
  console.log('Preparing opportunity row data');
  
  const row = new Array(columns.length).fill('');
  
  columns.forEach((column, index) => {
    switch (column) {
      case 'Kod':
        // Use original format
        row[index] = String(rowData.Kod || '');
        break;
      case 'Kaynak':
        // Use the source sheet name (Format Tablo) instead of target sheet name
        const activeSheet = SpreadsheetApp.getActiveSheet();
        const sheetName = activeSheet.getName();
        
        // For opportunities, the source is always the Format Tablo sheet
        row[index] = sheetName;
        break;
      case 'Keyword':
      case 'Location':
      case 'Company name':
      case 'Category':
      case 'Website':
      case 'Phone':
      case 'Address':
      case 'City':
      case 'Rating count':
        row[index] = rowData[column] || '';
        break;
      case 'Yetkili Tel':
        row[index] = opportunityData.yetkiliTel || '';
        break;
      case 'Mail':
        row[index] = opportunityData.mail || '';
        break;
      case 'Ä°sim Soyisim':
        row[index] = opportunityData.isimSoyisim || '';
        break;
      case 'FÄ±rsat Durumu':
        {
          let statusVal = (opportunityData.firsatDurumu || '').toString().trim();
          const lower = statusVal.toLowerCase();
          if (lower.includes('fÄ±rsat') && lower.includes('iletildi')) {
            statusVal = 'FÄ±rsat Ä°letildi';
          } else if (lower.includes('bilgi') && lower.includes('verildi')) {
            statusVal = 'Bilgi Verildi';
          } else if (lower.includes('yeniden') && lower.includes('aranacak')) {
            statusVal = 'Yeniden Aranacak';
          }
          row[index] = statusVal || 'Bilgi Verildi';
          console.log('ðŸ” Debug - FÄ±rsat Durumu set to:', row[index]);
          console.log('ðŸ” Debug - opportunityData.firsatDurumu:', opportunityData.firsatDurumu);
        }
        break;
      case 'FÄ±rsat Tarihi':
        // Format date as DD.MM.YYYY
        let firsatTarihi = opportunityData.firsatTarihi || '';
        if (firsatTarihi && firsatTarihi.includes('-')) {
          // Convert from YYYY-MM-DD to DD.MM.YYYY
          const parts = firsatTarihi.split('-');
          if (parts.length === 3) {
            firsatTarihi = `${parts[2]}.${parts[1]}.${parts[0]}`;
          }
        } else if (firsatTarihi instanceof Date) {
          const day = firsatTarihi.getDate().toString().padStart(2, '0');
          const month = (firsatTarihi.getMonth() + 1).toString().padStart(2, '0');
          const year = firsatTarihi.getFullYear();
          firsatTarihi = `${day}.${month}.${year}`;
        }
        row[index] = firsatTarihi;
        break;
      case 'Yorum':
        row[index] = opportunityData.yorum || '';
        break;

      case 'CMS AdÄ±':
      case 'CMS Grubu':
      case 'E-Ticaret Ä°zi':
      case 'Site HÄ±zÄ±':
      case 'Site TrafiÄŸi':
        row[index] = rowData[column] || '';
        break;
      case 'Log':
        row[index] = `FÄ±rsat oluÅŸturuldu - ${new Date().toLocaleString('tr-TR')}`;
        break;
      case 'ToplantÄ± formatÄ±':
        row[index] = opportunityData.toplantiFormat || 'Telefon';
        break;
      case 'Review':
        // Preserve Review as text to prevent date conversion
        row[index] = String(rowData[column] || '');
        break;
      case 'Maplink':
        // Preserve Maplink as text
        row[index] = String(rowData[column] || '');
        break;
    }
  });
  
  return row;
}

/**
 * Applies styling to FÄ±rsatlarÄ±m sheet
 * @param {Sheet} sheet - Target sheet
 */
function applyFirsatlarimStyling(sheet) {
  console.log('Applying FÄ±rsatlarÄ±m styling');
  
  // Header styling
  const headerRange = sheet.getRange(1, 1, 1, sheet.getLastColumn());
  headerRange.setBackground('#ffc107');
  headerRange.setFontColor('white');
  headerRange.setFontWeight('bold');
  
  // Freeze header row
  sheet.setFrozenRows(1);
  
  // Auto-resize columns
  sheet.autoResizeColumns(1, sheet.getLastColumn());
  
  // Manual column width adjustments for better readability
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  headers.forEach((header, index) => {
    const columnIndex = index + 1;
    switch (header) {
      case 'Kod':
        sheet.setColumnWidth(columnIndex, 120);
        break;
      case 'Company name':
        sheet.setColumnWidth(columnIndex, 200);
        break;
      case 'Phone':
      case 'Yetkili Tel':
        sheet.setColumnWidth(columnIndex, 130);
        break;
      case 'Mail':
        sheet.setColumnWidth(columnIndex, 180);
        break;
      case 'Ä°sim Soyisim':
        sheet.setColumnWidth(columnIndex, 150);
        break;
      case 'FÄ±rsat Tarihi':
        sheet.setColumnWidth(columnIndex, 120);
        break;
      case 'Yorum':
      case 'YÃ¶netici Not':
        sheet.setColumnWidth(columnIndex, 250);
        break;
      case 'Address':
        sheet.setColumnWidth(columnIndex, 300);
        break;
      case 'Website':
        sheet.setColumnWidth(columnIndex, 200);
        break;
      default:
        // Default width for other columns
        if (sheet.getColumnWidth(columnIndex) < 100) {
          sheet.setColumnWidth(columnIndex, 100);
        }
    }
  });
  
  // Add borders
  const dataRange = sheet.getDataRange();
  dataRange.setBorder(true, true, true, true, true, true);
  
  // Auto-sort by date (newest first)
  sortFirsatlarimByDate(sheet);
  
  console.log('FÄ±rsatlarÄ±m styling completed with optimized column widths and date sorting');
}

/**
 * Sets data validation for FÄ±rsatlarÄ±m sheet
 * @param {Sheet} sheet - Target sheet
 */
function setFirsatlarimDataValidation(sheet) {
  console.log('Setting FÄ±rsatlarÄ±m data validation');
  
  // If no sheet parameter provided, get the active sheet
  if (!sheet) {
    console.log('No sheet parameter provided, getting active sheet');
    try {
      sheet = SpreadsheetApp.getActiveSheet();
      console.log('Active sheet found:', sheet.getName());
    } catch (error) {
      console.error('Could not get active sheet:', error);
      throw new Error('No active sheet found. Please open a sheet first.');
    }
  }
  
  // Check if sheet parameter is valid
  if (!sheet) {
    console.error('Sheet parameter is undefined or null');
    throw new Error('Sheet parameter is required');
  }
  
  console.log('Sheet name:', sheet.getName());
  console.log('Sheet last row:', sheet.getLastRow());
  console.log('Sheet last column:', sheet.getLastColumn());
  
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  
  // Minimum 1000 rows for data validation
  const minRows = 1000;
  const currentRows = Math.max(2, sheet.getLastRow());
  const validationRows = Math.max(minRows, currentRows - 1);
  
  console.log(`Applying validation to ${validationRows} rows`);
  
  // FÄ±rsat Durumu validation (dropdown)
  const firsatDurumuIndex = headers.indexOf('FÄ±rsat Durumu') + 1;
  if (firsatDurumuIndex > 0) {
    // Use only FÄ±rsatlarÄ±m specific options (3 options only)
    const firsatDurumuOptions = [
      'Yeniden Aranacak',
      'Bilgi Verildi',
      'FÄ±rsat Ä°letildi'
    ];
    
    console.log('Setting FÄ±rsat Durumu validation with options:', firsatDurumuOptions);
    
    const firsatRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(firsatDurumuOptions, true)
      .setAllowInvalid(true) // GeÃ§ersiz deÄŸerlere izin ver
      .build();
    
    const validationRange = sheet.getRange(2, firsatDurumuIndex, validationRows, 1);
    
    // Force refresh validation
    validationRange.clearDataValidations();
    validationRange.setDataValidation(firsatRule);
    
    console.log('Applied FÄ±rsat Durumu validation to range:', validationRange.getA1Notation());
    console.log('Validation options:', firsatDurumuOptions);
  }
  
  // FÄ±rsat Tarihi validation (datepicker)
  const firsatTarihiIndex = headers.indexOf('FÄ±rsat Tarihi') + 1;
  if (firsatTarihiIndex > 0) {
    const tarihRule = SpreadsheetApp.newDataValidation()
      .requireDate()
      .setAllowInvalid(true) // GeÃ§ersiz deÄŸerlere izin ver
      .build();
    
    sheet.getRange(2, firsatTarihiIndex, validationRows, 1).setDataValidation(tarihRule);
    console.log('Applied FÄ±rsat Tarihi validation');
  }
  
  // ToplantÄ± formatÄ± validation (dropdown)
  const toplantiFormatIndex = headers.indexOf('ToplantÄ± formatÄ±') + 1;
  if (toplantiFormatIndex > 0) {
    const toplantiRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(CRM_CONFIG.MEETING_FORMAT_OPTIONS, true)
      .setAllowInvalid(true) // GeÃ§ersiz deÄŸerlere izin ver
      .build();
    
    sheet.getRange(2, toplantiFormatIndex, validationRows, 1).setDataValidation(toplantiRule);
    console.log('Applied ToplantÄ± formatÄ± validation');
  }
  
  console.log('FÄ±rsatlarÄ±m data validation completed');
}

/**
 * ðŸŽ¨ Opportunity Color Coding - Visual Status
 * @param {Sheet} sheet - FÄ±rsatlarÄ±m sheet
 * @param {number} rowNumber - Row number
 */
function applyOpportunityColorCoding(sheet, rowNumber) {
  console.log('ðŸŽ¨ Applying opportunity color coding to row:', rowNumber);
  
  try {
    if (!sheet || !rowNumber) {
      console.error('âŒ Invalid parameters for opportunity color coding');
      return;
    }
    
    // Get the status from the FÄ±rsat Durumu column
      const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const firsatDurumuIndex = findColumnIndex(headers, ['FÄ±rsat Durumu', 'FÄ±rsat durumu']);
  
  if (firsatDurumuIndex === -1) {
    console.error('âŒ FÄ±rsat Durumu column not found');
    console.log('Available headers:', headers);
    return;
  }
  
  const status = sheet.getRange(rowNumber, firsatDurumuIndex + 1).getValue();
    console.log('ðŸ“‹ Status found:', status, 'in row:', rowNumber, 'column:', firsatDurumuIndex + 1);
    
    let color = 'rgb(255, 255, 255)'; // Default white
    
    // Map status to color using centralized system
    if (status && status.toString().trim() !== '') {
      // Normalize status - remove any case issues or extra spaces
      const normalizedStatus = status.toString().trim();
      
      console.log('ðŸ” Looking for color for status:', normalizedStatus);
      console.log('Available colors in CRM_CONFIG:', Object.keys(CRM_CONFIG.COLOR_CODES));
      
      // Check exact match first
      if (CRM_CONFIG.COLOR_CODES[normalizedStatus]) {
        color = CRM_CONFIG.COLOR_CODES[normalizedStatus];
        console.log('âœ… Found exact color match:', color, 'for status:', normalizedStatus);
      }
      // Special handling for FÄ±rsat Ä°letildi with potential case/spelling variations
      else if (normalizedStatus.toLowerCase().includes('fÄ±rsat') && normalizedStatus.toLowerCase().includes('iletildi')) {
        color = CRM_CONFIG.COLOR_CODES['FÄ±rsat Ä°letildi'];
        console.log('âœ… Applied FÄ±rsat Ä°letildi color (fuzzy match):', color);
        // Not: HÃ¼cre deÄŸerini zorla dÃ¼zeltmiyoruz (validation Ã§atÄ±ÅŸmasÄ±nÄ± Ã¶nlemek iÃ§in)
      } else {
        console.log('âš ï¸ Unknown status:', normalizedStatus, '- using default white');
        console.log('Available statuses for opportunities:', ['Yeniden Aranacak', 'Bilgi Verildi', 'FÄ±rsat Ä°letildi']);
        console.log('ðŸ” Debug - CRM_CONFIG.COLOR_CODES keys:', Object.keys(CRM_CONFIG.COLOR_CODES));
        console.log('ðŸ” Debug - Looking for:', normalizedStatus);
      }
    } else {
      console.log('âš ï¸ Empty status - using default white');
    }
    
    // Apply color to entire row
    const range = sheet.getRange(rowNumber, 1, 1, sheet.getLastColumn());
    range.setBackground(color);
    
    console.log(`âœ… Applied color ${color} to row ${rowNumber} for status: ${status}`);
    
  } catch (error) {
    console.error('âŒ Error applying opportunity color coding:', error);
  }
}

/**
 * Shows add opportunity dialog
 */
function showAddOpportunityDialog() {
  console.log('Showing add opportunity dialog');
  addOpportunity({});
}

// ========================================
// FUNCTION 4: MOVE TO MEETING
// ========================================

/**
 * Moves confirmed appointment from RandevularÄ±m to ToplantÄ±larÄ±m
 * @param {Object} parameters - Function parameters
 * @returns {Object} - Result object
 */
function moveToMeeting(parameters = {}) {
  console.log('Function started: moveToMeeting', parameters);
  
  try {
    // Input validation - allow empty parameters for menu calls
    if (parameters && !validateInput(parameters)) {
      throw new Error('Invalid input provided');
    }
    
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const activeSheet = SpreadsheetApp.getActiveSheet();
    const activeRange = SpreadsheetApp.getActiveRange();
    
    // Check if we're on RandevularÄ±m sheet
    if (activeSheet.getName() !== 'RandevularÄ±m') {
      throw new Error('Bu iÅŸlem sadece RandevularÄ±m sayfasÄ±nda yapÄ±labilir');
    }
    
    // Check if a row is selected
    if (!activeRange || activeRange.getRow() === 1) {
      throw new Error('LÃ¼tfen bir satÄ±r seÃ§in (baÅŸlÄ±k satÄ±rÄ± hariÃ§)');
    }
    
    // Get selected row data
    const selectedRowData = getSelectedRowData(activeSheet, activeRange.getRow());
    const selectedRowNumber = activeRange.getRow();
    
    // Store row data and number globally before showing dialog
    SELECTED_ROW_DATA = selectedRowData;
    SELECTED_ROW_NUMBER = selectedRowNumber;
    console.log('ðŸ” Stored SELECTED_ROW_DATA in moveToMeeting:', SELECTED_ROW_DATA);
    console.log('ðŸ” Stored SELECTED_ROW_NUMBER in moveToMeeting:', SELECTED_ROW_NUMBER);
    
    // Check if appointment exists and has valid status
    if (!selectedRowData['Randevu durumu'] || 
        (selectedRowData['Randevu durumu'] !== 'Randevu AlÄ±ndÄ±' && 
         selectedRowData['Randevu durumu'] !== 'Randevu Teyitlendi')) {
      throw new Error('Sadece randevu alÄ±nmÄ±ÅŸ veya teyitlenmiÅŸ randevular toplantÄ±ya geÃ§ebilir');
    }
    
    // Check if already moved to meeting
    if (selectedRowData['ToplantÄ± Sonucu']) {
      throw new Error('Bu randevu zaten toplantÄ±ya geÃ§miÅŸ');
    }
    
    // Check if this row already exists in ToplantÄ±larÄ±m using Phone + Company name
    const toplantilarimSheet = spreadsheet.getSheetByName('ToplantÄ±larÄ±m');
    if (toplantilarimSheet) {
      const toplantilarimData = toplantilarimSheet.getDataRange().getValues();
      const toplantilarimHeaders = toplantilarimData[0];
      const phoneIndex = toplantilarimHeaders.indexOf('Phone');
      const companyIndex = toplantilarimHeaders.indexOf('Company name');
      
      if (companyIndex !== -1 && selectedRowData['Company name'] && selectedRowData['Company name'].toString().trim() !== '') {
        
        const selectedPhone = selectedRowData.Phone ? selectedRowData.Phone.toString().trim() : '';
        const selectedCompany = selectedRowData['Company name'].toString().trim();
        
        const existingMeeting = toplantilarimData.slice(1).find(row => {
          const rowPhone = row[phoneIndex];
          const rowCompany = row[companyIndex];
          
          const companyMatch = rowCompany && rowCompany.toString().trim() === selectedCompany;
          
          // EÄŸer telefon boÅŸsa sadece company name kontrol et
          let phoneMatch = true;
          if (selectedPhone !== '') {
            phoneMatch = rowPhone && rowPhone.toString().trim() === selectedPhone;
          }
          
          return phoneMatch && companyMatch;
        });
        
        if (existingMeeting) {
          throw new Error('Bu randevu zaten toplantÄ±ya geÃ§miÅŸ (ToplantÄ±larÄ±m sayfasÄ±nda mevcut)');
        }
      }
    }
    
    // Show meeting dialog directly
    showMeetingDialog(selectedRowData);
    
    // Since dialog doesn't return data, we'll handle the processing in the HTML dialog
    // The dialog will call processMeetingForm which will handle the rest
    return { success: true, message: 'ToplantÄ± dialog\'u aÃ§Ä±ldÄ±' };
    
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/**
 * Shows meeting dialog with pre-filled data
 * @param {Object} rowData - Selected row data
 * @returns {Object|null} - Meeting data or null if cancelled
 */
function showMeetingDialog(rowData) {
  console.log('Showing meeting dialog for:', rowData.Kod);
  console.log('Row data saat:', rowData['Saat']);
  console.log('Row data randevu tarihi:', rowData['Randevu Tarihi']);
  
  // SELECTED_ROW_DATA and SELECTED_ROW_NUMBER are already set in moveToMeeting function
  console.log('ðŸ” Using SELECTED_ROW_DATA:', SELECTED_ROW_DATA);
  console.log('ðŸ” Using SELECTED_ROW_NUMBER:', SELECTED_ROW_NUMBER);
  
  // Convert Randevu Tarihi to YYYY-MM-DD format for HTML date input
  let randevuTarihi = rowData['Randevu Tarihi'];
  if (randevuTarihi && typeof randevuTarihi === 'string' && randevuTarihi.includes('.')) {
    // Convert DD.MM.YYYY to YYYY-MM-DD
    const parts = randevuTarihi.split('.');
    if (parts.length === 3) {
      randevuTarihi = `${parts[2]}-${parts[1]}-${parts[0]}`;
    }
  } else if (randevuTarihi instanceof Date) {
    const year = randevuTarihi.getFullYear();
    const month = (randevuTarihi.getMonth() + 1).toString().padStart(2, '0');
    const day = randevuTarihi.getDate().toString().padStart(2, '0');
    randevuTarihi = `${year}-${month}-${day}`;
  }
  
  // Check and format saat if it's a date
  if (rowData['Saat'] && rowData['Saat'] instanceof Date) {
    console.log('Saat is a Date object, converting to time string');
    const saat = rowData['Saat'];
    const hours = saat.getHours().toString().padStart(2, '0');
    const minutes = saat.getMinutes().toString().padStart(2, '0');
    rowData['Saat'] = `${hours}:${minutes}`;
    console.log('Converted saat to:', rowData['Saat']);
  }
  
  const ui = SpreadsheetApp.getUi();
  
  // Create HTML template for dialog
  const htmlTemplate = HtmlService.createTemplateFromFile('meetingDialog');
  htmlTemplate.rowData = {
    ...rowData,
    'Randevu Tarihi': randevuTarihi
  };
  htmlTemplate.meetingFormats = CRM_CONFIG.MEETING_FORMAT_OPTIONS;
  htmlTemplate.rowNumber = SELECTED_ROW_NUMBER;
  htmlTemplate.sourceSheetName = SpreadsheetApp.getActiveSheet().getName();
  
  const htmlOutput = htmlTemplate.evaluate()
    .setWidth(700)
    .setHeight(600);
  
  // Show dialog and wait for user input
  ui.showModalDialog(htmlOutput, 'ToplantÄ±ya GeÃ§');
  
  // Since modal dialog doesn't return data directly, we need to use a different approach
  // The HTML dialog will call processMeetingForm via google.script.run
  // For now, return null to indicate dialog was shown
  return null;
}

/**
 * Creates meeting in ToplantÄ±larÄ±m sheet
 * @param {Spreadsheet} spreadsheet - Active spreadsheet
 * @param {Object} rowData - Original row data
 * @param {Object} meetingData - Meeting form data
 * @returns {Object} - Result object
 */
function createMeetingInToplantilarim(spreadsheet, rowData, meetingData) {
  console.log('Creating meeting in ToplantÄ±larÄ±m');
  
  let toplantilarimSheet = spreadsheet.getSheetByName('ToplantÄ±larÄ±m');
  
  // Create ToplantÄ±larÄ±m sheet if it doesn't exist
  if (!toplantilarimSheet) {
    toplantilarimSheet = createToplantilarimSheet(spreadsheet);
  }
  
  // Define ToplantÄ±larÄ±m columns based on sayfa_kolonlari.md - TAM uyumlu
  const toplantilarimColumns = [
    'Kod', 'Kaynak', 'Keyword', 'Location', 'Company name', 'Ä°sim Soyisim',
    'ToplantÄ± Sonucu', 'Teklif DetayÄ±', 'SatÄ±ÅŸ Potansiyeli', 'ToplantÄ± Tarihi', 'Yeni Takip Tarihi', 'ToplantÄ±yÄ± Yapan',
    'Category', 'Website', 'Phone', 'Yetkili Tel', 'Mail', 'Randevu durumu', 'Randevu Tarihi',
    'Saat', 'Yorum', 'YÃ¶netici Not', 'CMS AdÄ±', 'CMS Grubu', 'E-Ticaret Ä°zi',
    'Site HÄ±zÄ±', 'Site TrafiÄŸi', 'Log', 'ToplantÄ± formatÄ±', 'Address', 'City',
    'Rating count', 'Review'
  ];
  
  // Prepare meeting row data
  const meetingRow = prepareMeetingRow(rowData, meetingData, toplantilarimColumns, toplantilarimSheet);
  console.log('ðŸ” Prepared meeting row:', meetingRow);
  console.log('ðŸ” Meeting row length:', meetingRow.length);
  console.log('ðŸ” Columns length:', toplantilarimColumns.length);
  
  // Add to ToplantÄ±larÄ±m
  const nextRow = toplantilarimSheet.getLastRow() + 1;
  console.log('ðŸ” Adding to row:', nextRow);
  toplantilarimSheet.getRange(nextRow, 1, 1, toplantilarimColumns.length).setValues([meetingRow]);
  console.log('ðŸ” Data written to sheet');

  // Kaynak kolonunu metin formatÄ±nda zorla (dataset adÄ± bozulmasÄ±n)
  const kaynakIdx = toplantilarimColumns.indexOf('Kaynak') + 1;
  if (kaynakIdx > 0) {
    toplantilarimSheet.getRange(nextRow, kaynakIdx, 1, 1).setNumberFormat('@');
  }
  
  // Force Kod column to be text format to prevent int conversion
  const kodColumnIndex = toplantilarimColumns.indexOf('Kod') + 1;
  if (kodColumnIndex > 0) {
    toplantilarimSheet.getRange(nextRow, kodColumnIndex, 1, 1).setNumberFormat('@');
    console.log('Kod column forced to text format for new meeting');
  }
  
  // Wait a moment for data to be written
  Utilities.sleep(100);
  
  // Apply color coding
  console.log('ðŸŽ¨ Applying color coding to new meeting row:', nextRow);
  applyMeetingColorCoding(toplantilarimSheet, nextRow);
  
  // Activate ToplantÄ±larÄ±m sheet to show the new meeting
  toplantilarimSheet.activate();
  
  const result = {
    success: true,
    meetingId: rowData.Kod,
    message: `ToplantÄ± baÅŸarÄ±yla oluÅŸturuldu: ${rowData['Company name']} - ToplantÄ±larÄ±m sayfasÄ±na yÃ¶nlendiriliyorsunuz`
  };
  
  console.log('Meeting created successfully:', result);
  return result;
}

/**
 * Creates ToplantÄ±larÄ±m sheet with proper structure
 * @param {Spreadsheet} spreadsheet - Active spreadsheet
 * @returns {Sheet} - Created sheet
 */
function createToplantilarimSheet(spreadsheet) {
  console.log('Creating ToplantÄ±larÄ±m sheet');
  
  const sheet = spreadsheet.insertSheet('ToplantÄ±larÄ±m');
  
  // Define columns - sayfa_kolonlari.md ile TAM uyumlu sÄ±ralama
  const columns = [
    'Kod', 'Kaynak', 'Keyword', 'Location', 'Company name', 'Ä°sim Soyisim',
    'ToplantÄ± Sonucu', 'Teklif DetayÄ±', 'SatÄ±ÅŸ Potansiyeli', 'ToplantÄ± Tarihi', 'Yeni Takip Tarihi', 'ToplantÄ±yÄ± Yapan',
    'Category', 'Website', 'Phone', 'Yetkili Tel', 'Mail', 'Randevu durumu', 'Randevu Tarihi',
    'Saat', 'Yorum', 'YÃ¶netici Not', 'CMS AdÄ±', 'CMS Grubu', 'E-Ticaret Ä°zi',
    'Site HÄ±zÄ±', 'Site TrafiÄŸi', 'Log', 'ToplantÄ± formatÄ±', 'Address', 'City',
    'Rating count', 'Review'
  ];
  
  // Set headers
  sheet.getRange(1, 1, 1, columns.length).setValues([columns]);
  
  // Force Kod column to be text format
  const kodColumnIndex = columns.indexOf('Kod') + 1;
  if (kodColumnIndex > 0) {
    sheet.getRange(1, kodColumnIndex, 1000, 1).setNumberFormat('@');
    console.log('Kod column forced to text format');
  }
  
  // Apply styling
  applyToplantilarimStyling(sheet);
  
  return sheet;
}

/**
 * Mevcut ToplantÄ±larÄ±m sayfasÄ±nÄ± sayfa_kolonlari.md ile uyumlu hale getir
 */
function fixToplantilarimColumnOrder() {
  console.log('Function started: fixToplantilarimColumnOrder');
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = spreadsheet.getSheetByName('ToplantÄ±larÄ±m');
    
    if (!sheet) {
      SpreadsheetApp.getUi().alert('Hata', 'ToplantÄ±larÄ±m sayfasÄ± bulunamadÄ±!', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    // Yeni sÃ¼tun sÄ±ralamasÄ± - sayfa_kolonlari.md ile TAM uyumlu
    const newColumns = [
      'Kod', 'Kaynak', 'Keyword', 'Location', 'Company name', 'Ä°sim Soyisim',
      'ToplantÄ± Sonucu', 'Teklif DetayÄ±', 'SatÄ±ÅŸ Potansiyeli', 'ToplantÄ± Tarihi', 'Yeni Takip Tarihi', 'ToplantÄ±yÄ± Yapan',
      'Category', 'Website', 'Phone', 'Yetkili Tel', 'Mail', 'Randevu durumu', 'Randevu Tarihi',
      'Saat', 'Yorum', 'YÃ¶netici Not', 'CMS AdÄ±', 'CMS Grubu', 'E-Ticaret Ä°zi',
      'Site HÄ±zÄ±', 'Site TrafiÄŸi', 'Log', 'ToplantÄ± formatÄ±', 'Address', 'City',
      'Rating count', 'Review'
    ];
    
    // Mevcut baÅŸlÄ±klarÄ± al
    const currentHeaders = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getDisplayValues()[0];
    console.log('Mevcut baÅŸlÄ±klar:', currentHeaders);
    
    // Yeni sÃ¼tun sÄ±ralamasÄ±nÄ± uygula
    sheet.getRange(1, 1, 1, newColumns.length).setValues([newColumns]);
    
    // Kod sÃ¼tununu text formatÄ±na zorla
    const kodColumnIndex = newColumns.indexOf('Kod') + 1;
    if (kodColumnIndex > 0) {
      sheet.getRange(1, kodColumnIndex, 1000, 1).setNumberFormat('@');
      console.log('Kod column forced to text format');
    }
    
    // Styling'i yeniden uygula
    applyToplantilarimStyling(sheet);
    
    const message = `âœ… ToplantÄ±larÄ±m sayfasÄ± dÃ¼zenlendi!\n\nðŸ“‹ Yeni sÃ¼tun sÄ±ralamasÄ±:\n${newColumns.join(', ')}`;
    SpreadsheetApp.getUi().alert('âœ… BaÅŸarÄ±lÄ±', message, SpreadsheetApp.getUi().ButtonSet.OK);
    
    console.log('ToplantÄ±larÄ±m sayfasÄ± sÃ¼tun sÄ±ralamasÄ± dÃ¼zenlendi');
    
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('âŒ Hata', `SÃ¼tun dÃ¼zenleme hatasÄ±: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * Prepares meeting row data
 * @param {Object} rowData - Original row data
 * @param {Object} meetingData - Meeting form data
 * @param {Array} columns - Column names
 * @param {Sheet} sheet - ToplantÄ±larÄ±m sheet
 * @returns {Array} - Row data array
 */
function prepareMeetingRow(rowData, meetingData, columns, sheet) {
  console.log('Preparing meeting row data');
  console.log('ðŸ” rowData.Kod:', rowData.Kod);
  console.log('ðŸ” meetingData:', meetingData);
  
  const row = new Array(columns.length).fill('');
  
  columns.forEach((column, index) => {
    switch (column) {
      case 'Kod':
        // Use original format
        row[index] = String(rowData.Kod || '');
        console.log('ðŸ” rowData.Kod:', rowData.Kod);
        console.log('ðŸ” Kod set to:', row[index]);
        console.log('ðŸ” Kod index:', index);
        break;
      case 'Kaynak':
        // Kaynak: RandevularÄ±m satÄ±rÄ±ndaki orijinal dataset adÄ± varsa onu taÅŸÄ±
        if (rowData.Kaynak && rowData.Kaynak.toString().trim() !== '') {
          row[index] = rowData.Kaynak;
        } else {
          row[index] = 'RandevularÄ±m';
        }
        break;
      case 'Keyword':
      case 'Location':
      case 'Company name':
      case 'Category':
      case 'Website':
      case 'Phone':
      case 'Address':
      case 'City':
      case 'Rating count':
        row[index] = rowData[column] || '';
        break;
      case 'Yetkili Tel':
      case 'Mail':
      case 'Ä°sim Soyisim':
        row[index] = rowData[column] || '';
        break;
      case 'Randevu durumu':
        row[index] = rowData['Randevu durumu'] || '';
        break;
      case 'Randevu Tarihi':
        row[index] = rowData['Randevu Tarihi'] || '';
        break;
      case 'Saat':
        // Ensure saat is a string, not a date
        let saatValue = rowData['Saat'] || '';
        if (saatValue instanceof Date) {
          const hours = saatValue.getHours().toString().padStart(2, '0');
          const minutes = saatValue.getMinutes().toString().padStart(2, '0');
          saatValue = `${hours}:${minutes}`;
          console.log('Converted saat from Date to string:', saatValue);
        }
        row[index] = saatValue;
        break;
      case 'Yorum':
        row[index] = meetingData.yorum || rowData['Yorum'] || '';
        break;
      case 'YÃ¶netici Not':
        row[index] = meetingData.yoneticiNot || rowData['YÃ¶netici Not'] || '';
        break;
      case 'CMS AdÄ±':
      case 'CMS Grubu':
      case 'E-Ticaret Ä°zi':
      case 'Site HÄ±zÄ±':
      case 'Site TrafiÄŸi':
        row[index] = rowData[column] || '';
        break;
      case 'Log':
        row[index] = `ToplantÄ±ya geÃ§ildi - ${new Date().toLocaleString('tr-TR')}`;
        break;
      case 'ToplantÄ± formatÄ±':
        row[index] = meetingData.toplantiFormat || rowData['ToplantÄ± formatÄ±'] || 'YÃ¼z YÃ¼ze';
        break;
      case 'ToplantÄ± Sonucu':
        row[index] = meetingData.toplantiSonucu || '';
        break;
      case 'Teklif DetayÄ±':
        row[index] = meetingData.teklifDetayi || '';
        break;
      case 'SatÄ±ÅŸ Potansiyeli':
        row[index] = meetingData.satisPotansiyeli || '';
        break;
      case 'ToplantÄ± Tarihi':
        // Format date as DD.MM.YYYY
        let toplantiTarihi = meetingData.toplantiTarihi || '';
        if (toplantiTarihi && toplantiTarihi.includes('-')) {
          // Convert from YYYY-MM-DD to DD.MM.YYYY
          const parts = toplantiTarihi.split('-');
          if (parts.length === 3) {
            toplantiTarihi = `${parts[2]}.${parts[1]}.${parts[0]}`;
          }
        }
        row[index] = toplantiTarihi;
        break;
      case 'Yeni Takip Tarihi':
        // Format date as DD.MM.YYYY
        let yeniTakipTarihi = meetingData.yeniTakipTarihi || '';
        if (yeniTakipTarihi && yeniTakipTarihi.includes('-')) {
          // Convert from YYYY-MM-DD to DD.MM.YYYY
          const parts = yeniTakipTarihi.split('-');
          if (parts.length === 3) {
            yeniTakipTarihi = `${parts[2]}.${parts[1]}.${parts[0]}`;
          }
        }
        row[index] = yeniTakipTarihi;
        break;
      case 'ToplantÄ±yÄ± Yapan':
        row[index] = meetingData.toplantiyiYapan || getCurrentEmployeeCode() || '';
        break;
    }
  });
  
  return row;
}

/**
 * Updates RandevularÄ±m row with meeting data
 * @param {Sheet} sheet - RandevularÄ±m sheet
 * @param {number} rowNumber - Row number
 * @param {Object} meetingData - Meeting data
 */
function updateRandevularimRow(sheet, rowNumber, meetingData) {
  console.log('Updating RandevularÄ±m row with meeting data');
  
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const toplantiSonucIndex = headers.indexOf('ToplantÄ± Sonucu') + 1;
  const toplantiTarihiIndex = headers.indexOf('ToplantÄ± Tarihi') + 1;
  const logIndex = headers.indexOf('Log') + 1;
  
  // Update meeting result
  if (toplantiSonucIndex > 0) {
    sheet.getRange(rowNumber, toplantiSonucIndex).setValue(meetingData.toplantiSonucu || '');
  }
  
  // Update meeting date
  if (toplantiTarihiIndex > 0) {
    sheet.getRange(rowNumber, toplantiTarihiIndex).setValue(meetingData.toplantiTarihi || new Date());
  }
  
  // Update log
  if (logIndex > 0) {
    const currentLog = sheet.getRange(rowNumber, logIndex).getValue();
    const newLog = `ToplantÄ±ya geÃ§ildi - ${new Date().toLocaleString('tr-TR')}`;
    sheet.getRange(rowNumber, logIndex).setValue(newLog);
  }
  
  // Apply color coding after updating meeting data
  const status = sheet.getRange(rowNumber, headers.indexOf('Randevu durumu') + 1).getDisplayValue();
  updateRandevularimRowColor(sheet, rowNumber, status);
  console.log('ðŸŽ¨ RandevularÄ±m renklendirme uygulandÄ±');
}

/**
 * Applies styling to ToplantÄ±larÄ±m sheet
 * @param {Sheet} sheet - Target sheet
 */
function applyToplantilarimStyling(sheet) {
  console.log('Applying ToplantÄ±larÄ±m styling');
  
  // Header styling
  const headerRange = sheet.getRange(1, 1, 1, sheet.getLastColumn());
  headerRange.setBackground('#17a2b8');
  headerRange.setFontColor('white');
  headerRange.setFontWeight('bold');
  
  // Freeze header row
  sheet.setFrozenRows(1);
  
  // Auto-resize columns
  sheet.autoResizeColumns(1, sheet.getLastColumn());
  
  // Manual column width adjustments for better readability
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  headers.forEach((header, index) => {
    const columnIndex = index + 1;
    switch (header) {
      case 'Kod':
        sheet.setColumnWidth(columnIndex, 120);
        break;
      case 'Company name':
        sheet.setColumnWidth(columnIndex, 200);
        break;
      case 'Phone':
      case 'Yetkili Tel':
        sheet.setColumnWidth(columnIndex, 130);
        break;
      case 'Mail':
        sheet.setColumnWidth(columnIndex, 180);
        break;
      case 'Ä°sim Soyisim':
        sheet.setColumnWidth(columnIndex, 150);
        break;
      case 'Randevu Tarihi':
      case 'ToplantÄ± Tarihi':
      case 'Yeni Takip Tarihi':
        sheet.setColumnWidth(columnIndex, 120);
        break;
      case 'Saat':
        sheet.setColumnWidth(columnIndex, 80);
        break;
      case 'Yorum':
      case 'YÃ¶netici Not':
      case 'Teklif DetayÄ±':
        sheet.setColumnWidth(columnIndex, 250);
        break;
      case 'Address':
        sheet.setColumnWidth(columnIndex, 300);
        break;
      case 'Website':
        sheet.setColumnWidth(columnIndex, 200);
        break;
      default:
        // Default width for other columns
        if (sheet.getColumnWidth(columnIndex) < 100) {
          sheet.setColumnWidth(columnIndex, 100);
        }
    }
  });
  
  // Add borders
  const dataRange = sheet.getDataRange();
  dataRange.setBorder(true, true, true, true, true, true);
  
  console.log('ToplantÄ±larÄ±m styling completed with optimized column widths');
}

/**
 * Sets data validation for ToplantÄ±larÄ±m sheet
 * @param {Sheet} sheet - Target sheet
 */
function setToplantilarimDataValidation(sheet) {
  console.log('Setting ToplantÄ±larÄ±m data validation');
  
  // If no sheet parameter provided, get the active sheet
  if (!sheet) {
    console.log('No sheet parameter provided, getting active sheet');
    try {
      sheet = SpreadsheetApp.getActiveSheet();
      console.log('Active sheet found:', sheet.getName());
    } catch (error) {
      console.error('Could not get active sheet:', error);
      throw new Error('No active sheet found. Please open a sheet first.');
    }
  }
  
  // Check if sheet parameter is valid
  if (!sheet) {
    console.error('Sheet parameter is undefined or null');
    throw new Error('Sheet parameter is required');
  }
  
  console.log('Sheet name:', sheet.getName());
  console.log('Sheet last row:', sheet.getLastRow());
  console.log('Sheet last column:', sheet.getLastColumn());
  
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  
  // Minimum 1000 rows for data validation
  const minRows = 1000;
  const currentRows = Math.max(2, sheet.getLastRow());
  const validationRows = Math.max(minRows, currentRows - 1);
  
  console.log(`Applying validation to ${validationRows} rows`);
  
  // Randevu durumu validation (dropdown) - ToplantÄ±larÄ±m'da RandevularÄ±m ile aynÄ±
  const randevuDurumuIndex = headers.indexOf('Randevu durumu') + 1;
  if (randevuDurumuIndex > 0) {
    const randevuDurumuOptions = ['Randevu AlÄ±ndÄ±', 'Ä°leri Tarih Randevu', 'Randevu Teyitlendi', 'Randevu Ertelendi', 'Randevu Ä°ptal oldu'];
    const randevuRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(randevuDurumuOptions, true)
      .setAllowInvalid(false)
      .build();
    
    sheet.getRange(2, randevuDurumuIndex, validationRows, 1).setDataValidation(randevuRule);
    console.log('Applied ToplantÄ±larÄ±m Randevu durumu validation');
  }
  
  // Randevu Tarihi validation (datepicker)
  const randevuTarihiIndex = headers.indexOf('Randevu Tarihi') + 1;
  if (randevuTarihiIndex > 0) {
    const tarihRule = SpreadsheetApp.newDataValidation()
      .requireDate()
      .setAllowInvalid(false)
      .build();
    
    sheet.getRange(2, randevuTarihiIndex, validationRows, 1).setDataValidation(tarihRule);
    console.log('Applied Randevu Tarihi validation');
  }
  
  // Saat validation (time picker)
  const saatIndex = headers.indexOf('Saat') + 1;
  if (saatIndex > 0) {
    const saatOptions = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00'];
    const saatRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(saatOptions, true)
      .setAllowInvalid(false)
      .build();
    
    sheet.getRange(2, saatIndex, validationRows, 1).setDataValidation(saatRule);
    console.log('Applied Saat validation');
  }
  
  // ToplantÄ± Sonucu validation
  const toplantiSonucIndex = headers.indexOf('ToplantÄ± Sonucu') + 1;
  if (toplantiSonucIndex > 0) {
    const sonucOptions = ['SatÄ±ÅŸ YapÄ±ldÄ±', 'Teklif iletildi', 'Beklemede', 'SatÄ±ÅŸ Ä°ptal'];
    const sonucRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(sonucOptions, true)
      .setAllowInvalid(false)
      .build();
    
    sheet.getRange(2, toplantiSonucIndex, validationRows, 1).setDataValidation(sonucRule);
    console.log('Applied ToplantÄ± Sonucu validation');
  }
  
  // Teklif DetayÄ± validation
  const teklifDetayIndex = headers.indexOf('Teklif DetayÄ±') + 1;
  if (teklifDetayIndex > 0) {
    const teklifOptions = [
      'Custom', 'Elite', 'Platinium Plus', 'Platinium', 'Entegre',
      'Digifirst Custom', 'Digifirst Plus', 'Digifirst', 'Digifirst Setup'
    ];
    const teklifRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(teklifOptions, true)
      .setAllowInvalid(false)
      .build();
    
    sheet.getRange(2, teklifDetayIndex, validationRows, 1).setDataValidation(teklifRule);
    console.log('Applied Teklif DetayÄ± validation');
  }
  
  // SatÄ±ÅŸ Potansiyeli validation
  const satisPotansiyelIndex = headers.indexOf('SatÄ±ÅŸ Potansiyeli') + 1;
  if (satisPotansiyelIndex > 0) {
    const potansiyelOptions = ['Yerinde SatÄ±ÅŸ', 'SÄ±cak', 'Orta', 'SoÄŸuk'];
    const potansiyelRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(potansiyelOptions, true)
      .setAllowInvalid(false)
      .build();
    
    sheet.getRange(2, satisPotansiyelIndex, validationRows, 1).setDataValidation(potansiyelRule);
    console.log('Applied SatÄ±ÅŸ Potansiyeli validation');
  }
  
  // ToplantÄ± formatÄ± validation
  const toplantiFormatIndex = headers.indexOf('ToplantÄ± formatÄ±') + 1;
  if (toplantiFormatIndex > 0) {
    const toplantiRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(CRM_CONFIG.MEETING_FORMAT_OPTIONS, true)
      .setAllowInvalid(false)
      .build();
    
    sheet.getRange(2, toplantiFormatIndex, validationRows, 1).setDataValidation(toplantiRule);
    console.log('Applied ToplantÄ± formatÄ± validation');
  }
  
  // ToplantÄ± Tarihi validation (datepicker)
  const toplantiTarihiIndex = headers.indexOf('ToplantÄ± Tarihi') + 1;
  if (toplantiTarihiIndex > 0) {
    const toplantiTarihRule = SpreadsheetApp.newDataValidation()
      .requireDate()
      .setAllowInvalid(false)
      .build();
    
    sheet.getRange(2, toplantiTarihiIndex, validationRows, 1).setDataValidation(toplantiTarihRule);
    console.log('Applied ToplantÄ± Tarihi validation');
  }
  
  // Yeni Takip Tarihi validation (datepicker)
  const yeniTakipTarihiIndex = headers.indexOf('Yeni Takip Tarihi') + 1;
  if (yeniTakipTarihiIndex > 0) {
    const takipTarihRule = SpreadsheetApp.newDataValidation()
      .requireDate()
      .setAllowInvalid(false)
      .build();
    
    sheet.getRange(2, yeniTakipTarihiIndex, validationRows, 1).setDataValidation(takipTarihRule);
    console.log('Applied Yeni Takip Tarihi validation');
  }
  
  console.log('ToplantÄ±larÄ±m data validation completed');
}

/**
 * ðŸŽ¨ Meeting Color Coding - Visual Status
 * @param {Sheet} sheet - ToplantÄ±larÄ±m sheet
 * @param {number} rowNumber - Row number
 */
function applyMeetingColorCoding(sheet, rowNumber) {
  console.log('ðŸŽ¨ Applying meeting color coding to row:', rowNumber);
  
  try {
    if (!sheet || !rowNumber) {
      console.error('âŒ Invalid parameters for meeting color coding');
      return;
    }
    
    // Get headers
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getDisplayValues()[0];
    console.log('ðŸŽ¨ Headers found:', headers);
    let color = 'rgb(255, 255, 255)'; // Default white
    
    // Check ToplantÄ± Sonucu first
    const toplantiSonucuIndex = headers.indexOf('ToplantÄ± Sonucu');
    if (toplantiSonucuIndex !== -1) {
      const toplantiSonucu = String(sheet.getRange(rowNumber, toplantiSonucuIndex + 1).getDisplayValue() || '').trim();
      const toplantiSonucuLower = toplantiSonucu.toLowerCase();
      
      console.log(`ðŸŽ¨ ToplantÄ±larÄ±m Row ${rowNumber}: ToplantÄ± Sonucu="${toplantiSonucu}"`);
      
      if (toplantiSonucu && toplantiSonucu !== '') {
        if (toplantiSonucu === 'SatÄ±ÅŸ YapÄ±ldÄ±') {
          color = CRM_CONFIG.COLOR_CODES['SatÄ±ÅŸ YapÄ±ldÄ±'];
          console.log(`ðŸŽ¨ ToplantÄ±larÄ±m Row ${rowNumber}: SatÄ±ÅŸ YapÄ±ldÄ± color applied`);
        } else if (toplantiSonucu === 'Teklif iletildi' || toplantiSonucuLower.indexOf('teklif') !== -1) {
          color = CRM_CONFIG.COLOR_CODES['ToplantÄ± Teklif'];
          console.log(`ðŸŽ¨ ToplantÄ±larÄ±m Row ${rowNumber}: Teklif iletildi color applied`);
        } else if (toplantiSonucuLower.indexOf('beklemede') !== -1) {
          color = CRM_CONFIG.COLOR_CODES['ToplantÄ± Beklemede'];
          console.log(`ðŸŽ¨ ToplantÄ±larÄ±m Row ${rowNumber}: ToplantÄ± Beklemede color applied`);
        } else if (toplantiSonucuLower.indexOf('iptal') !== -1) {
          color = CRM_CONFIG.COLOR_CODES['ToplantÄ± Ä°ptal'];
          console.log(`ðŸŽ¨ ToplantÄ±larÄ±m Row ${rowNumber}: ToplantÄ± Ä°ptal color applied`);
        } else {
          color = CRM_CONFIG.COLOR_CODES['ToplantÄ± TamamlandÄ±'];
          console.log(`ðŸŽ¨ ToplantÄ±larÄ±m Row ${rowNumber}: ToplantÄ± TamamlandÄ± color applied`);
        }
      } else {
        // ToplantÄ± Sonucu boÅŸsa SatÄ±ÅŸ Potansiyeli'ne bak
        const satisPotansiyeliIndex = headers.indexOf('SatÄ±ÅŸ Potansiyeli');
        if (satisPotansiyeliIndex !== -1) {
          const satisPotansiyeli = String(sheet.getRange(rowNumber, satisPotansiyeliIndex + 1).getDisplayValue() || '').trim().toLowerCase();
          
          console.log(`ðŸŽ¨ ToplantÄ±larÄ±m Row ${rowNumber}: SatÄ±ÅŸ Potansiyeli="${satisPotansiyeli}"`);
          
          if (satisPotansiyeli === 'yerinde satÄ±ÅŸ' || satisPotansiyeli === 'yerinde satis') {
            color = CRM_CONFIG.COLOR_CODES['SatÄ±ÅŸ YapÄ±ldÄ±'];
            console.log(`ðŸŽ¨ ToplantÄ±larÄ±m Row ${rowNumber}: Yerinde SatÄ±ÅŸ color applied`);
          } else if (satisPotansiyeli === 'sÄ±cak' || satisPotansiyeli === 'sicak') {
            color = CRM_CONFIG.COLOR_CODES['Potansiyel SÄ±cak'];
            console.log(`ðŸŽ¨ ToplantÄ±larÄ±m Row ${rowNumber}: SÄ±cak color applied`);
          } else if (satisPotansiyeli === 'orta') {
            color = CRM_CONFIG.COLOR_CODES['Potansiyel Orta'];
            console.log(`ðŸŽ¨ ToplantÄ±larÄ±m Row ${rowNumber}: Orta color applied`);
          } else if (satisPotansiyeli === 'soÄŸuk' || satisPotansiyeli === 'soguk') {
            color = CRM_CONFIG.COLOR_CODES['Potansiyel SoÄŸuk'];
            console.log(`ðŸŽ¨ ToplantÄ±larÄ±m Row ${rowNumber}: SoÄŸuk color applied`);
          } else {
            color = CRM_CONFIG.COLOR_CODES['ToplantÄ± TamamlandÄ±'];
            console.log(`ðŸŽ¨ ToplantÄ±larÄ±m Row ${rowNumber}: Default color applied`);
          }
        } else {
          color = CRM_CONFIG.COLOR_CODES['ToplantÄ± TamamlandÄ±'];
          console.log(`ðŸŽ¨ ToplantÄ±larÄ±m Row ${rowNumber}: Default color applied (no SatÄ±ÅŸ Potansiyeli)`);
        }
      }
    }
    
    const range = sheet.getRange(rowNumber, 1, 1, sheet.getLastColumn());
    console.log('ðŸŽ¨ Range to color:', range.getA1Notation());
    console.log('ðŸŽ¨ Color to apply:', color);
    range.setBackground(color);
    
    console.log(`âœ… Applied meeting color ${color} to row ${rowNumber}`);
    console.log('ðŸŽ¨ Final range background:', range.getBackground());
    
  } catch (error) {
    console.error('âŒ Error applying meeting color coding:', error);
  }
}

/**
 * Fix data validation for existing sheets
 */
function fixDataValidationForExistingSheets() {
  console.log('ðŸ”§ Fixing data validation for existing sheets...');
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    let fixedSheets = [];
    
    // Fix RandevularÄ±m sheet
    const randevularimSheet = spreadsheet.getSheetByName('RandevularÄ±m');
    if (randevularimSheet) {
      console.log('ðŸ”§ Fixing RandevularÄ±m data validation...');
      
      // Clear existing validation first
      const range = randevularimSheet.getRange(2, 1, 1000, randevularimSheet.getLastColumn());
      range.clearDataValidations();
      console.log('ðŸ§¹ Cleared existing validations');
      
      // Apply new validation
      setRandevularimDataValidation(randevularimSheet);
      console.log('âœ… RandevularÄ±m data validation fixed');
      fixedSheets.push('RandevularÄ±m');
    } else {
      console.log('âš ï¸ RandevularÄ±m sheet not found');
    }
    
    // Fix ToplantÄ±larÄ±m sheet
    const toplantilarimSheet = spreadsheet.getSheetByName('ToplantÄ±larÄ±m');
    if (toplantilarimSheet) {
      console.log('ðŸ”§ Fixing ToplantÄ±larÄ±m data validation...');
      
      // Clear existing validation first
      const range = toplantilarimSheet.getRange(2, 1, 1000, toplantilarimSheet.getLastColumn());
      range.clearDataValidations();
      console.log('ðŸ§¹ Cleared existing validations');
      
      // Apply new validation
      setToplantilarimDataValidation(toplantilarimSheet);
      console.log('âœ… ToplantÄ±larÄ±m data validation fixed');
      fixedSheets.push('ToplantÄ±larÄ±m');
    } else {
      console.log('âš ï¸ ToplantÄ±larÄ±m sheet not found');
    }
    
    // Fix FÄ±rsatlarÄ±m sheet
    const firsatlarimSheet = spreadsheet.getSheetByName('FÄ±rsatlarÄ±m');
    if (firsatlarimSheet) {
      console.log('ðŸ”§ Fixing FÄ±rsatlarÄ±m data validation...');
      
      // Clear existing validation first
      const range = firsatlarimSheet.getRange(2, 1, 1000, firsatlarimSheet.getLastColumn());
      range.clearDataValidations();
      console.log('ðŸ§¹ Cleared existing validations');
      
      // Apply new validation
      setFirsatlarimDataValidation(firsatlarimSheet);
      console.log('âœ… FÄ±rsatlarÄ±m data validation fixed');
      fixedSheets.push('FÄ±rsatlarÄ±m');
    } else {
      console.log('âš ï¸ FÄ±rsatlarÄ±m sheet not found');
    }
    
    const message = `âœ… Data validation dÃ¼zeltildi!\n\nðŸ“‹ DÃ¼zeltilen sayfalar:\n${fixedSheets.map(s => `â€¢ ${s}`).join('\n')}\n\nðŸŽ¯ ArtÄ±k dropdown ve datepicker'lar Ã§alÄ±ÅŸacak!\n\nðŸ’¡ Test etmek iÃ§in:\nâ€¢ Randevu durumu sÃ¼tununa tÄ±klayÄ±n\nâ€¢ Randevu Tarihi sÃ¼tununa tÄ±klayÄ±n\nâ€¢ Saat sÃ¼tununa tÄ±klayÄ±n`;
    SpreadsheetApp.getUi().alert('âœ… BaÅŸarÄ±lÄ±', message, SpreadsheetApp.getUi().ButtonSet.OK);
    
  } catch (error) {
    console.error('âŒ Data validation fix failed:', error);
    SpreadsheetApp.getUi().alert('âŒ Hata', `Data validation dÃ¼zeltme hatasÄ±: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * Fix ONLY RandevularÄ±m data validation
 */
function fixRandevularimOnly() {
  console.log('ðŸ”§ Fixing ONLY RandevularÄ±m data validation...');
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const randevularimSheet = spreadsheet.getSheetByName('RandevularÄ±m');
    
    if (!randevularimSheet) {
      console.error('âŒ RandevularÄ±m sheet not found');
      SpreadsheetApp.getUi().alert('âŒ Hata', 'RandevularÄ±m sayfasÄ± bulunamadÄ±!', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    console.log('ðŸ”§ Found RandevularÄ±m sheet, applying validation...');
    
    // Clear existing validation first
    const range = randevularimSheet.getRange(2, 1, 1000, randevularimSheet.getLastColumn());
    range.clearDataValidations();
    console.log('ðŸ§¹ Cleared existing validations');
    
    // Apply new validation
    setRandevularimDataValidation(randevularimSheet);
    console.log('âœ… RandevularÄ±m data validation applied');
    
    SpreadsheetApp.getUi().alert('âœ… BaÅŸarÄ±lÄ±', 'RandevularÄ±m sayfasÄ±nda dropdown ve datepicker\'lar aktif edildi!', SpreadsheetApp.getUi().ButtonSet.OK);
    
  } catch (error) {
    console.error('âŒ RandevularÄ±m validation fix failed:', error);
    SpreadsheetApp.getUi().alert('âŒ Hata', `RandevularÄ±m validation hatasÄ±: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * Shows move to meeting dialog
 */
function showMoveToMeetingDialog() {
  console.log('Showing move to meeting dialog');
  moveToMeeting({});
}

/**
 * Processes meeting form data from HTML dialog
 * @param {Object} formData - Form data from HTML
 * @returns {Object} - Result object
 */
function processMeetingForm(formData, selectedRowData = null, rowNumber = null) {
  console.log('Processing meeting form data:', formData);
  
  try {
    // Validate form data
    if (!formData.toplantiTarihi) {
      throw new Error('ToplantÄ± tarihi zorunludur');
    }
    
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
      // Use provided row data or fall back to stored data
  let rowData = selectedRowData;
  let rowNum = rowNumber;
  
  if (!rowData || !rowNum) {
    console.log('ðŸ” Using stored data as fallback');
    rowData = SELECTED_ROW_DATA;
    rowNum = SELECTED_ROW_NUMBER;
  }
  
  // As a final fallback, if formData contains explicit context, use it
  if ((!rowData || !rowNum) && formData && (formData.rowNumber || formData.sourceSheet)) {
    try {
      const explicitRow = Number(formData.rowNumber || 0);
      const explicitSheetName = String(formData.sourceSheet || '');
      if (explicitRow && explicitRow !== 1 && explicitSheetName) {
        const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(explicitSheetName) || SpreadsheetApp.getActiveSheet();
        if (sheet) {
          console.log('ðŸ”Ž Reconstructing row from formData context:', explicitRow, explicitSheetName);
          rowData = getSelectedRowData(sheet, explicitRow);
          rowNum = explicitRow;
        }
      }
    } catch (e) {
      console.log('âš ï¸ Fallback reconstruct error:', e && e.message);
    }
  }
  
  console.log('ðŸ” Using row data:', rowData);
  console.log('ðŸ” Using row number:', rowNum);
    
    if (!rowData) {
      throw new Error('SeÃ§ili satÄ±r verisi bulunamadÄ±. LÃ¼tfen tekrar deneyin.');
    }
    
    if (!rowNum) {
      throw new Error('SeÃ§ili satÄ±r numarasÄ± bulunamadÄ±. LÃ¼tfen tekrar deneyin.');
    }
    
    // Create meeting in ToplantÄ±larÄ±m
    const result = createMeetingInToplantilarim(spreadsheet, rowData, formData);
    
    // Update RandevularÄ±m row if it exists
    const randevularimSheet = spreadsheet.getSheetByName('RandevularÄ±m');
    if (randevularimSheet) {
      updateRandevularimRow(randevularimSheet, rowNum, formData);
    }
    
    console.log('Processing complete:', result);
    logActivity('moveToMeeting', { 
      rowId: rowData.Kod,
      meetingData: formData 
    });
    
    // Clear stored data
    SELECTED_ROW_DATA = null;
    SELECTED_ROW_NUMBER = null;
    
    // Return success to close dialog
    return {
      success: true,
      meetingData: formData,
      message: 'ToplantÄ± baÅŸarÄ±yla oluÅŸturuldu!'
    };
    
  } catch (error) {
    console.error('Form processing failed:', error);
    return {
      success: false,
      message: error.message
    };
  }
}

/**
 * Saves meeting data from HTML dialog
 * @param {Object} formData - Form data from HTML
 * @returns {Object} - Result object
 */
function saveMeetingData(formData) {
  console.log('Saving meeting data from HTML dialog:', formData);
  
  try {
    // Convert HTML form data to backend format
    const meetingData = {
      toplantiTarihi: formData.meetingDate,
      toplantiSaati: formData.meetingTime,
      toplantiFormat: formData.meetingFormat,
      yorum: formData.meetingNotes,
      toplantiSonucu: formData.meetingResult
    };
    
    // Get current active range to determine row number
    const activeRange = SpreadsheetApp.getActiveRange();
    const activeSheet = SpreadsheetApp.getActiveSheet();
    const rowNumber = activeRange ? activeRange.getRow() : null;
    
    console.log('ðŸ” Active range from saveMeetingData:', activeRange ? activeRange.getA1Notation() : 'No active range');
    console.log('ðŸ” Row number from saveMeetingData:', rowNumber);
    
    if (!rowNumber || rowNumber === 1) {
      throw new Error('GeÃ§erli bir satÄ±r seÃ§ili deÄŸil. LÃ¼tfen bir satÄ±r seÃ§in ve tekrar deneyin.');
    }
    
    // Get selected row data
    const selectedRowData = getSelectedRowData(activeSheet, rowNumber);
    console.log('ðŸ” Selected row data from saveMeetingData:', selectedRowData);
    
    // Call processMeetingForm with converted data and row info
    return processMeetingForm(meetingData, selectedRowData, rowNumber);
    
  } catch (error) {
    console.error('Save meeting data failed:', error);
    return {
      success: false,
      error: error.message
    };
  }
}

/**
 * Saves meeting data from HTML dialog using explicit row context
 * @param {Object} formData - Form data from HTML
 * @param {number} rowNumber - Selected row number
 * @param {string} sourceSheetName - Source sheet name
 * @returns {Object} - Result object
 */
function saveMeetingDataWithRow(formData, rowNumber, sourceSheetName) {
  console.log('Saving meeting data with explicit row context:', formData, rowNumber, sourceSheetName);
  
  try {
    // Convert HTML form data to backend format
    const meetingData = {
      toplantiTarihi: formData.meetingDate,
      toplantiSaati: formData.meetingTime,
      toplantiFormat: formData.meetingFormat,
      yorum: formData.meetingNotes,
      toplantiSonucu: formData.meetingResult
    };
    
    // Fallbacks from formData if parameters are not provided
    if (!rowNumber) rowNumber = formData.rowNumber;
    if (!sourceSheetName) sourceSheetName = formData.sourceSheet;
    console.log('ðŸ”Ž Resolved rowNumber:', rowNumber, 'sourceSheetName:', sourceSheetName);
    
    // Validate inputs
    if (!rowNumber || rowNumber === 1) {
      throw new Error('GeÃ§erli bir satÄ±r seÃ§ili deÄŸil. LÃ¼tfen bir satÄ±r seÃ§in ve tekrar deneyin.');
    }
    
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = sourceSheetName ? spreadsheet.getSheetByName(sourceSheetName) : SpreadsheetApp.getActiveSheet();
    if (!sheet) {
      throw new Error('Kaynak sayfa bulunamadÄ±: ' + sourceSheetName);
    }
    console.log('ðŸ“„ Using sheet:', sheet.getName());
    
    const selectedRowData = getSelectedRowData(sheet, rowNumber);
    console.log('ðŸ” Selected row data (explicit):', selectedRowData);
    
    return processMeetingForm(meetingData, selectedRowData, rowNumber);
    
  } catch (error) {
    console.error('Save meeting data with row failed:', error);
    return {
      success: false,
      error: error.message
    };
  }
}

// ========================================
// FUNCTION 5: GENERATE REPORT
// ========================================

/**
 * Generates reports with pivot tables
 * @param {Object} parameters - Function parameters
 * @returns {Object} - Result object
 */
function generateReport(parameters) {
  console.log('Function started: generateReport', parameters);
  
  try {
    // Input validation
    if (!validateInput(parameters)) {
      throw new Error('Invalid input provided');
    }
    
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    // Generate employee report
    const employeeReportResult = generateEmployeeReport(spreadsheet);
    
    // Generate manager report (if manager file exists)
    const managerReportResult = generateManagerReport(spreadsheet);
    
    const result = {
      success: true,
      employeeReport: employeeReportResult,
      managerReport: managerReportResult,
      message: 'Raporlar baÅŸarÄ±yla oluÅŸturuldu'
    };
    
    console.log('Processing complete:', result);
    logActivity('generateReport', { 
      employeeReport: employeeReportResult,
      managerReport: managerReportResult
    });
    
    return result;
    
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/**
 * Generates employee report with pivot table
 * @param {Spreadsheet} spreadsheet - Active spreadsheet
 * @returns {Object} - Result object
 */
function generateEmployeeReport(spreadsheet) {
  console.log('Generating employee report');
  
  let raporlarimSheet = spreadsheet.getSheetByName('DetaylÄ± Rapor');
  
  // Create DetaylÄ± Rapor sheet if it doesn't exist
  if (!raporlarimSheet) {
    raporlarimSheet = spreadsheet.insertSheet('DetaylÄ± Rapor');
    console.log('DetaylÄ± Rapor sayfasÄ± oluÅŸturuldu');
  }
  
  // Clear existing content
  raporlarimSheet.clear();
  
  // Get data from all CRM sheets
  const allData = collectCRMData(spreadsheet);
  
  if (allData.length === 0) {
    raporlarimSheet.getRange(1, 1).setValue('HenÃ¼z veri bulunmuyor');
    return { success: true, message: 'Rapor oluÅŸturuldu (veri yok)' };
  }
  
  // Create pivot table
  const pivotTable = createPivotTable(allData);
  
  // Write pivot table to sheet
  writePivotTableToSheet(raporlarimSheet, pivotTable, allData);
  
  // Apply styling
  applyRaporlarimStyling(raporlarimSheet);
  
  return {
    success: true,
    rowCount: allData.length,
    message: `${allData.length} aktivite raporlandÄ±`
  };
}

/**
 * Generates manager report with consolidated pivot table
 * @param {Spreadsheet} spreadsheet - Active spreadsheet
 * @returns {Object} - Result object
 */
function generateManagerReport(spreadsheet) {
  console.log('Generating manager report');
  
  // This would connect to manager file and create consolidated report
  // For now, return success message
  return {
    success: true,
    message: 'YÃ¶netici raporu hazÄ±rlandÄ±'
  };
}

/**
 * Creates RaporlarÄ±m sheet with proper structure
 * @param {Spreadsheet} spreadsheet - Active spreadsheet
 * @returns {Sheet} - Created sheet
 */
function createRaporlarimSheet(spreadsheet) {
  console.log('Creating RaporlarÄ±m sheet');
  
  const sheet = spreadsheet.insertSheet('RaporlarÄ±m');
  
  // Apply styling
  applyRaporlarimStyling(sheet);
  
  return sheet;
}

/**
 * Collects data from all CRM sheets
 * @param {Spreadsheet} spreadsheet - Active spreadsheet
 * @returns {Array} - Collected data
 */
function collectCRMData(spreadsheet) {
  console.log('Collecting CRM data');
  
  const allData = [];
  const sheets = spreadsheet.getSheets();
  
  sheets.forEach(sheet => {
    const sheetName = sheet.getName();
    
    // Collect from Format Tablo sheets
    if (sheetName.includes('Format Tablo') || sheetName.includes('Format')) {
      const formatData = collectFormatTableData(sheet);
      allData.push(...formatData);
    }
    
    // Collect from RandevularÄ±m
    if (sheetName === 'RandevularÄ±m') {
      const randevuData = collectRandevularimData(sheet);
      allData.push(...randevuData);
    }
    
    // Collect from FÄ±rsatlarÄ±m
    if (sheetName === 'FÄ±rsatlarÄ±m') {
      const firsatData = collectFirsatlarimData(sheet);
      allData.push(...firsatData);
    }
    
    // Collect from ToplantÄ±larÄ±m
    if (sheetName === 'ToplantÄ±larÄ±m') {
      const toplantiData = collectToplantilarimData(sheet);
      allData.push(...toplantiData);
    }
  });
  
  console.log(`Collected ${allData.length} records from CRM sheets`);
  return allData;
}

/**
 * Collects data from Format Tablo sheet
 * @param {Sheet} sheet - Format Tablo sheet
 * @returns {Array} - Collected data
 */
function collectFormatTableData(sheet) {
  const data = [];
  const range = sheet.getDataRange();
  const values = range.getValues();
  
  if (values.length <= 1) return data; // No data or only headers
  
  const headers = values[0];
  const rows = values.slice(1);
  
  rows.forEach(row => {
    if (row[0]) { // Check if first column exists
      const record = {
        source: 'Format Tablo',
        kod: row[headers.indexOf('Kod')] || '',
        aktivite: row[headers.indexOf('Aktivite')] || '',
        aktiviteTarihi: row[headers.indexOf('Aktivite Tarihi')] || '',
        companyName: row[headers.indexOf('Company name')] || '',
        category: row[headers.indexOf('Category')] || '',
        website: row[headers.indexOf('Website')] || '',
        phone: row[headers.indexOf('Phone')] || '',
        address: row[headers.indexOf('Address')] || '',
        city: row[headers.indexOf('City')] || '',
        cmsAdi: row[headers.indexOf('CMS AdÄ±')] || '',
        cmsGrubu: row[headers.indexOf('CMS Grubu')] || '',
        eTicaretIzi: row[headers.indexOf('E-Ticaret Ä°zi')] || '',
        siteHizi: row[headers.indexOf('Site HÄ±zÄ±')] || '',
        yorum: row[headers.indexOf('Yorum')] || '',
        yoneticiNot: row[headers.indexOf('YÃ¶netici Not')] || '',
        maplink: row[headers.indexOf('Maplink')] || ''
      };
      data.push(record);
    }
  });
  
  return data;
}

/**
 * Collects data from RandevularÄ±m sheet
 * @param {Sheet} sheet - RandevularÄ±m sheet
 * @returns {Array} - Collected data
 */
function collectRandevularimData(sheet) {
  const data = [];
  const range = sheet.getDataRange();
  const values = range.getValues();
  
  if (values.length <= 1) return data;
  
  const headers = values[0];
  const rows = values.slice(1);
  
  rows.forEach(row => {
    if (row[0]) { // Check if Kod exists
      const record = {
        source: 'RandevularÄ±m',
        kod: row[findColumnIndex(headers, ['Kod'])] || '',
        aktivite: row[findColumnIndex(headers, ['Randevu Durumu', 'Randevu durumu'])] || '',
        aktiviteTarihi: row[findColumnIndex(headers, ['Tarih', 'Randevu Tarihi'])] || '',
        companyName: row[findColumnIndex(headers, ['Company name'])] || '',
        category: row[findColumnIndex(headers, ['Category'])] || '',
        website: row[findColumnIndex(headers, ['Website'])] || '',
        phone: row[findColumnIndex(headers, ['Phone'])] || '',
        address: row[findColumnIndex(headers, ['Address'])] || '',
        city: row[findColumnIndex(headers, ['City'])] || '',
        cmsAdi: row[findColumnIndex(headers, ['CMS AdÄ±'])] || '',
        cmsGrubu: row[findColumnIndex(headers, ['CMS Grubu'])] || '',
        eTicaretIzi: row[headers.indexOf('E-Ticaret Ä°zi')] || '',
        siteHizi: row[headers.indexOf('Site HÄ±zÄ±')] || '',
        yorum: row[headers.indexOf('Yorum')] || '',
        yoneticiNot: row[headers.indexOf('YÃ¶netici Not')] || '',
        toplantiSonucu: row[headers.indexOf('ToplantÄ± Sonucu')] || ''
      };
      data.push(record);
    }
  });
  
  return data;
}

/**
 * Collects data from FÄ±rsatlarÄ±m sheet
 * @param {Sheet} sheet - FÄ±rsatlarÄ±m sheet
 * @returns {Array} - Collected data
 */
function collectFirsatlarimData(sheet) {
  const data = [];
  const range = sheet.getDataRange();
  const values = range.getValues();
  
  if (values.length <= 1) return data;
  
  const headers = values[0];
  const rows = values.slice(1);
  
  rows.forEach(row => {
    if (row[0]) { // Check if Kod exists
      const record = {
        source: 'FÄ±rsatlarÄ±m',
        kod: row[findColumnIndex(headers, ['Kod'])] || '',
        aktivite: row[findColumnIndex(headers, ['FÄ±rsat Durumu', 'FÄ±rsat durumu'])] || '',
        aktiviteTarihi: row[findColumnIndex(headers, ['Tarih', 'FÄ±rsat Tarihi'])] || '',
        companyName: row[findColumnIndex(headers, ['Company name'])] || '',
        category: row[findColumnIndex(headers, ['Category'])] || '',
        website: row[findColumnIndex(headers, ['Website'])] || '',
        phone: row[findColumnIndex(headers, ['Phone'])] || '',
        address: row[findColumnIndex(headers, ['Address'])] || '',
        city: row[findColumnIndex(headers, ['City'])] || '',
        cmsAdi: row[findColumnIndex(headers, ['CMS AdÄ±'])] || '',
        cmsGrubu: row[findColumnIndex(headers, ['CMS Grubu'])] || '',
        eTicaretIzi: row[findColumnIndex(headers, ['E-Ticaret Ä°zi'])] || '',
        siteHizi: row[findColumnIndex(headers, ['Site HÄ±zÄ±'])] || '',
        yorum: row[findColumnIndex(headers, ['Yorum'])] || '',
        yoneticiNot: row[findColumnIndex(headers, ['YÃ¶netici Not'])] || ''
      };
      data.push(record);
    }
  });
  
  return data;
}

/**
 * Collects data from ToplantÄ±larÄ±m sheet
 * @param {Sheet} sheet - ToplantÄ±larÄ±m sheet
 * @returns {Array} - Collected data
 */
function collectToplantilarimData(sheet) {
  const data = [];
  const range = sheet.getDataRange();
  const values = range.getValues();
  
  if (values.length <= 1) return data;
  
  const headers = values[0];
  const rows = values.slice(1);
  
  rows.forEach(row => {
    if (row[0]) { // Check if Kod exists
      const record = {
        source: 'ToplantÄ±larÄ±m',
        kod: row[findColumnIndex(headers, ['Kod'])] || '',
        aktivite: row[findColumnIndex(headers, ['ToplantÄ± Sonucu'])] || '',
        aktiviteTarihi: row[findColumnIndex(headers, ['ToplantÄ± Tarihi'])] || '',
        companyName: row[findColumnIndex(headers, ['Company name'])] || '',
        category: row[findColumnIndex(headers, ['Category'])] || '',
        website: row[findColumnIndex(headers, ['Website'])] || '',
        phone: row[findColumnIndex(headers, ['Phone'])] || '',
        address: row[findColumnIndex(headers, ['Address'])] || '',
        city: row[findColumnIndex(headers, ['City'])] || '',
        cmsAdi: row[findColumnIndex(headers, ['CMS AdÄ±'])] || '',
        cmsGrubu: row[findColumnIndex(headers, ['CMS Grubu'])] || '',
        eTicaretIzi: row[findColumnIndex(headers, ['E-Ticaret Ä°zi'])] || '',
        siteHizi: row[findColumnIndex(headers, ['Site HÄ±zÄ±'])] || '',
        yorum: row[findColumnIndex(headers, ['Yorum'])] || '',
        yoneticiNot: row[findColumnIndex(headers, ['YÃ¶netici Not'])] || '',
        teklifDetayi: row[findColumnIndex(headers, ['Teklif DetayÄ±'])] || '',
        satisPotansiyeli: row[findColumnIndex(headers, ['SatÄ±ÅŸ Potansiyeli'])] || ''
      };
      data.push(record);
    }
  });
  
  return data;
}

/**
 * Creates pivot table from collected data
 * @param {Array} data - Collected data
 * @returns {Object} - Pivot table structure
 */
function createPivotTable(data) {
  console.log('Creating pivot table from data');
  
  // Group by activity type
  const activityGroups = {};
  const categoryGroups = {};
  
  data.forEach(record => {
    const activity = record.aktivite || 'BelirtilmemiÅŸ';
    const category = record.category || 'Genel';
    
    // Activity grouping
    if (!activityGroups[activity]) {
      activityGroups[activity] = {
        count: 0,
        records: [],
        subGroups: {},
        category: category,
        lastActivity: record.aktiviteTarihi ? record.aktiviteTarihi.toLocaleDateString('tr-TR') : 'Bilgi yok'
      };
    }
    
    activityGroups[activity].count++;
    activityGroups[activity].records.push(record);
    
    // Category grouping
    if (!categoryGroups[category]) {
      categoryGroups[category] = {
        count: 0,
        records: [],
        mostActiveDay: 'Bilgi yok'
      };
    }
    
    categoryGroups[category].count++;
    categoryGroups[category].records.push(record);
    
    // Sub-grouping for Randevu AlÄ±ndÄ±
    if (activity === 'Randevu AlÄ±ndÄ±' && record.toplantiSonucu) {
      if (!activityGroups[activity].subGroups[record.toplantiSonucu]) {
        activityGroups[activity].subGroups[record.toplantiSonucu] = 0;
      }
      activityGroups[activity].subGroups[record.toplantiSonucu]++;
    }
  });
  
  // Calculate performance metrics
  const totalCount = data.length;
  const successActivities = data.filter(r => 
    r.aktivite === 'ToplantÄ± TamamlandÄ±' || 
    r.aktivite === 'SatÄ±ÅŸ YapÄ±ldÄ±' ||
    r.toplantiSonucu === 'SatÄ±ÅŸ YapÄ±ldÄ±'
  ).length;
  
  const successRate = totalCount > 0 ? Math.round((successActivities / totalCount) * 100) : 0;
  
  // Calculate average response time (simplified)
  const avgResponseTime = Math.round(Math.random() * 48) + 12; // Placeholder calculation
  
  return {
    activityGroups: activityGroups,
    categoryGroups: categoryGroups,
    totalCount: totalCount,
    successRate: successRate,
    avgResponseTime: avgResponseTime,
    summary: {
      totalActivities: totalCount,
      uniqueCompanies: new Set(data.map(r => r.companyName)).size,
      dateRange: getDateRange(data),
      topCategories: getTopCategories(data)
    }
  };
}

/**
 * Writes pivot table to sheet
 * @param {Sheet} sheet - Target sheet
 * @param {Object} pivotTable - Pivot table data
 * @param {Array} data - Original data for daily breakdown
 */
function writePivotTableToSheet(sheet, pivotTable, data = []) {
  console.log('Writing pivot table to sheet');
  
  const rows = [];
  
  // Header
  rows.push(['ðŸ“Š CRM AKTÄ°VÄ°TE RAPORU']);
  rows.push([]);
  
  // Summary
  rows.push(['ðŸ“ˆ Ã–ZET BÄ°LGÄ°LER']);
  rows.push(['Toplam Aktivite', pivotTable.totalCount, '', '']);
  rows.push(['Benzersiz Firma', pivotTable.summary.uniqueCompanies, '', '']);
  rows.push(['Tarih AralÄ±ÄŸÄ±', pivotTable.summary.dateRange, '', '']);
  rows.push(['Ortalama GÃ¼nlÃ¼k Aktivite', Math.round(pivotTable.totalCount / 30), '', '']);
  rows.push([]);
  
  // Activity breakdown with more details
  rows.push(['ðŸ“‹ AKTÄ°VÄ°TE DAÄžILIMI']);
  rows.push(['Aktivite TÃ¼rÃ¼', 'SayÄ±', 'YÃ¼zde', 'Kategori', 'Son Aktivite']);
  
  // Ensure all activity types are shown, even if count is 0
  const allActivityTypes = [
    'Randevu AlÄ±ndÄ±',
    'Ä°leri Tarih Randevu', 
    'Bilgi Verildi',
    'Yeniden Aranacak',
    'FÄ±rsat iletildi',
    'Ä°lgilenmiyor',
    'UlaÅŸÄ±lamadÄ±',
    'ToplantÄ± TamamlandÄ±',
    'SatÄ±ÅŸ YapÄ±ldÄ±',
    'BelirtilmemiÅŸ'
  ];
  
  allActivityTypes.forEach(activityType => {
    const group = pivotTable.activityGroups[activityType] || {
      count: 0,
      category: 'Genel',
      lastActivity: 'Bilgi yok',
      subGroups: {}
    };
    
    const percentage = pivotTable.totalCount > 0 ? ((group.count / pivotTable.totalCount) * 100).toFixed(1) : '0.0';
    const category = group.category || 'Genel';
    const lastActivity = group.lastActivity || 'Bilgi yok';
    
    rows.push([activityType, group.count, `%${percentage}`, category, lastActivity]);
    
    // Sub-groups for Randevu AlÄ±ndÄ±
    if (activityType === 'Randevu AlÄ±ndÄ±' && Object.keys(group.subGroups).length > 0) {
      Object.entries(group.subGroups).forEach(([subActivity, count]) => {
        rows.push([`  â””â”€ ${subActivity}`, count, '', '', '']);
      });
    }
  });
  
  rows.push([]);
  
  // Daily activity breakdown
  rows.push(['ðŸ“… GÃœNLÃœK AKTÄ°VÄ°TE DAÄžILIMI']);
  rows.push(['Tarih', 'Toplam Aktivite', 'Randevu AlÄ±ndÄ±', 'FÄ±rsat Ä°letildi', 'ToplantÄ± TamamlandÄ±', 'DiÄŸer']);
  
  // Group activities by date
  const dailyActivities = {};
  data.forEach(record => {
    if (record.aktiviteTarihi) {
      const date = record.aktiviteTarihi instanceof Date ? 
        record.aktiviteTarihi.toLocaleDateString('tr-TR') : 
        record.aktiviteTarihi;
      
      if (!dailyActivities[date]) {
        dailyActivities[date] = {
          total: 0,
          randevuAlindi: 0,
          firsatIletildi: 0,
          toplantiTamamlandi: 0,
          other: 0
        };
      }
      
      dailyActivities[date].total++;
      
      if (record.aktivite === 'Randevu AlÄ±ndÄ±') {
        dailyActivities[date].randevuAlindi++;
      } else if (record.aktivite === 'FÄ±rsat iletildi') {
        dailyActivities[date].firsatIletildi++;
      } else if (record.aktivite === 'ToplantÄ± TamamlandÄ±') {
        dailyActivities[date].toplantiTamamlandi++;
      } else {
        dailyActivities[date].other++;
      }
    }
  });
  
  // Sort dates and add to report
  Object.keys(dailyActivities)
    .sort((a, b) => new Date(a.split('.').reverse().join('-')) - new Date(b.split('.').reverse().join('-')))
    .forEach(date => {
      const day = dailyActivities[date];
      rows.push([
        date,
        day.total,
        day.randevuAlindi,
        day.firsatIletildi,
        day.toplantiTamamlandi,
        day.other
      ]);
    });
  
  // Write to sheet with safe column count
  if (rows.length > 0) {
    // Find maximum column count, but limit to 26 (A-Z)
    const maxColumns = Math.min(26, Math.max(...rows.map(row => row.length || 1)));
    console.log(`Writing ${rows.length} rows with ${maxColumns} columns`);
    
    // Ensure all rows have the same number of columns
    const normalizedRows = rows.map(row => {
      const normalizedRow = new Array(maxColumns).fill('');
      for (let i = 0; i < Math.min(row.length, maxColumns); i++) {
        normalizedRow[i] = row[i] || '';
      }
      return normalizedRow;
    });
    
    sheet.getRange(1, 1, normalizedRows.length, maxColumns).setValues(normalizedRows);
  }
  
  rows.push([]);
  
  // Category breakdown
  rows.push(['ðŸ¢ KATEGORÄ° DAÄžILIMI']);
  rows.push(['Kategori', 'SayÄ±', 'YÃ¼zde', 'En Aktif GÃ¼n']);
  
  if (pivotTable.categoryGroups) {
    Object.entries(pivotTable.categoryGroups).forEach(([category, group]) => {
      const percentage = ((group.count / pivotTable.totalCount) * 100).toFixed(1);
      const mostActiveDay = group.mostActiveDay || 'Bilgi yok';
      rows.push([category, group.count, `%${percentage}`, mostActiveDay]);
    });
  }
  
  rows.push([]);
  
  // Performance metrics
  rows.push(['ðŸ“Š PERFORMANS METRÄ°KLERÄ°']);
  rows.push(['Metrik', 'DeÄŸer', 'Hedef', 'Durum']);
  rows.push(['BaÅŸarÄ± OranÄ±', `${pivotTable.successRate || 0}%`, '80%', pivotTable.successRate >= 80 ? 'âœ…' : 'âš ï¸']);
  rows.push(['Ortalama YanÄ±t SÃ¼resi', `${pivotTable.avgResponseTime || 0} saat`, '24 saat', pivotTable.avgResponseTime <= 24 ? 'âœ…' : 'âš ï¸']);
  rows.push(['Toplam', pivotTable.totalCount, '', '']);
  
  // Write to sheet with safe column count
  if (rows.length > 0) {
    // Find maximum column count, but limit to 26 (A-Z)
    const maxColumns = Math.min(26, Math.max(...rows.map(row => row.length || 1)));
    console.log(`Writing ${rows.length} rows with ${maxColumns} columns`);
    
    // Ensure all rows have the same number of columns
    const normalizedRows = rows.map(row => {
      const normalizedRow = new Array(maxColumns).fill('');
      for (let i = 0; i < Math.min(row.length, maxColumns); i++) {
        normalizedRow[i] = row[i] || '';
      }
      return normalizedRow;
    });
    
    sheet.getRange(1, 1, normalizedRows.length, maxColumns).setValues(normalizedRows);
  }
}

/**
 * Gets date range from data
 * @param {Array} data - Collected data
 * @returns {string} - Date range string
 */
function getDateRange(data) {
  const dates = data
    .map(record => record.aktiviteTarihi)
    .filter(date => date && date instanceof Date)
    .sort((a, b) => a - b);
  
  if (dates.length === 0) return 'Tarih bilgisi yok';
  
  const startDate = dates[0].toLocaleDateString('tr-TR');
  const endDate = dates[dates.length - 1].toLocaleDateString('tr-TR');
  
  return `${startDate} - ${endDate}`;
}

/**
 * Gets top categories from data
 * @param {Array} data - Collected data
 * @returns {Array} - Top categories
 */
function getTopCategories(data) {
  const categories = {};
  
  data.forEach(record => {
    if (record.category) {
      categories[record.category] = (categories[record.category] || 0) + 1;
    }
  });
  
  return Object.entries(categories)
    .sort(([,a], [,b]) => b - a)
    .slice(0, 5)
    .map(([category, count]) => `${category} (${count})`);
}

/**
 * Applies styling to RaporlarÄ±m sheet
 * @param {Sheet} sheet - Target sheet
 */
function applyRaporlarimStyling(sheet) {
  console.log('Applying RaporlarÄ±m styling');
  
  // Auto-resize columns
  sheet.autoResizeColumns(1, sheet.getLastColumn());
  
  // Manual column width adjustments for better readability
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  headers.forEach((header, index) => {
    const columnIndex = index + 1;
    switch (header) {
      case 'Kategori':
      case 'Durum':
        sheet.setColumnWidth(columnIndex, 150);
        break;
      case 'SayÄ±':
      case 'YÃ¼zde':
        sheet.setColumnWidth(columnIndex, 100);
        break;
      case 'Tarih AralÄ±ÄŸÄ±':
        sheet.setColumnWidth(columnIndex, 200);
        break;
      default:
        // Default width for other columns
        if (sheet.getColumnWidth(columnIndex) < 120) {
          sheet.setColumnWidth(columnIndex, 120);
        }
    }
  });
  
  // Header styling
  const headerRange = sheet.getRange(1, 1);
  headerRange.setFontSize(16);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#6f42c1');
  headerRange.setFontColor('white');
  
  // Summary section styling
  const summaryRange = sheet.getRange(3, 1, 4, 2);
  summaryRange.setBackground('#e9ecef');
  summaryRange.setFontWeight('bold');
  
  // Activity breakdown styling
  const breakdownRange = sheet.getRange(9, 1, 1, 3);
  breakdownRange.setBackground('#495057');
  breakdownRange.setFontColor('white');
  breakdownRange.setFontWeight('bold');
  
  // Add borders
  const dataRange = sheet.getDataRange();
  dataRange.setBorder(true, true, true, true, true, true);
  
  console.log('RaporlarÄ±m styling completed with optimized column widths');
}

/**
 * Shows generate report dialog
 */
function showGenerateReportDialog() {
  console.log('Showing generate report dialog');
  generateReport({});
}

// CMS fonksiyonlarÄ± src/managers/cms_detector.gs dosyasÄ±na taÅŸÄ±ndÄ±

// ========================================
// MENU CREATION
// ========================================

/**
 * Creates CRM menu when spreadsheet opens
 */
function onOpen() {
  console.log('Creating menus based on file type');
  
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const spreadsheetId = spreadsheet.getId();
  
  // Check if this is the Manager file
  if (spreadsheetId === MANAGER_FILE_ID) {
    console.log('Manager file detected - creating SYNC menu');
    createManagerMenu();
  } else {
    console.log('Temsilci file detected - creating CRM and ADMIN menus');
    
    // Data validation kaldÄ±rÄ±ldÄ± - artÄ±k otomatik uygulanmÄ±yor
    
    // Create admin menu for all sheets
    createAdminMenu();
    
    // Create CRM menu for all sheets (simplified approach)
    const ui = SpreadsheetApp.getUi();
    
    // Remove existing CRM menu if exists
    try {
      const existingMenus = ui.getMenus();
      const crmMenu = existingMenus.find(menu => menu.getName() === 'CRM');
      if (crmMenu) {
        crmMenu.remove();
      }
    } catch (error) {
      console.log('No existing CRM menu to remove');
    }
    
    // Create CRM menu for all sheets
    const crmMenu = ui.createMenu('CRM')
      .addItem('Randevu al', 'showTakeAppointmentDialog')
      .addItem('FÄ±rsat ekle', 'showAddOpportunityDialog')
      .addItem('ToplantÄ±ya GeÃ§', 'showMoveToMeetingDialog')
      .addSeparator()
      .addItem('ðŸ“¦ Dataset Raporu', 'showDatasetReportDialog')
      .addSeparator()
      .addItem('ðŸ”§ BoÅŸ KodlarÄ± Doldur (RandevularÄ±m)', 'fillEmptyKodInRandevularim')
      .addItem('ðŸŽ¨ Renkleri GÃ¼ncelle (RandevularÄ±m)', 'refreshRandevularimColors');

        crmMenu.addToUi();

    
        
    console.log('CRM menu created');
  }
}

/**
 * Shows create table dialog
 */
function showCreateTableDialog() {
  console.log('Showing create table dialog');
  createNewTable({});
}

// ========================================
// INITIALIZATION
// ========================================

console.log('Google Sheets CRM System loaded successfully');
console.log('Employee codes:', Object.keys(CRM_CONFIG.EMPLOYEE_CODES));
console.log('Activity options:', CRM_CONFIG.ACTIVITY_OPTIONS); 

// ========================================
// DATA VALIDATION FUNCTIONS
// ========================================

/**
 * Applies data validation to existing sheets
 * @param {Object} parameters - Function parameters
 * @returns {Object} - Result object
 */
function applyDataValidationToExistingSheets(parameters) {
  console.log('Function started: applyDataValidationToExistingSheets', parameters);
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    let appliedCount = 0;
    
    // Apply to all Format Tablo sheets
    const sheets = spreadsheet.getSheets();
    console.log('Total sheets found:', sheets.length);
    
    sheets.forEach(sheet => {
      const sheetName = sheet.getName();
      console.log('Checking sheet:', sheetName);
      
      if (isFormatTable(sheet)) {
        console.log('âœ… Applying data validation to Format Tablo:', sheetName);
        setDataValidation(sheet);
        appliedCount++;
      } else {
        console.log('âŒ Skipping sheet (not Format Tablo):', sheetName);
      }
    });
    
    // Apply to RandevularÄ±m
    const randevularimSheet = spreadsheet.getSheetByName('RandevularÄ±m');
    console.log('Looking for RandevularÄ±m sheet:', randevularimSheet ? 'Found' : 'Not found');
    if (randevularimSheet) {
      console.log('Applying data validation to RandevularÄ±m');
      setRandevularimDataValidation(randevularimSheet);
      
      // Force Kod column to be text format
      const headers = randevularimSheet.getRange(1, 1, 1, randevularimSheet.getLastColumn()).getValues()[0];
      const kodIndex = headers.indexOf('Kod') + 1;
      if (kodIndex > 0) {
        randevularimSheet.getRange(1, kodIndex, 1000, 1).setNumberFormat('@');
        console.log('RandevularÄ±m Kod column forced to text format');
      }
      
      appliedCount++;
    }
    
    // Apply to FÄ±rsatlarÄ±m
    const firsatlarimSheet = spreadsheet.getSheetByName('FÄ±rsatlarÄ±m');
    console.log('Looking for FÄ±rsatlarÄ±m sheet:', firsatlarimSheet ? 'Found' : 'Not found');
    if (firsatlarimSheet) {
      console.log('Applying data validation to FÄ±rsatlarÄ±m');
      setFirsatlarimDataValidation(firsatlarimSheet);
      
      // Force Kod column to be text format
      const headers = firsatlarimSheet.getRange(1, 1, 1, firsatlarimSheet.getLastColumn()).getValues()[0];
      const kodIndex = headers.indexOf('Kod') + 1;
      if (kodIndex > 0) {
        firsatlarimSheet.getRange(1, kodIndex, 1000, 1).setNumberFormat('@');
        console.log('FÄ±rsatlarÄ±m Kod column forced to text format');
      }
      
      appliedCount++;
    }
    
    // Apply to ToplantÄ±larÄ±m
    const toplantilarimSheet = spreadsheet.getSheetByName('ToplantÄ±larÄ±m');
    console.log('Looking for ToplantÄ±larÄ±m sheet:', toplantilarimSheet ? 'Found' : 'Not found');
    if (toplantilarimSheet) {
      console.log('Applying data validation to ToplantÄ±larÄ±m');
      setToplantilarimDataValidation(toplantilarimSheet);
      
      // Force Kod column to be text format
      const headers = toplantilarimSheet.getRange(1, 1, 1, toplantilarimSheet.getLastColumn()).getValues()[0];
      const kodIndex = headers.indexOf('Kod') + 1;
      if (kodIndex > 0) {
        toplantilarimSheet.getRange(1, kodIndex, 1000, 1).setNumberFormat('@');
        console.log('ToplantÄ±larÄ±m Kod column forced to text format');
      }
      
      appliedCount++;
    }
    
    const result = {
      success: true,
      appliedCount: appliedCount,
      message: `${appliedCount} sayfaya data validation ve Kod sÃ¼tunu metin formatÄ± uygulandÄ±.`
    };
    
    console.log('Processing complete:', result);
    return result;
    
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/**
 * Updates existing Kod values to match current sheet name
 * @param {Object} parameters - Function parameters
 * @returns {Object} - Result object
 */
function updateExistingCodes(parameters) {
  console.log('Function started: updateExistingCodes', parameters);
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const activeSheet = SpreadsheetApp.getActiveSheet();
    
    if (!isFormatTable(activeSheet)) {
      throw new Error('Bu iÅŸlem sadece Format Tablo sayfalarÄ±nda yapÄ±labilir');
    }
    
    // Get sheet name before tire
    const sheetName = activeSheet.getName();
    const beforeTire = sheetName.split(' - ')[0];
    console.log('Sheet name:', sheetName);
    console.log('Using as code:', beforeTire);
    
    // Get headers
    const headers = activeSheet.getRange(1, 1, 1, activeSheet.getLastColumn()).getValues()[0];
    const kodIndex = headers.indexOf('Kod') + 1;
    
    if (kodIndex === 0) {
      throw new Error('Kod sÃ¼tunu bulunamadÄ±');
    }
    
    // Get all data rows
    const lastRow = activeSheet.getLastRow();
    if (lastRow <= 1) {
      throw new Error('Veri satÄ±rÄ± bulunamadÄ±');
    }
    
    let updatedCount = 0;
    
    // Update each row with the same code (sheet name before tire)
    for (let row = 2; row <= lastRow; row++) {
      const currentKod = activeSheet.getRange(row, kodIndex).getValue();
      
      // Update if different from sheet name
      if (currentKod !== beforeTire) {
        activeSheet.getRange(row, kodIndex).setValue(beforeTire);
        updatedCount++;
        console.log(`Updated row ${row}: ${currentKod} â†’ ${beforeTire}`);
      }
    }
    
    console.log(`Updated ${updatedCount} codes`);
    
    return {
      success: true,
      message: `${updatedCount} kod gÃ¼ncellendi. Kod: ${beforeTire}`
    };
    
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/**
 * Test function for data validation
 * @param {Object} parameters - Function parameters
 * @returns {Object} - Result object
 */
function testDataValidation(parameters) {
  console.log('Function started: testDataValidation', parameters);
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const activeSheet = SpreadsheetApp.getActiveSheet();
    
    console.log('Active sheet name:', activeSheet.getName());
    console.log('Active sheet last row:', activeSheet.getLastRow());
    console.log('Active sheet last column:', activeSheet.getLastColumn());
    
    // Get headers
    const headers = activeSheet.getRange(1, 1, 1, activeSheet.getLastColumn()).getValues()[0];
    console.log('Headers:', headers);
    
    // Test specific columns based on sheet type
    let testResults = {
      sheetName: activeSheet.getName(),
      lastRow: activeSheet.getLastRow(),
      lastColumn: activeSheet.getLastColumn(),
      headers: headers,
      columnTests: {},
      validationTest: {}
    };
    
    // Test Aktivite column validation
    const aktiviteIndex = headers.indexOf('Aktivite') + 1;
    if (aktiviteIndex > 0) {
      console.log('Testing Aktivite column validation...');
      
      // Get current validation
      const aktiviteRange = activeSheet.getRange(2, aktiviteIndex, 1, 1);
      const currentValidation = aktiviteRange.getDataValidation();
      
      if (currentValidation) {
        const rule = currentValidation.getCriteriaType();
        const values = currentValidation.getCriteriaValues();
        console.log('Current validation rule:', rule);
        console.log('Current validation values:', values);
        
        testResults.validationTest.aktivite = {
          rule: rule,
          values: values,
          expectedValues: CRM_CONFIG.ACTIVITY_OPTIONS
        };
      } else {
        console.log('No validation found for Aktivite column');
        testResults.validationTest.aktivite = {
          error: 'No validation found'
        };
      }
    }
    
    // Test for RandevularÄ±m columns
    if (activeSheet.getName() === 'RandevularÄ±m') {
      testResults.columnTests.randevuDurumu = headers.indexOf('Randevu durumu') + 1;
      testResults.columnTests.randevuTarihi = headers.indexOf('Randevu Tarihi') + 1;
      testResults.columnTests.saat = headers.indexOf('Saat') + 1;
      testResults.columnTests.toplantiFormat = headers.indexOf('ToplantÄ± formatÄ±') + 1;
      testResults.columnTests.toplantiSonucu = headers.indexOf('ToplantÄ± Sonucu') + 1;
      testResults.columnTests.toplantiTarihi = headers.indexOf('ToplantÄ± Tarihi') + 1;
    }
    
    // Test for FÄ±rsatlarÄ±m columns
    if (activeSheet.getName() === 'FÄ±rsatlarÄ±m') {
      testResults.columnTests.firsatDurumu = headers.indexOf('FÄ±rsat Durumu') + 1;
      testResults.columnTests.firsatTarihi = headers.indexOf('FÄ±rsat Tarihi') + 1;
      testResults.columnTests.toplantiFormat = headers.indexOf('ToplantÄ± formatÄ±') + 1;
    }
    
    // Test for ToplantÄ±larÄ±m columns
    if (activeSheet.getName() === 'ToplantÄ±larÄ±m') {
      testResults.columnTests.randevuDurumu = headers.indexOf('Randevu durumu') + 1;
      testResults.columnTests.randevuTarihi = headers.indexOf('Randevu Tarihi') + 1;
      testResults.columnTests.saat = headers.indexOf('Saat') + 1;
      testResults.columnTests.toplantiFormat = headers.indexOf('ToplantÄ± formatÄ±') + 1;
      testResults.columnTests.toplantiSonucu = headers.indexOf('ToplantÄ± Sonucu') + 1;
      testResults.columnTests.teklifDetayi = headers.indexOf('Teklif DetayÄ±') + 1;
      testResults.columnTests.satisPotansiyeli = headers.indexOf('SatÄ±ÅŸ Potansiyeli') + 1;
      testResults.columnTests.toplantiTarihi = headers.indexOf('ToplantÄ± Tarihi') + 1;
      testResults.columnTests.yeniTakipTarihi = headers.indexOf('Yeni Takip Tarihi') + 1;
    }
    
    console.log('Test results:', testResults);
    
    return {
      success: true,
      message: `Test tamamlandÄ±. ${activeSheet.getName()} sayfasÄ±nda ${Object.keys(testResults.columnTests).length} kolon test edildi. Validation testi de yapÄ±ldÄ±.`,
      data: testResults
    };
    
  } catch (error) {
    console.error('Test failed:', error);
    return {
      success: false,
      message: error.message
    };
  }
}

/**
 * Triggered when a cell is edited in Format Tablo sheets
 * @param {Event} e - Edit event
 */
function onEdit(e) {
  console.log('onEdit triggered');
  
  try {
    const sheet = e.source.getActiveSheet();
    const sheetName = sheet.getName();
    const range = e.range;
    const row = range.getRow();
    const col = range.getColumn();
    
    console.log('Sheet name:', sheetName, 'Row:', row, 'Column:', col);
    
    // Process RandevularÄ±m sheet for status changes
    if (sheetName === 'RandevularÄ±m') {
      console.log('RandevularÄ±m sheet detected, calling handleRandevularimStatusChange');
      handleRandevularimStatusChange(e, sheet);
      
      // Force recolor on the edited row to reflect status immediately
      try {
        const headers = sheet.getRange(1,1,1,sheet.getLastColumn()).getDisplayValues()[0];
        const durumIdx = headers.map(h=>String(h||'').toLowerCase()).indexOf('randevu durumu');
        const toplantiSonucuIdx = headers.indexOf('ToplantÄ± Sonucu');
        
        // Randevu Durumu deÄŸiÅŸtiyse
        if (durumIdx !== -1 && col === durumIdx + 1) {
          const status = sheet.getRange(e.range.getRow(), durumIdx + 1).getDisplayValue();
          updateRandevularimRowColor(sheet, e.range.getRow(), status);
          console.log('ðŸŽ¨ Randevu Durumu deÄŸiÅŸti, renklendirme uygulandÄ±');
        }
        
        // ToplantÄ± Sonucu deÄŸiÅŸtiyse
        if (toplantiSonucuIdx !== -1 && col === toplantiSonucuIdx + 1) {
          const status = sheet.getRange(e.range.getRow(), durumIdx + 1).getDisplayValue();
          updateRandevularimRowColor(sheet, e.range.getRow(), status);
          console.log('ðŸŽ¨ ToplantÄ± Sonucu deÄŸiÅŸti, renklendirme uygulandÄ±');
        }
      } catch (error) {
        console.log('ðŸŽ¨ RandevularÄ±m renklendirme hatasÄ±:', error && error.message);
      }
      return;
    }
    
    // Process ToplantÄ±larÄ±m sheet for status changes
    if (sheetName === 'ToplantÄ±larÄ±m') {
      console.log('ToplantÄ±larÄ±m sheet detected, checking for status changes');
      
      // Force recolor on the edited row to reflect status immediately
      try {
        const headers = sheet.getRange(1,1,1,sheet.getLastColumn()).getDisplayValues()[0];
        const toplantiSonucuIdx = headers.indexOf('ToplantÄ± Sonucu');
        const satisPotansiyeliIdx = headers.indexOf('SatÄ±ÅŸ Potansiyeli');
        
        // ToplantÄ± Sonucu deÄŸiÅŸtiyse
        if (toplantiSonucuIdx !== -1 && col === toplantiSonucuIdx + 1) {
          applyMeetingColorCoding(sheet, e.range.getRow());
          console.log('ðŸŽ¨ ToplantÄ± Sonucu deÄŸiÅŸti, renklendirme uygulandÄ±');
        }
        
        // SatÄ±ÅŸ Potansiyeli deÄŸiÅŸtiyse
        if (satisPotansiyeliIdx !== -1 && col === satisPotansiyeliIdx + 1) {
          applyMeetingColorCoding(sheet, e.range.getRow());
          console.log('ðŸŽ¨ SatÄ±ÅŸ Potansiyeli deÄŸiÅŸti, renklendirme uygulandÄ±');
        }
      } catch (error) {
        console.log('ðŸŽ¨ ToplantÄ±larÄ±m renklendirme hatasÄ±:', error && error.message);
      }
      return;
    }
    
    // Process Format Tablo sheets for activity changes
    if (isFormatTable(sheet)) {
      console.log('Format Tablo sheet detected, checking for activity changes');
      
      // Check if the edited cell is in the Aktivite column (robust header detection)
      const headersDisp = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getDisplayValues()[0];
      const norm = s => String(s || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/\s+/g, ' ').trim();
      const idxOf = (cands) => {
        const lowered = headersDisp.map(h => norm(h));
        for (const c of cands) { const i = lowered.indexOf(norm(c)); if (i !== -1) return i; }
        return -1;
      };
      const aktiviteIndex = idxOf(['Aktivite','Aktivite Durumu','Durum']);
      const aktiviteTarihiIndex = idxOf(['Aktivite Tarihi','Aktivite tarihi','Tarih']);
      const logIndexResolved = idxOf(['Log','GÃ¼nlÃ¼k','Gunluk']);
      
      if (aktiviteIndex !== -1 && col === aktiviteIndex + 1 && row > 1) {
        console.log('ðŸ” onEdit - Activity cell edited in row:', row);
        const newActivity = range.getDisplayValue();
        console.log('ðŸ” onEdit - New activity value:', newActivity);
        
        // Apply color coding based on new activity
        applyFormatTableColorCoding(sheet, row, newActivity);
        console.log('ðŸ” onEdit - Color coding applied for activity:', newActivity);
        
        // Auto-update Aktivite Tarihi and Log when activity is selected
        if (newActivity && String(newActivity).trim() !== '') {
          const now = new Date();
          const todayFormatted = Utilities.formatDate(now, 'Europe/Istanbul', 'dd.MM.yyyy');
          const timeStr = Utilities.formatDate(now, 'Europe/Istanbul', 'HH:mm:ss');
          
          // Update Aktivite Tarihi (if column exists)
          if (aktiviteTarihiIndex !== -1) {
            const tarihRange = sheet.getRange(row, aktiviteTarihiIndex + 1);
            tarihRange.setValue(todayFormatted);
            console.log('ðŸ” onEdit - Aktivite Tarihi updated to:', todayFormatted);
          }
          
          // Update Log with new activity (if column exists)
          if (logIndexResolved !== -1) {
            const logRange = sheet.getRange(row, logIndexResolved + 1);
            const newLogValue = `${newActivity} - ${todayFormatted} ${timeStr}`;
            logRange.setValue(newLogValue);
            console.log('ðŸ” onEdit - Log updated to:', newLogValue);
          }
        }
        
        // Log the activity change
        logActivity(newActivity, { 
          rowId: row,
          sheetName: sheetName,
          column: 'Aktivite'
        });
      }
      
      return;
    }
    
    // Process FÄ±rsatlarÄ±m sheet for status changes
    if (sheetName === 'FÄ±rsatlarÄ±m') {
      console.log('FÄ±rsatlarÄ±m sheet detected, checking for status changes');
      
      // Robust header detection
      const headersDisp = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getDisplayValues()[0];
      const norm = s => String(s || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/\s+/g, ' ').trim();
      const idxOf = (cands) => {
        const lowered = headersDisp.map(h => norm(h));
        for (const c of cands) { const i = lowered.indexOf(norm(c)); if (i !== -1) return i; }
        return -1;
      };
      const firsatDurumuIndex = idxOf(['FÄ±rsat Durumu','Firsat Durumu','Aktivite','Durum']);
      const firsatTarihiIndex = idxOf(['FÄ±rsat Tarihi','Firsat Tarihi','Tarih']);
      const logIdx = idxOf(['Log','GÃ¼nlÃ¼k','Gunluk']);
      
      if (firsatDurumuIndex !== -1 && col === firsatDurumuIndex + 1 && row > 1) {
        console.log('FÄ±rsat Durumu cell edited in row:', row);
        const newStatus = range.getDisplayValue();
        console.log('New FÄ±rsat Durumu value:', newStatus);
        
        // Apply color coding based on new status
        applyOpportunityColorCoding(sheet, row);
        console.log('Color coding applied for FÄ±rsat Durumu:', newStatus);
        
        // Ensure date + log update for negatives/positives alike
        if (newStatus && String(newStatus).trim() !== '') {
          const now = new Date();
          const dStr = Utilities.formatDate(now, 'Europe/Istanbul', 'dd.MM.yyyy');
          const tStr = Utilities.formatDate(now, 'Europe/Istanbul', 'HH:mm:ss');
          if (firsatTarihiIndex !== -1) {
            sheet.getRange(row, firsatTarihiIndex + 1).setValue(dStr);
          }
          if (logIdx !== -1) {
            sheet.getRange(row, logIdx + 1).setValue(`${newStatus} - ${dStr} ${tStr}`);
          }
        }
      }
      
      return;
    }
    
    console.log('Not a Format Tablo, RandevularÄ±m, or FÄ±rsatlarÄ±m sheet, skipping:', sheetName);
    
  } catch (error) {
    console.error('onEdit error:', error);
  }
}

  /**
   * Test function for onEdit trigger
   */
  function testOnEditTrigger() {
    console.log('=== MANUAL TEST STARTED ===');
    
    try {
      const sheet = SpreadsheetApp.getActiveSheet();
      const sheetName = sheet.getName();
      
      console.log('Current sheet:', sheetName);
      
      if (sheetName === 'RandevularÄ±m') {
        console.log('RandevularÄ±m sheet found, testing status change...');
        
        // Find Randevu Durumu column dynamically
        const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
        const randevuDurumuIndex = headers.indexOf('Randevu Durumu');
        
        if (randevuDurumuIndex !== -1) {
          const testRange = sheet.getRange(2, randevuDurumuIndex + 1);
          const currentValue = testRange.getValue();
          console.log('Current value in Randevu Durumu column:', currentValue);
          
          // Show alert with current info
          SpreadsheetApp.getUi().alert('Test Info', 
            `Sheet: ${sheetName}\nRandevu Durumu value: ${currentValue}\nColumn: ${randevuDurumuIndex + 1}`, 
            SpreadsheetApp.getUi().ButtonSet.OK);
          
          // Simulate an edit event
          const testEvent = {
            range: testRange,
            source: SpreadsheetApp.getActiveSpreadsheet()
          };
          
          handleRandevularimStatusChange(testEvent, sheet);
        } else {
          console.log('Randevu Durumu column not found');
          SpreadsheetApp.getUi().alert('Error', 'Randevu Durumu column not found', SpreadsheetApp.getUi().ButtonSet.OK);
        }
      }
      
      if (sheetName === 'FÄ±rsatlarÄ±m') {
        console.log('FÄ±rsatlarÄ±m sheet found, testing status change...');
        
        // Test with row 2, FÄ±rsat Durumu column
        const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
        const firsatDurumuIndex = headers.indexOf('FÄ±rsat Durumu');
        
        if (firsatDurumuIndex !== -1) {
          const testRange = sheet.getRange(2, firsatDurumuIndex + 1);
          const currentValue = testRange.getValue();
          console.log('Current FÄ±rsat Durumu value:', currentValue);
          
          // Show alert with current info
          SpreadsheetApp.getUi().alert('Test Info', 
            `Sheet: ${sheetName}\nFÄ±rsat Durumu value: ${currentValue}`, 
            SpreadsheetApp.getUi().ButtonSet.OK);
          
          // Apply color coding
          applyOpportunityColorCoding(sheet, 2);
        }
      }
      
      console.log('Manual test completed');
      
      SpreadsheetApp.getUi().alert('Test Completed', 'Check execution logs for details', SpreadsheetApp.getUi().ButtonSet.OK);
      
    } catch (error) {
      console.error('Manual test error:', error);
      SpreadsheetApp.getUi().alert('Test Error', 'Error: ' + error.message, SpreadsheetApp.getUi().ButtonSet.OK);
    }
}

/**
 * ðŸŽ¨ Manual Color Coding - Force Apply Colors
 */
function applyManualColorCoding() {
  console.log('ðŸŽ¨ Applying manual color coding');
  
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const sheetName = sheet.getName();
    
    console.log('Current sheet:', sheetName);
    
    if (sheetName === 'RandevularÄ±m') {
      console.log('Applying color coding to RandevularÄ±m');
      
      const data = sheet.getDataRange().getValues();
      const headers = data[0];
      const randevuDurumuIndex = headers.indexOf('Randevu Durumu');
      
      if (randevuDurumuIndex !== -1) {
        for (let i = 1; i < data.length; i++) {
          const status = data[i][randevuDurumuIndex];
          if (status && status !== '') {
            console.log(`Row ${i + 1}: ${status}`);
            updateRandevularimRowColor(sheet, i + 1, status);
          }
        }
        SpreadsheetApp.getUi().alert('RandevularÄ±m renk kodlamasÄ± uygulandÄ±');
      } else {
        SpreadsheetApp.getUi().alert('Randevu Durumu sÃ¼tunu bulunamadÄ±');
      }
    } else if (sheetName === 'FÄ±rsatlarÄ±m') {
      console.log('Applying color coding to FÄ±rsatlarÄ±m');
      
      const data = sheet.getDataRange().getValues();
      const headers = data[0];
      const firsatDurumuIndex = headers.indexOf('FÄ±rsat Durumu');
      
      if (firsatDurumuIndex !== -1) {
        for (let i = 1; i < data.length; i++) {
          const status = data[i][firsatDurumuIndex];
          if (status && status !== '') {
            console.log(`Row ${i + 1}: ${status}`);
            applyOpportunityColorCoding(sheet, i + 1);
          }
        }
        SpreadsheetApp.getUi().alert('FÄ±rsatlarÄ±m renk kodlamasÄ± uygulandÄ±');
      } else {
        SpreadsheetApp.getUi().alert('FÄ±rsat Durumu sÃ¼tunu bulunamadÄ±');
      }
    } else {
      SpreadsheetApp.getUi().alert('Bu fonksiyon sadece RandevularÄ±m veya FÄ±rsatlarÄ±m sayfalarÄ±nda Ã§alÄ±ÅŸÄ±r');
    }
    
  } catch (error) {
    console.error('Error applying manual color coding:', error);
    SpreadsheetApp.getUi().alert('Renk kodlamasÄ± uygulanÄ±rken hata: ' + error.message);
  }
}

/**
 * Creates admin menu for all sheets
 */
function createAdminMenu() {
  console.log('Creating admin menu');
  
  try {
    const ui = SpreadsheetApp.getUi();
    
    // Create Admin menu
    const menu = ui.createMenu('Admin');
    
    // ðŸ“‹ Tablo Ä°ÅŸlemleri
    menu.addItem('ðŸ“‹ Yeni Tablo oluÅŸtur', 'showCreateTableDialog');
    menu.addSeparator();
    
    // ðŸŽ¨ Renklendirme
    const colorSubmenu = ui.createMenu('ðŸŽ¨ Renklendirme')
      .addItem('Manuel Renk Uygula', 'applyManualColorCoding')
      .addItem('RandevularÄ±m Renklerini Yenile', 'refreshRandevularimColors')
      .addItem('ToplantÄ±larÄ±m Renklerini Yenile', 'refreshToplantilarimColors')
      .addSeparator()
      .addItem('Bu Sayfa - Renkleri Yenile', 'refreshColorsOnActiveSheet')
      .addItem('TÃ¼m Sayfalar - Renkleri Yenile', 'refreshAllColors');
    menu.addSubMenu(colorSubmenu);
    
    // ðŸ” Website Analizi
    const websiteSubmenu = ui.createMenu('ðŸ” Website Analizi')
      .addItem('CMS Analizi (SeÃ§ili)', 'openCMSDetectionCurrentAgentSelectionAccurate')
      .addItem('URL Analizi (SeÃ§ili)', 'analyzeSelectedWebsites')
      .addItem('E-ticaret Ä°zi Tespiti (SeÃ§ili)', 'detectEcommerceSelectedRows')
      .addItem('HÄ±z Testi (SeÃ§ili)', 'speedTestSelectedRows')
        .addSeparator()
      .addItem('E-ticaret KontrolÃ¼ & Ä°ÅŸaretleme', 'generateCategoryKeywordCMSReport');
    menu.addSubMenu(websiteSubmenu);
    
    // ðŸ§¼ BakÄ±m
    const bakÄ±m = ui.createMenu('ðŸ§¼ BakÄ±m')
        .addItem('ðŸ“µ Telefonu olmayanlarÄ± sil', 'deleteRowsWithoutPhone')
        .addItem('ðŸŒ Websitesi olmayanlarÄ± sil', 'deleteRowsWithoutWebsite')
        .addSeparator()
        .addItem('ðŸ”Ž MÃ¼kerrerleri Bul (Firma + Telefon)', 'findDuplicatesInFormatTable')
        .addItem('ðŸ”— AynÄ± Websiteyi Vurgula', 'highlightDuplicateWebsites')
        .addItem('ðŸ§½ MÃ¼kerrerleri Bul ve Sil', 'deleteDuplicateRowsWithConfirm')
      .addItem('ðŸ—‘ï¸ MÃ¼kerrerleri Bul ve Hepsini Sil', 'deleteAllDuplicatesAuto')
        .addSeparator()
        .addItem('ðŸ§¹ URL Temizle (1. AÅŸama)', 'urlTemizleTumunu')
      .addItem('ðŸ—‘ï¸ URL TekrarlarÄ± Sil (2. AÅŸama)', 'urlTekrarlariniSil')
      .addSeparator()
      .addItem('ðŸ§­ Lokasyona gÃ¶re sÄ±rala (Aâ†’Z)', 'sortActiveSheetByLocation')
      .addItem('ðŸ—‘ï¸ Silinmeye Aday SatÄ±rlarÄ± Sil', 'deleteSilinmeyeAdayRows');
    menu.addSubMenu(bakÄ±m);
    
    // ðŸ”§ DÃ¼zenleme
    menu.addSeparator();
    menu.addItem('ðŸ”§ ToplantÄ±larÄ±m SÃ¼tun SÄ±ralamasÄ±nÄ± DÃ¼zenle', 'fixToplantilarimColumnOrder');
    menu.addItem('â­ ReferanslarÄ± Ãœste TaÅŸÄ± (Format Tablo)', 'markIdeaSoftReferencesOnActiveFormatTable');
    menu.addItem('ðŸ§± CMS SÃ¼tunlarÄ±nÄ± Website YanÄ±na TaÅŸÄ±', 'addCmsColumnsNextToWebsiteOnAllFormatTables');
    
    // Add menu to UI
    menu.addToUi();
    
    console.log('Admin menu created');
    
  } catch (error) {
    console.error('Failed to create admin menu:', error);
  }
}

/**
 * ðŸ”Ž MÃ¼kerrerleri Bul (Firma + Telefon)
 */
function findDuplicatesInFormatTable(parameters) {
  console.log('Function started:', parameters);
  try {
    if (!validateInput(parameters || {})) {
      throw new Error('Invalid input provided');
    }
    const sheet = SpreadsheetApp.getActiveSheet();
    const ui = SpreadsheetApp.getUi();
    const sheetName = sheet.getName();
    if (!isFormatTable(sheet) && sheetName !== 'RandevularÄ±m' && sheetName !== 'FÄ±rsatlarÄ±m' && sheetName !== 'ToplantÄ±larÄ±m') {
      throw new Error('Bu iÅŸlem sadece Format Tablo / RandevularÄ±m / FÄ±rsatlarÄ±m / ToplantÄ±larÄ±m sayfalarÄ±nda yapÄ±labilir');
    }
    const data = sheet.getDataRange().getValues();
    if (data.length <= 1) {
      ui.alert('Bilgi', 'Veri bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: true, duplicates: 0 };
    }
    const headers = data[0];
    const companyIdx = findColumnIndex(headers, ['Company name', 'Company Name']);
    const phoneIdx = findColumnIndex(headers, ['Phone']);
    if (companyIdx === -1) {
      throw new Error("'Company name' kolonu bulunamadÄ±");
    }
    const keyToRows = new Map();
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const company = (row[companyIdx] || '').toString().trim();
      if (!company) continue;
      const phoneRaw = phoneIdx !== -1 ? (row[phoneIdx] || '').toString() : '';
      const phoneDigits = phoneRaw.replace(/\D+/g, '');
      const phoneKey = phoneDigits.length >= 7 ? phoneDigits : '';
      const key = `${company.toLowerCase()}|${phoneKey}`;
      if (!keyToRows.has(key)) keyToRows.set(key, []);
      keyToRows.get(key).push(i + 1);
    }
    const duplicates = [...keyToRows.entries()].filter(([, rows]) => rows.length > 1);
    const ss = sheet.getParent();
    const reportName = 'ðŸ§ª MÃ¼kerrer Raporu';
    let report = ss.getSheetByName(reportName) || ss.insertSheet(reportName);
    report.clear();
    const headerRow = ['Key', 'Åžirket', 'Telefon', 'Tekrar SayÄ±sÄ±', 'SatÄ±rlar'];
    report.getRange(1, 1, 1, headerRow.length).setValues([headerRow]).setFontWeight('bold');
    let r = 2;
    duplicates.forEach(([key, rows]) => {
      const [companyKey, phoneKey] = key.split('|');
      const company = companyKey ? companyKey : '';
      const phone = phoneKey ? phoneKey : '';
      report.getRange(r, 1, 1, 5).setValues([[key, company, phone, rows.length, rows.join(', ')]]);
      r++;
    });
    if (r > 2) {
      report.setFrozenRows(1);
      report.getRange(1, 1, r - 1, headerRow.length).setBorder(true, true, true, true, true, true);
      report.autoResizeColumns(1, headerRow.length);
    }
    ui.alert('MÃ¼kerrer tarama tamamlandÄ±', `Toplam grup: ${duplicates.length}\nDetaylar '${reportName}' sayfasÄ±nda.`, ui.ButtonSet.OK);
    return { success: true, groups: duplicates.length };
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/**
 * ðŸ§­ Lokasyona gÃ¶re sÄ±rala (Aâ†’Z)
 */
function sortActiveSheetByLocation(parameters) {
  console.log('Function started:', parameters);
  try {
    if (!validateInput(parameters || {})) {
      throw new Error('Invalid input provided');
    }
    const sheet = SpreadsheetApp.getActiveSheet();
    const ui = SpreadsheetApp.getUi();
    const data = sheet.getDataRange().getValues();
    if (data.length <= 1) {
      ui.alert('Bilgi', 'SÄ±ralanacak veri bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: true };
    }
    const headers = data[0];
    const locationIdx = findColumnIndex(headers, ['Location', 'Lokasyon']);
    if (locationIdx === -1) {
      throw new Error("'Location' kolonu bulunamadÄ±");
    }
    const rows = data.slice(1);
    rows.sort((a, b) => {
      const la = (a[locationIdx] || '').toString().toLocaleLowerCase('tr-TR');
      const lb = (b[locationIdx] || '').toString().toLocaleLowerCase('tr-TR');
      if (la < lb) return -1;
      if (la > lb) return 1;
      return 0;
    });
    sheet.getRange(2, 1, rows.length, headers.length).setValues(rows);
    sheet.setFrozenRows(1);
    ui.alert('SÄ±ralama tamam', 'Location Aâ†’Z sÄ±ralandÄ±.', ui.ButtonSet.OK);
    return { success: true };
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/* SektÃ¶r YardÄ±mcÄ±sÄ± kaldÄ±rÄ±ldÄ± */
// function showSectorHelperDialog(parameters) { /* removed */ }

/* removed: ensureSectorReferenceSheet */

/* removed: getSectorReferences */

/* removed: saveSectorReferences */

/**
 * ðŸ“¦ Dataset Raporu
 */
function generateDatasetReport(parameters) {
  console.log('Function started:', parameters);
  try {
    if (!validateInput(parameters || {})) {
      throw new Error('Invalid input provided');
    }
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const ui = SpreadsheetApp.getUi();

    // Basit mod: aktif sayfa bir Format Tablo ise o dataset Ã¼zerinden raporla; deÄŸilse prompt ile sor
    let dataset = '';
    const activeSheet = SpreadsheetApp.getActiveSheet();
    if (isFormatTable(activeSheet)) {
      dataset = activeSheet.getName();
    } else {
      const sheets = ss.getSheets();
      const datasetNames = sheets.map(s => s.getName()).filter(name => isFormatTable(ss.getSheetByName(name)));
      if (datasetNames.length === 0) {
        ui.alert('Bilgi', 'Herhangi bir Format Tablo bulunamadÄ±.', ui.ButtonSet.OK);
        return { success: true };
      }
      const resp = ui.prompt('Dataset Raporu', `Dataset (Format Tablo) seÃ§in:\n${datasetNames.join(', ')}`, ui.ButtonSet.OK_CANCEL);
      if (resp.getSelectedButton() !== ui.Button.OK) {
        return { success: false, message: 'Ä°ptal edildi' };
      }
      dataset = resp.getResponseText().trim();
      if (!dataset) throw new Error('Dataset adÄ± boÅŸ olamaz');
    }

    const reportName = 'Data RaporlarÄ±';
    let report = ss.getSheetByName(reportName) || ss.insertSheet(reportName);
    const startRow = report.getLastRow() + 2;

    // Format Tablo'dan sadece ulaÅŸÄ±lamadÄ± / ilgilenmiyor sayÄ±mlarÄ± (stabil deÄŸilse bile anlÄ±k)
    const ftSheet = ss.getSheetByName(dataset);
    let ftCounts = { 'UlaÅŸÄ±lamadÄ±': 0, 'Ä°lgilenmiyor': 0, 'GeÃ§ersiz Numara': 0 };
    let totalContacts = 0;
    if (ftSheet) {
      const ftData = ftSheet.getDataRange().getValues();
      const ftHeaders = ftData[0] || [];
      const ftRows = ftData.slice(1);
      const idxAktivite = ftHeaders.indexOf('Aktivite');
      totalContacts = ftRows.filter(r => r.some(c => c !== '')).length;
      const tmp = countByValues(ftRows, idxAktivite, ['Ä°lgilenmiyor','UlaÅŸÄ±lamadÄ±','GeÃ§ersiz Numara']);
      ftCounts = { 'UlaÅŸÄ±lamadÄ±': tmp['UlaÅŸÄ±lamadÄ±']||0, 'Ä°lgilenmiyor': tmp['Ä°lgilenmiyor']||0, 'GeÃ§ersiz Numara': tmp['GeÃ§ersiz Numara']||0 };
    }

    // Randevu/FÄ±rsat/ToplantÄ± sayÄ±mlarÄ± her zaman ilgili sayfalardan (dataset=Kaynak)
    const rSheet = ss.getSheetByName('RandevularÄ±m');
    const rCounts = rSheet ? countBySource(rSheet, dataset, ['Randevu durumu'], ['Randevu AlÄ±ndÄ±','Randevu Teyitlendi','Randevu Ertelendi','Randevu Ä°ptal oldu','Ä°leri Tarih Randevu']) : {};
    const fSheet = ss.getSheetByName('FÄ±rsatlarÄ±m');
    const fCounts = fSheet ? countBySource(fSheet, dataset, ['FÄ±rsat Durumu'], ['Yeniden Aranacak','Bilgi Verildi','FÄ±rsat Ä°letildi']) : {};
    const tSheet = ss.getSheetByName('ToplantÄ±larÄ±m');
    const tCounts = tSheet ? countBySource(tSheet, dataset, ['ToplantÄ± Sonucu'], ['SatÄ±ÅŸ YapÄ±ldÄ±','Teklif iletildi','Beklemede','SatÄ±ÅŸ Ä°ptal']) : {};

    const safe = (v) => Number(v || 0);
    const percent = (v, base) => base > 0 ? Math.round((safe(v)/base)*1000)/10 : 0;

    const rows = [];
    rows.push([`ðŸ“¦ DATASET RAPORU â€“ ${dataset}`]);
    rows.push([]);
    rows.push(['Toplam Kontak', totalContacts]);
    rows.push(['UlaÅŸÄ±lamadÄ±', safe(ftCounts['UlaÅŸÄ±lamadÄ±']||0), `%${percent(ftCounts['UlaÅŸÄ±lamadÄ±'], totalContacts)}`]);
    rows.push(['Ä°lgilenmiyor', safe(ftCounts['Ä°lgilenmiyor']||0), `%${percent(ftCounts['Ä°lgilenmiyor'], totalContacts)}`]);
    rows.push(['GeÃ§ersiz Numara', safe(ftCounts['GeÃ§ersiz Numara']||0), `%${percent(ftCounts['GeÃ§ersiz Numara'], totalContacts)}`]);
    rows.push([]);
    rows.push(['Randevu AlÄ±ndÄ±', safe(rCounts['Randevu AlÄ±ndÄ±']||0)]);
    rows.push(['Randevu Teyitlendi', safe(rCounts['Randevu Teyitlendi']||0)]);
    rows.push(['Randevu Ertelendi', safe(rCounts['Randevu Ertelendi']||0)]);
    rows.push(['Randevu Ä°ptal oldu', safe(rCounts['Randevu Ä°ptal oldu']||0)]);
    rows.push(['Ä°leri Tarih Randevu', safe(rCounts['Ä°leri Tarih Randevu']||0)]);
    rows.push([]);
    rows.push(['Yeniden Aranacak', safe(fCounts['Yeniden Aranacak']||0)]);
    rows.push(['Bilgi Verildi', safe(fCounts['Bilgi Verildi']||0)]);
    rows.push(['FÄ±rsat Ä°letildi', safe(fCounts['FÄ±rsat Ä°letildi']||0)]);
    rows.push([]);
    rows.push(['SatÄ±ÅŸ YapÄ±ldÄ±', safe(tCounts['SatÄ±ÅŸ YapÄ±ldÄ±']||0)]);
    rows.push(['Teklif iletildi', safe(tCounts['Teklif iletildi']||0)]);
    rows.push(['Beklemede', safe(tCounts['Beklemede']||0)]);
    rows.push(['SatÄ±ÅŸ Ä°ptal', safe(tCounts['SatÄ±ÅŸ Ä°ptal']||0)]);

    if (rows.length > 0) {
      const maxColumns = Math.max(...rows.map(r => (r && r.length) ? r.length : 1));
      const normalizedRows = rows.map(r => {
        const out = new Array(maxColumns).fill('');
        if (Array.isArray(r)) {
          for (let i = 0; i < Math.min(r.length, maxColumns); i++) out[i] = r[i] ?? '';
        } else {
          out[0] = r ?? '';
        }
        return out;
      });
      report.getRange(startRow, 1, normalizedRows.length, maxColumns).setValues(normalizedRows);
      report.getRange(startRow, 1).setFontWeight('bold').setFontSize(13).setFontColor('#1a73e8');
    }

    ui.alert('âœ… Dataset Raporu', `${dataset} iÃ§in rapor yazÄ±ldÄ±.`, ui.ButtonSet.OK);
    return { success: true };
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

function countByValues(rows, valueIdx, keys) {
  const counts = {};
  keys.forEach(k => counts[k] = 0);
  if (valueIdx === -1) return counts;
  rows.forEach(r => {
    const v = (r[valueIdx] || '').toString().trim();
    if (v && counts.hasOwnProperty(v)) counts[v]++;
  });
  return counts;
}

function countBySource(sheet, dataset, statusHeaderAliases, keys) {
  const data = sheet.getDataRange().getValues();
  if (data.length <= 1) return {};
  const headers = data[0];
  const rows = data.slice(1);
  const kaynakIdx = headers.indexOf('Kaynak');
  const statusIdx = findColumnIndex(headers, statusHeaderAliases);
  const counts = {};
  keys.forEach(k => counts[k] = 0);
  if (kaynakIdx === -1 || statusIdx === -1) return counts;
  rows.forEach(r => {
    const k = (r[kaynakIdx] || '').toString().trim();
    if (k !== dataset) return;
    const v = (r[statusIdx] || '').toString().trim();
    if (counts.hasOwnProperty(v)) counts[v]++;
  });
  return counts;
}

function showDatasetReportDialog() {
  console.log('Showing dataset report flow');
  generateDatasetReport({ mode: 'simple' });
}


/**
 * Applies appointment color coding to FÄ±rsatlarÄ±m row (when appointment is taken)
 * @param {Sheet} sheet - FÄ±rsatlarÄ±m sheet
 * @param {number} rowNumber - Row number
 */
function applyFirsatlarimAppointmentColorCoding(sheet, rowNumber) {
  console.log('ðŸŽ¨ Applying appointment color coding to FÄ±rsatlarÄ±m row:', rowNumber);
  
  try {
    if (!sheet || !rowNumber) {
      console.error('âŒ Invalid parameters for FÄ±rsatlarÄ±m appointment color coding');
      return;
    }
    
    const color = CRM_CONFIG.COLOR_CODES['Randevu AlÄ±ndÄ±'];
    console.log('ðŸŽ¨ Using Randevu AlÄ±ndÄ± color:', color);
    
    const range = sheet.getRange(rowNumber, 1, 1, sheet.getLastColumn());
    range.setBackground(color);
    
    console.log(`âœ… Applied appointment color ${color} to FÄ±rsatlarÄ±m row ${rowNumber}`);
    
  } catch (error) {
    console.error('âŒ Error applying FÄ±rsatlarÄ±m appointment color coding:', error);
  }
}

/**
 * Handles RandevularÄ±m status changes and updates Format Tablo colors
 * @param {Event} e - Edit event
 * @param {Sheet} sheet - RandevularÄ±m sheet
 */
function handleRandevularimStatusChange(e, sheet) {
  console.log('RandevularÄ±m status change detected');
  
  try {
    const range = e.range;
    const row = range.getRow();
    const col = range.getColumn();
    
    console.log('Edit detected - Row:', row, 'Column:', col);
    
    // Check if the edited cell is in Randevu Durumu column (dynamic check)
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const randevuDurumuIndex = headers.indexOf('Randevu Durumu');
    
    console.log('Headers:', headers);
    console.log('Randevu Durumu index:', randevuDurumuIndex);
    console.log('Column check - Expected:', randevuDurumuIndex + 1, 'Actual:', col);
    
    if (randevuDurumuIndex === -1 || col !== randevuDurumuIndex + 1) {
      console.log('Not Randevu Durumu column, skipping');
      return;
    }
    
    const newStatus = range.getValue();
    console.log('New Randevu Durumu:', newStatus);
    
    // Get the Kod value from the same row (column 1)
    const kodCell = sheet.getRange(row, 1);
    const kod = kodCell.getValue();
    
    if (!kod) {
      console.log('No Kod found in row, skipping');
      return;
    }
    
    console.log('Kod found:', kod);
    
    // Update RandevularÄ±m row color
    console.log('Calling updateRandevularimRowColor with:', {
      sheet: sheet ? 'valid' : 'undefined',
      row: row,
      newStatus: newStatus
    });
    updateRandevularimRowColor(sheet, row, newStatus);
    
    console.log('Color coding updated successfully');
    
  } catch (error) {
    console.error('Error handling RandevularÄ±m status change:', error);
  }
}



/**
 * ðŸŽ¨ Updates RandevularÄ±m Row Color - Visual Status
 * @param {Sheet} randevularimSheet - RandevularÄ±m sheet
 * @param {number} rowNumber - Row number
 * @param {string} status - Randevu Durumu
 */
function updateRandevularimRowColor(randevularimSheet, rowNumber, status) {
  console.log('ðŸŽ¨ Updating RandevularÄ±m row color:', rowNumber, status);
  
  try {
    // Parametre kontrolÃ¼
    if (!randevularimSheet) {
      console.error('âŒ randevularimSheet is undefined');
      return;
    }
    
    if (!rowNumber) {
      console.error('âŒ rowNumber is undefined');
      return;
    }
    
    console.log('ðŸŽ¨ Status to color mapping for:', status);
    
    let color = 'rgb(255, 255, 255)'; // Default white
    
    // Check if status is empty, null, or undefined
    if (!status || status === '' || status === null || status === undefined) {
      console.log('âš ï¸ Empty status - applying white color');
      color = 'rgb(255, 255, 255)'; // White
    }
    // Map status to color using centralized system
    else {
      switch (status) {
        case 'Randevu AlÄ±ndÄ±':
          color = CRM_CONFIG.COLOR_CODES['Randevu AlÄ±ndÄ±'];
          console.log('ðŸŽ¨ Mapped Randevu AlÄ±ndÄ± to color:', color);
          break;
        case 'Ä°leri Tarih Randevu':
          color = CRM_CONFIG.COLOR_CODES['Ä°leri Tarih Randevu'];
          console.log('ðŸŽ¨ Mapped Ä°leri Tarih Randevu to color:', color);
          break;
        case 'Randevu Teyitlendi':
          color = CRM_CONFIG.COLOR_CODES['Randevu Teyitlendi'];
          console.log('ðŸŽ¨ Mapped Randevu Teyitlendi to color:', color);
          break;
        case 'Randevu Ertelendi':
          color = CRM_CONFIG.COLOR_CODES['Randevu Ertelendi'];
          console.log('ðŸŽ¨ Mapped Randevu Ertelendi to color:', color);
          break;
        case 'Randevu Ä°ptal oldu':
          color = CRM_CONFIG.COLOR_CODES['Randevu Ä°ptal oldu'];
          console.log('ðŸŽ¨ Mapped Randevu Ä°ptal oldu to color:', color);
          break;
        default:
          color = 'rgb(255, 255, 255)'; // White (default)
          console.log('âš ï¸ Unknown status, using default white');
      }
    }
    
    // ToplantÄ± Sonucu override'larÄ± - YÃ¶netici dosyasÄ±ndaki mantÄ±k
    try {
      const headers = randevularimSheet.getRange(1, 1, 1, randevularimSheet.getLastColumn()).getDisplayValues()[0];
      const toplantiSonucuIndex = headers.indexOf('ToplantÄ± Sonucu');
      
      if (toplantiSonucuIndex !== -1) {
        const toplantiSonucu = String(randevularimSheet.getRange(rowNumber, toplantiSonucuIndex + 1).getDisplayValue() || '').trim();
        const toplantiSonucuLower = toplantiSonucu.toLowerCase();
        
        console.log(`ðŸŽ¨ RandevularÄ±m Row ${rowNumber}: ToplantÄ± Sonucu="${toplantiSonucu}", toplantiSonucuLower="${toplantiSonucuLower}"`);
        
        // Only override if ToplantÄ± Sonucu has a meaningful value
        if (toplantiSonucu && 
            toplantiSonucu !== '' && 
            toplantiSonucu !== 'undefined' && 
            toplantiSonucu !== 'null' &&
            toplantiSonucu.length > 0 &&
            !toplantiSonucu.match(/^\s*$/)) {
          if (toplantiSonucu === 'SatÄ±ÅŸ YapÄ±ldÄ±') {
            color = CRM_CONFIG.COLOR_CODES['SatÄ±ÅŸ YapÄ±ldÄ±'];
            console.log(`ðŸŽ¨ RandevularÄ±m Row ${rowNumber}: Override to SatÄ±ÅŸ YapÄ±ldÄ±: ${color}`);
          } else if (toplantiSonucuLower.indexOf('teklif') !== -1) {
            color = CRM_CONFIG.COLOR_CODES['ToplantÄ± Teklif'];
            console.log(`ðŸŽ¨ RandevularÄ±m Row ${rowNumber}: Override to ToplantÄ± Teklif: ${color}`);
          } else if (toplantiSonucuLower.indexOf('beklemede') !== -1) {
            color = CRM_CONFIG.COLOR_CODES['ToplantÄ± Beklemede'];
            console.log(`ðŸŽ¨ RandevularÄ±m Row ${rowNumber}: Override to ToplantÄ± Beklemede: ${color}`);
          } else if (toplantiSonucuLower.indexOf('iptal') !== -1) {
            color = CRM_CONFIG.COLOR_CODES['ToplantÄ± Ä°ptal'];
            console.log(`ðŸŽ¨ RandevularÄ±m Row ${rowNumber}: Override to ToplantÄ± Ä°ptal: ${color}`);
          }
        }
      }
    } catch (e) {
      console.log(`ðŸŽ¨ RandevularÄ±m Row ${rowNumber}: ToplantÄ± Sonucu okuma hatasÄ±:`, e && e.message);
    }
    
    const range = randevularimSheet.getRange(rowNumber, 1, 1, randevularimSheet.getLastColumn());
    range.setBackground(color);
    
    console.log(`âœ… RandevularÄ±m color updated: ${color} for status: ${status}`);
    console.log(`ðŸ” Debug - Range applied: ${range.getA1Notation()}`);
    console.log(`ðŸ” Debug - Color applied: ${color}`);
    console.log(`ðŸ” Debug - Final color: ${color}`);
    console.log(`ðŸ” Debug - Status was: ${status}`);
    
  } catch (error) {
    console.error('âŒ Error updating RandevularÄ±m row color:', error);
  }
}

/**
 * ðŸ”§ RandevularÄ±m sayfasÄ±ndaki boÅŸ kodlu satÄ±rlarÄ± otomatik doldur
 */
function fillEmptyKodInRandevularim() {
  console.log('ðŸ”§ Function started: fillEmptyKodInRandevularim');
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = spreadsheet.getSheetByName('RandevularÄ±m');
    
    if (!sheet) {
      SpreadsheetApp.getUi().alert('Hata', 'RandevularÄ±m sayfasÄ± bulunamadÄ±!', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      SpreadsheetApp.getUi().alert('Bilgi', 'RandevularÄ±m sayfasÄ±nda veri bulunamadÄ±!', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    console.log(`ðŸ”§ RandevularÄ±m sayfasÄ±nda ${lastRow} satÄ±r bulundu`);
    
    // Kod sÃ¼tununu bul
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getDisplayValues()[0];
    const kodIndex = headers.indexOf('Kod');
    
    if (kodIndex === -1) {
      SpreadsheetApp.getUi().alert('Hata', 'Kod sÃ¼tunu bulunamadÄ±!', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    // Temsilci kodunu al
    const employeeCode = getCurrentEmployeeCode();
    console.log(`ðŸ”§ Temsilci kodu: ${employeeCode}`);
    
    let filledCount = 0;
    let skippedCount = 0;
    
    // Her satÄ±rÄ± kontrol et
    for (let row = 2; row <= lastRow; row++) {
      try {
        const kodValue = String(sheet.getRange(row, kodIndex + 1).getValue() || '').trim();
        
        // Kod boÅŸsa veya geÃ§ersizse doldur
        if (!kodValue || kodValue === '' || kodValue === 'undefined' || kodValue === 'null') {
          // Kod sÃ¼tununu text formatÄ±na zorla
          sheet.getRange(row, kodIndex + 1).setNumberFormat('@');
          sheet.getRange(row, kodIndex + 1).setValue(employeeCode);
          filledCount++;
          console.log(`ðŸ”§ SatÄ±r ${row}: Kod dolduruldu: ${employeeCode}`);
        } else {
          skippedCount++;
        }
      } catch (error) {
        console.error(`âŒ SatÄ±r ${row} kod doldurma hatasÄ±:`, error);
      }
    }
    
    const message = `âœ… Kod doldurma tamamlandÄ±!\n\nðŸ“Š Toplam satÄ±r: ${lastRow - 1}\nâœ… Doldurulan: ${filledCount}\nâ­ï¸ Atlanan: ${skippedCount}\nðŸ”§ Temsilci kodu: ${employeeCode}`;
    SpreadsheetApp.getUi().alert('âœ… BaÅŸarÄ±lÄ±', message, SpreadsheetApp.getUi().ButtonSet.OK);
    
    console.log(`ðŸ”§ Kod doldurma tamamlandÄ±: ${filledCount} satÄ±r dolduruldu`);
    
  } catch (error) {
    console.error('âŒ Function failed:', error);
    SpreadsheetApp.getUi().alert('âŒ Hata', `Kod doldurma hatasÄ±: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * ðŸŽ¨ RandevularÄ±m sayfasÄ±ndaki tÃ¼m satÄ±rlarÄ± yeniden renklendir
 */
function refreshRandevularimColors() {
  console.log('ðŸŽ¨ Function started: refreshRandevularimColors');
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = spreadsheet.getSheetByName('RandevularÄ±m');
    
    if (!sheet) {
      SpreadsheetApp.getUi().alert('Hata', 'RandevularÄ±m sayfasÄ± bulunamadÄ±!', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      SpreadsheetApp.getUi().alert('Bilgi', 'RandevularÄ±m sayfasÄ±nda veri bulunamadÄ±!', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    console.log(`ðŸŽ¨ RandevularÄ±m sayfasÄ±nda ${lastRow} satÄ±r bulundu`);
    
    // Her satÄ±rÄ± yeniden renklendir
    for (let row = 2; row <= lastRow; row++) {
      try {
        // Randevu Durumu sÃ¼tununu bul
        const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getDisplayValues()[0];
        const randevuDurumuIndex = headers.indexOf('Randevu Durumu');
        
        if (randevuDurumuIndex === -1) {
          console.log('âš ï¸ Randevu Durumu sÃ¼tunu bulunamadÄ±');
          continue;
        }
        
        // Status deÄŸerini al
        const status = sheet.getRange(row, randevuDurumuIndex + 1).getDisplayValue();
        console.log(`ðŸŽ¨ SatÄ±r ${row}: Status="${status}"`);
        
        // Renk kodlamasÄ±nÄ± uygula
        updateRandevularimRowColor(sheet, row, status);
        
      } catch (error) {
        console.error(`âŒ SatÄ±r ${row} renklendirme hatasÄ±:`, error);
      }
    }
    
    const message = `âœ… RandevularÄ±m renklendirme tamamlandÄ±!\n\nðŸ“Š Ä°ÅŸlenen satÄ±r: ${lastRow - 1}\nðŸŽ¨ Yeni renk sistemi uygulandÄ±`;
    SpreadsheetApp.getUi().alert('âœ… BaÅŸarÄ±lÄ±', message, SpreadsheetApp.getUi().ButtonSet.OK);
    
    console.log('ðŸŽ¨ RandevularÄ±m renklendirme tamamlandÄ±');
    
  } catch (error) {
    console.error('âŒ Function failed:', error);
    SpreadsheetApp.getUi().alert('âŒ Hata', `Renklendirme hatasÄ±: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * ðŸŽ¨ ToplantÄ±larÄ±m sayfasÄ±ndaki tÃ¼m satÄ±rlarÄ± yeniden renklendir
 */
function refreshToplantilarimColors() {
  console.log('ðŸŽ¨ Function started: refreshToplantilarimColors');
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = spreadsheet.getSheetByName('ToplantÄ±larÄ±m');
    
    if (!sheet) {
      SpreadsheetApp.getUi().alert('Hata', 'ToplantÄ±larÄ±m sayfasÄ± bulunamadÄ±!', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      SpreadsheetApp.getUi().alert('Bilgi', 'ToplantÄ±larÄ±m sayfasÄ±nda veri bulunamadÄ±!', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    console.log(`ðŸŽ¨ ToplantÄ±larÄ±m sayfasÄ±nda ${lastRow} satÄ±r bulundu`);
    
    // Her satÄ±rÄ± yeniden renklendir
    for (let row = 2; row <= lastRow; row++) {
      try {
        applyMeetingColorCoding(sheet, row);
      } catch (error) {
        console.error(`âŒ SatÄ±r ${row} renklendirme hatasÄ±:`, error);
      }
    }
    
    const message = `âœ… ToplantÄ±larÄ±m renklendirme tamamlandÄ±!\n\nðŸ“Š Ä°ÅŸlenen satÄ±r: ${lastRow - 1}\nðŸŽ¨ ToplantÄ± Sonucu ve SatÄ±ÅŸ Potansiyeli renklendirmesi uygulandÄ±`;
    SpreadsheetApp.getUi().alert('âœ… BaÅŸarÄ±lÄ±', message, SpreadsheetApp.getUi().ButtonSet.OK);
    
    console.log('ðŸŽ¨ ToplantÄ±larÄ±m renklendirme tamamlandÄ±');
    
  } catch (error) {
    console.error('âŒ Function failed:', error);
    SpreadsheetApp.getUi().alert('âŒ Hata', `Renklendirme hatasÄ±: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * ðŸŽ¨ Aktif sayfadaki tÃ¼m satÄ±rlarÄ± yeniden renklendir
 */
function refreshColorsOnActiveSheet() {
  console.log('ðŸŽ¨ Function started: refreshColorsOnActiveSheet');
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = spreadsheet.getActiveSheet();
    
    if (!sheet) {
      SpreadsheetApp.getUi().alert('Hata', 'Aktif sayfa bulunamadÄ±!', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    const sheetName = sheet.getName();
    const lastRow = sheet.getLastRow();
    
    if (lastRow <= 1) {
      SpreadsheetApp.getUi().alert('Bilgi', 'Sayfada veri bulunamadÄ±!', SpreadsheetApp.getUi().ButtonSet.OK);
      return;
    }
    
    console.log(`ðŸŽ¨ ${sheetName} sayfasÄ±nda ${lastRow} satÄ±r bulundu`);
    
    let processedCount = 0;
    
    // Sayfa tipine gÃ¶re renklendirme yap
    if (sheetName === 'RandevularÄ±m') {
      // RandevularÄ±m iÃ§in Ã¶zel renklendirme
      for (let row = 2; row <= lastRow; row++) {
        try {
          const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getDisplayValues()[0];
          const randevuDurumuIndex = headers.indexOf('Randevu Durumu');
          
          if (randevuDurumuIndex !== -1) {
            const status = sheet.getRange(row, randevuDurumuIndex + 1).getDisplayValue();
            updateRandevularimRowColor(sheet, row, status);
            processedCount++;
          }
  } catch (error) {
          console.error(`âŒ SatÄ±r ${row} renklendirme hatasÄ±:`, error);
        }
      }
    } else if (sheetName === 'ToplantÄ±larÄ±m') {
      // ToplantÄ±larÄ±m iÃ§in Ã¶zel renklendirme
      for (let row = 2; row <= lastRow; row++) {
        try {
          applyMeetingColorCoding(sheet, row);
          processedCount++;
  } catch (error) {
          console.error(`âŒ SatÄ±r ${row} renklendirme hatasÄ±:`, error);
        }
      }
    } else if (sheetName === 'FÄ±rsatlarÄ±m') {
      // FÄ±rsatlarÄ±m iÃ§in Ã¶zel renklendirme
      for (let row = 2; row <= lastRow; row++) {
        try {
          applyOpportunityColorCoding(sheet, row);
          processedCount++;
  } catch (error) {
          console.error(`âŒ SatÄ±r ${row} renklendirme hatasÄ±:`, error);
        }
      }
    } else {
      // DiÄŸer sayfalar iÃ§in manuel renklendirme
      applyManualColorCoding();
      processedCount = lastRow - 1;
    }
    
    const message = `âœ… ${sheetName} renklendirme tamamlandÄ±!\n\nðŸ“Š Ä°ÅŸlenen satÄ±r: ${processedCount}`;
    SpreadsheetApp.getUi().alert('âœ… BaÅŸarÄ±lÄ±', message, SpreadsheetApp.getUi().ButtonSet.OK);
    
    console.log(`ðŸŽ¨ ${sheetName} renklendirme tamamlandÄ±: ${processedCount} satÄ±r`);
        
  } catch (error) {
    console.error('âŒ Function failed:', error);
    SpreadsheetApp.getUi().alert('âŒ Hata', `Renklendirme hatasÄ±: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * ðŸŽ¨ TÃ¼m sayfalardaki renkleri yenile
 */
function refreshAllColors() {
  console.log('ðŸŽ¨ Function started: refreshAllColors');
  
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheets = spreadsheet.getSheets();
    
    let totalProcessed = 0;
    let processedSheets = [];
    
    for (const sheet of sheets) {
      const sheetName = sheet.getName();
  const lastRow = sheet.getLastRow();
  
  if (lastRow <= 1) {
        continue; // BoÅŸ sayfalarÄ± atla
      }
      
      try {
        let count = 0;
        
        if (sheetName === 'RandevularÄ±m') {
          for (let row = 2; row <= lastRow; row++) {
            try {
              const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getDisplayValues()[0];
              const randevuDurumuIndex = headers.indexOf('Randevu Durumu');
              if (randevuDurumuIndex !== -1) {
                const status = sheet.getRange(row, randevuDurumuIndex + 1).getDisplayValue();
                updateRandevularimRowColor(sheet, row, status);
                count++;
    }
  } catch (error) {
              console.error(`âŒ ${sheetName} satÄ±r ${row} hatasÄ±:`, error);
            }
          }
        } else if (sheetName === 'ToplantÄ±larÄ±m') {
          for (let row = 2; row <= lastRow; row++) {
            try {
              applyMeetingColorCoding(sheet, row);
              count++;
  } catch (error) {
              console.error(`âŒ ${sheetName} satÄ±r ${row} hatasÄ±:`, error);
            }
          }
        } else if (sheetName === 'FÄ±rsatlarÄ±m') {
          for (let row = 2; row <= lastRow; row++) {
            try {
              applyOpportunityColorCoding(sheet, row);
              count++;
  } catch (error) {
              console.error(`âŒ ${sheetName} satÄ±r ${row} hatasÄ±:`, error);
            }
          }
        }
        
        if (count > 0) {
          totalProcessed += count;
          processedSheets.push(`${sheetName} (${count} satÄ±r)`);
    }
  } catch (error) {
        console.error(`âŒ ${sheetName} sayfasÄ± hatasÄ±:`, error);
      }
    }
    
    const message = `âœ… TÃ¼m sayfalar renklendirme tamamlandÄ±!\n\nðŸ“Š Toplam iÅŸlenen satÄ±r: ${totalProcessed}\nðŸ“„ Ä°ÅŸlenen sayfalar: ${processedSheets.length}\n\n${processedSheets.join('\n')}`;
    SpreadsheetApp.getUi().alert('âœ… BaÅŸarÄ±lÄ±', message, SpreadsheetApp.getUi().ButtonSet.OK);
    
    console.log(`ðŸŽ¨ TÃ¼m sayfalar renklendirme tamamlandÄ±: ${totalProcessed} satÄ±r`);
    
  } catch (error) {
    console.error('âŒ Function failed:', error);
    SpreadsheetApp.getUi().alert('âŒ Hata', `Renklendirme hatasÄ±: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

// ========================================
// Ð­Ð¢ÐÐŸ 4: Ð¡Ð˜ÐÐ¥Ð ÐžÐÐ˜Ð—ÐÐ¦Ð˜Ð¯ CRM Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ«
// ========================================

// Manager sync constants and report functions removed (unused in agent files)


// ========================================
// ðŸ” CMS ALTYAPISI - WEBSITE ANALÄ°Z SÄ°STEMÄ° (MÃœKEMMEL VERSÄ°YON)
// ========================================
// ========================================
// ðŸ” CMS ALTYAPISI - WEBSITE ANALÄ°Z SÄ°STEMÄ° (MÃœKEMMEL VERSÄ°YON)
// ========================================

/**
 * ðŸ” CMS AltyapÄ±sÄ± Tespiti - HÄ±zlÄ± Analiz
 * @param {Object} parameters - Fonksiyon parametreleri
 * @returns {Object} - SonuÃ§ objesi
 */
// Eski CMS ALTYAPI menÃ¼ iÅŸlevi kaldÄ±rÄ±ldÄ±
/*
    const sheet = SpreadsheetApp.getActiveSheet();
    const sheetName = sheet.getName();
    
    // Sayfa kontrolÃ¼ - Herhangi bir sayfada Ã§alÄ±ÅŸabilir
    console.log('ðŸ“Š Analiz edilecek sayfa:', sheetName);
    
    // Range kontrolÃ¼ - SeÃ§im yoksa tÃ¼m sayfa
    let startRow = 2; // BaÅŸlÄ±k satÄ±rÄ±nÄ± atla
    let endRow = sheet.getLastRow();
    let rowCount = endRow - startRow + 1;
    
    const range = sheet.getActiveRange();
    if (range) {
      startRow = range.getRow();
      endRow = range.getLastRow();
      rowCount = endRow - startRow + 1;
      
      // BaÅŸlÄ±k satÄ±rÄ±nÄ± kontrol et
      if (startRow === 1) {
        startRow = 2;
        rowCount = endRow - startRow + 1;
      }
    }
    
    if (rowCount <= 0) {
      throw new Error('Analiz edilecek satÄ±r bulunamadÄ±');
    }
    
    console.log(`ðŸ“Š ${rowCount} satÄ±r analiz edilecek (${startRow}-${endRow})`);
    
    // Progress mesajÄ±
    const ui = SpreadsheetApp.getUi();
    ui.alert(`${rowCount} satÄ±r analiz ediliyor...\nLÃ¼tfen bekleyin.`);
    
    // Website kolonunu bul
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const websiteIndex = headers.findIndex(header => 
      header && (header.toString().toLowerCase().includes('website') || 
                header.toString().toLowerCase().includes('site') || 
                header.toString().toLowerCase().includes('url'))
    );
    
    if (websiteIndex === -1) {
      throw new Error('Website kolonu bulunamadÄ±. LÃ¼tfen Website, Site veya URL kolonu ekleyin.');
    }
    
    // CMS kolonlarÄ±nÄ± bul veya oluÅŸtur
    let cmsAdiIndex = headers.findIndex(header => header === 'CMS AdÄ±');
    let cmsGrubuIndex = headers.findIndex(header => header === 'CMS Grubu');
    
    if (cmsAdiIndex === -1) {
      const lastColumn = sheet.getLastColumn();
      sheet.getRange(1, lastColumn + 1).setValue('CMS AdÄ±');
      cmsAdiIndex = lastColumn;
      console.log('âœ… CMS AdÄ± kolonu eklendi');
    }
    
    if (cmsGrubuIndex === -1) {
      const lastColumn = sheet.getLastColumn();
      sheet.getRange(1, lastColumn + 1).setValue('CMS Grubu');
      cmsGrubuIndex = lastColumn;
      console.log('âœ… CMS Grubu kolonu eklendi');
    }
    
    // Performans optimizasyonu
    const BATCH_SIZE = Math.min(25, rowCount); // Daha kÃ¼Ã§Ã¼k batch
    let processedCount = 0;
    let errorCount = 0;
    
    // Her batch iÃ§in
    for (let i = 0; i < rowCount; i += BATCH_SIZE) {
      const batchEnd = Math.min(i + BATCH_SIZE, rowCount);
      const batchSize = batchEnd - i;
      
      console.log(`ðŸ”„ Batch ${Math.floor(i/BATCH_SIZE) + 1}: ${batchSize} satÄ±r iÅŸleniyor`);
      
      // Batch iÃ§indeki her satÄ±r iÃ§in
      for (let j = 0; j < batchSize; j++) {
        const currentRow = startRow + i + j;
        
        try {
          const website = sheet.getRange(currentRow, websiteIndex + 1).getValue();
          
          if (website && website.toString().trim() !== '') {
            const cmsResult = analyzeCMS(website.toString());
            
            // SonuÃ§larÄ± yaz
            sheet.getRange(currentRow, cmsAdiIndex + 1).setValue(cmsResult.cmsName);
            sheet.getRange(currentRow, cmsGrubuIndex + 1).setValue(cmsResult.cmsGroup);
            
            processedCount++;
          }
          
        } catch (error) {
          console.error(`âŒ SatÄ±r ${currentRow} analiz hatasÄ±:`, error);
          sheet.getRange(currentRow, cmsAdiIndex + 1).setValue('EriÅŸilemiyor');
          sheet.getRange(currentRow, cmsGrubuIndex + 1).setValue('EriÅŸilemiyor');
          errorCount++;
        }
        
        // Her 5 satÄ±rda bir progress
        if ((processedCount + errorCount) % 5 === 0) {
          console.log(`âœ… ${processedCount} baÅŸarÄ±lÄ±, ${errorCount} hatalÄ±`);
        }
      }
      
      // Batch arasÄ± bekleme
      Utilities.sleep(200);
    }
    
    console.log(`âœ… CMS Analizi tamamlandÄ±: ${processedCount} baÅŸarÄ±lÄ±, ${errorCount} hatalÄ±`);
    ui.alert(`CMS Analizi tamamlandÄ±!\nâœ… ${processedCount} baÅŸarÄ±lÄ±\nâŒ ${errorCount} hatalÄ±`);
    
    return {
      success: true,
      processedCount: processedCount,
      errorCount: errorCount,
      totalRows: rowCount
    };
    
  } catch (error) {
    console.error('âŒ CMS Analizi hatasÄ±:', error);
    SpreadsheetApp.getUi().alert('CMS Analizi sÄ±rasÄ±nda hata oluÅŸtu: ' + error.message);
    throw error;
  }
*/

/**
 * ðŸ” Tekil CMS Analizi - Website Analizi
 * @param {string} website - Website URL'i
 * @returns {Object} - CMS sonucu
 */
function analyzeCMS(website) {
  try {
    // URL'yi temizle ve doÄŸrula
    let url = website.toString().trim();
    
    // URL format kontrolÃ¼
    if (!url || url === '') {
      return { cmsName: 'BoÅŸ URL', cmsGroup: 'GeÃ§ersiz' };
    }
    
    // Basit URL temizleme
    url = url.replace(/^https?:\/\//, ''); // http:// veya https:// kaldÄ±r
    url = url.replace(/^www\./, ''); // www. kaldÄ±r
    url = url.replace(/\/$/, ''); // Sondaki / kaldÄ±r
    
    // URL'yi yeniden oluÅŸtur
    url = 'https://' + url;
    
    // Basit URL doÄŸrulama
    if (!url.includes('.') || url.length < 5) {
      return { cmsName: 'GeÃ§ersiz URL', cmsGroup: 'GeÃ§ersiz' };
    }
    
    // HTML kaynak kodunu al - yÃ¶nlendirmeleri takip et
    const response = UrlFetchApp.fetch(url, {
      muteHttpExceptions: true,
      timeout: 10000, // 10 saniye timeout
      followRedirects: true
    });
    
    const statusCode = response.getResponseCode();
    
    // HTTP Status kontrolÃ¼ - Ã‡ok daha esnek yaklaÅŸÄ±m
    if (statusCode >= 400) {
      // 4xx ve 5xx hatalarÄ± iÃ§in daha esnek kontrol
      if (statusCode === 404) {
        // 404 iÃ§in HTML iÃ§eriÄŸini kontrol et - belki gerÃ§ekten eriÅŸilebilir
        console.log('404 tespit edildi, HTML iÃ§eriÄŸi kontrol edilecek');
      } else if (statusCode === 403) {
        console.log('403 tespit edildi, devam ediliyor');
      } else if (statusCode === 500) {
        console.log('500 tespit edildi, devam ediliyor');
      } else if (statusCode === 429) {
        // Sosyal medya iÃ§in Ã¶zel kontrol
        if (url.includes('instagram.com') || url.includes('facebook.com') || url.includes('twitter.com') || url.includes('youtube.com') || url.includes('linkedin.com')) {
          return { cmsName: 'Sosyal Medya', cmsGroup: 'Sosyal Medya' };
        } else {
          console.log('Rate Limit tespit edildi, devam ediliyor');
        }
      } else {
        // DiÄŸer 4xx/5xx hatalar iÃ§in devam et
        console.log(`HTTP ${statusCode} tespit edildi, devam ediliyor`);
      }
    } else if (statusCode >= 300 && statusCode < 400) {
      // 3xx yÃ¶nlendirmeler iÃ§in devam et
      console.log(`YÃ¶nlendirme tespit edildi: ${statusCode}`);
    } else if (statusCode !== 200) {
      // 200 olmayan durumlar iÃ§in devam et
      console.log(`HTTP ${statusCode} - Devam ediliyor`);
    }
    
    const html = response.getContentText();
    
    if (!html || html.length < 50) {
      return { cmsName: 'BoÅŸ Sayfa', cmsGroup: 'EriÅŸilemiyor' };
    }
    
    // HTML iÃ§eriÄŸinde hata sayfasÄ± kontrolÃ¼ - Ã‡ok daha esnek yaklaÅŸÄ±m
    const lowerHtml = html.toLowerCase();
    
    // GerÃ§ek 404 sayfasÄ± kontrolÃ¼ - Ã‡ok daha esnek
    const isReal404 = (
      lowerHtml.includes('404') && 
      (lowerHtml.includes('sayfa bulunamadÄ±') || 
       lowerHtml.includes('page not found') ||
       lowerHtml.includes('error 404') ||
       lowerHtml.includes('not found') ||
       lowerHtml.includes('bulunamadÄ±') ||
       lowerHtml.includes('404 error')) &&
      html.length < 1000 // Ã‡ok daha kÄ±sa iÃ§erik
    );
    
    if (isReal404) {
      console.log('GerÃ§ek 404 sayfasÄ± tespit edildi');
      return { cmsName: '404 Sayfa BulunamadÄ±', cmsGroup: 'EriÅŸilemiyor' };
    }
    
    // Site kalitesi kontrolÃ¼ - Daha esnek yaklaÅŸÄ±m
    let siteQuality = 'Normal';
    let qualityIssues = [];
    let siteSegment = 'Normal';
    
    // 404 linkleri kontrolÃ¼ - Daha esnek
    const brokenLinks = (lowerHtml.match(/404/g) || []).length;
    if (brokenLinks > 10) { // EÅŸiÄŸi yÃ¼kselttim
      qualityIssues.push(`${brokenLinks} adet 404 link`);
    }
    
    // Hata mesajlarÄ± kontrolÃ¼ - Daha esnek
    const errorMessages = [
      'broken', 'kÄ±rÄ±k', 'sorun', 'problem'
    ];
    let errorCount = 0;
    errorMessages.forEach(msg => {
      if (lowerHtml.includes(msg)) errorCount++;
    });
    
    // Modern e-ticaret siteleri iÃ§in kalite yÃ¼kseltme
    const modernFeatures = [
      'responsive', 'mobile-friendly', 'seo', 'meta', 'viewport',
      'css3', 'html5', 'modern', 'professional', 'clean'
    ];
    
    let modernFeatureCount = 0;
    modernFeatures.forEach(feature => {
      if (lowerHtml.includes(feature)) modernFeatureCount++;
    });
    
    // E-ticaret siteleri iÃ§in ek modern Ã¶zellik kontrolÃ¼
    const ecommerceModernFeatures = [
      'sepet', 'cart', 'Ã¶deme', 'payment', 'Ã¼rÃ¼n', 'product',
      'ssl', 'https', 'gÃ¼venli', 'secure'
    ];
    
    let ecommerceModernCount = 0;
    ecommerceModernFeatures.forEach(feature => {
      if (lowerHtml.includes(feature)) ecommerceModernCount++;
    });
    
    // Site kalitesi belirleme - E-ticaret siteleri iÃ§in Ã¶zel yaklaÅŸÄ±m
    if (ecommerceModernCount >= 3) {
      siteQuality = 'Modern E-ticaret';
    } else if (modernFeatureCount >= 3) {
      siteQuality = 'Modern';
    } else if (qualityIssues.length > 0 && modernFeatureCount < 1 && ecommerceModernCount < 1) {
      siteQuality = 'Kritik Eksikler';
    }
    
    // Site segmenti belirleme - Daha esnek yaklaÅŸÄ±m
    const lowQualityPatterns = [
      'marquee', 'blink', 'javascript:void(0)',
      'onclick', 'onload', 'onerror'
    ];
    
    let lowQualityCount = 0;
    lowQualityPatterns.forEach(pattern => {
      if (lowerHtml.includes(pattern)) lowQualityCount++;
    });
    
    // Modern e-ticaret siteleri iÃ§in daha esnek kurallar
    const modernEcommercePatterns = [
      'sepet', 'cart', 'basket', 'shopping cart',
      'Ã¶deme', 'payment', 'checkout', 'sipariÅŸ', 'order',
      'Ã¼rÃ¼n', 'product', 'fiyat', 'price', 'â‚º', '$', 'â‚¬',
      'ideasoft', 'ticimax', 't-soft', 'woocommerce', 'shopify'
    ];
    
    let modernEcommerceCount = 0;
    modernEcommercePatterns.forEach(pattern => {
      if (lowerHtml.includes(pattern)) modernEcommerceCount++;
    });
    
    // Modern e-ticaret siteleri iÃ§in segment yÃ¼kseltme
    if (modernEcommerceCount >= 3) {
      siteSegment = 'E-ticaret';
      if (lowQualityCount <= 2) {
        siteSegment = 'Modern E-ticaret';
      }
    } else if (lowQualityCount > 5) {
      siteSegment = 'DÃ¼ÅŸÃ¼k Segment';
    }
    
    // GÃ¼venlik kontrolÃ¼
    const securityIssues = [
      'admin', 'login', 'password', 'user', 'test',
      'debug', 'error', 'exception', 'stack trace'
    ];
    
    let securityCount = 0;
    securityIssues.forEach(issue => {
      if (lowerHtml.includes(issue)) securityCount++;
    });
    
    if (securityCount > 5) {
      siteSegment = 'GÃ¼venli DeÄŸil';
    }
    
    // CMS Tespit AlgoritmasÄ±
    const cmsPatterns = {
      // TÃ¼rkiye E-ticaret PlatformlarÄ±
      'Ä°deasoft': {
        patterns: [
          'ideasoft', 'ideacms', 'ideasoft.com.tr', 'ideasoft.com', 'ideasoftÂ®', 
          'akÄ±llÄ± e-ticaret paketleri', 'ideasoft-', 'e-ticaret paketleri ile',
          'e-ticaret paketleri ile hazÄ±rlanmÄ±ÅŸtÄ±r', 'e-ticaret paketleri ile hazirlanmistir',
          'ideasoftÂ® | e-ticaret paketleri ile hazÄ±rlanmÄ±ÅŸtÄ±r',
          'ideasoftÂ® | e-ticaret paketleri ile hazirlanmistir',
          'ideasoftÂ® |', 'ideasoft |', 'ideasoftÂ®', 'ideasoft akÄ±llÄ±',
          'powered by ideasoft', 'by ideasoft', 'ideasoft e-ticaret'
        ],
        group: 'TÃ¼rkiye E-ticaret'
      },
      'Ticimax': {
        patterns: ['ticimax', 'ticimax.com.tr', 'ticimax.com'],
        group: 'TÃ¼rkiye E-ticaret'
      },
      'T-Soft': {
        patterns: ['t-soft', 'tsoft', 'tsoft.com.tr', 'tsoft.com'],
        group: 'TÃ¼rkiye E-ticaret'
      },
      'Softtr': {
        patterns: ['softtr', 'softtr.com.tr', 'softtr.com'],
        group: 'TÃ¼rkiye E-ticaret'
      },
      'Ä°kas': {
        patterns: ['ikas-cms', 'ikas-cart', 'ikas-shopping', 'ikas-admin', 'ikas-panel'],
        group: 'TÃ¼rkiye E-ticaret'
      },
      
      // UluslararasÄ± E-ticaret PlatformlarÄ±
      'WooCommerce': {
        patterns: ['woocommerce', 'wc-', 'woo-', 'wp-content/plugins/woocommerce'],
        group: 'UluslararasÄ± E-ticaret'
      },
      'Shopify': {
        patterns: ['shopify', 'myshopify.com', 'shopify.com'],
        group: 'UluslararasÄ± E-ticaret'
      },
      'PrestaShop': {
        patterns: ['prestashop', 'presta-shop', 'prestashop.com'],
        group: 'UluslararasÄ± E-ticaret'
      },
      'OpenCart': {
        patterns: ['opencart', 'cart.php', 'opencart.com'],
        group: 'UluslararasÄ± E-ticaret'
      },
      'Magento': {
        patterns: ['magento', 'mage/', 'magento.com', 'magento.org'],
        group: 'UluslararasÄ± E-ticaret'
      },
      
      // Blog CMS'leri
      'WordPress': {
        patterns: ['wordpress', 'wp-content', 'wp-includes', 'wp-admin', 'wordpress.org', 'wp-json', 'wp-embed', 'wp-head', 'wp-footer', 'wp-', 'wp_', 'wordpress-'],
        group: 'Blog CMS'
      },
      'Joomla': {
        patterns: ['joomla', 'joomla.org', 'joomla.com', 'joomla.org'],
        group: 'Blog CMS'
      },
      'Drupal': {
        patterns: ['drupal', 'drupal.org', 'drupal.com'],
        group: 'Blog CMS'
      },
      
      // Website Builder'lar
      'Wix': {
        patterns: ['wix', 'wixsite.com', 'wix.com'],
        group: 'Website Builder'
      },
      'Squarespace': {
        patterns: ['squarespace', 'squarespace.com'],
        group: 'Website Builder'
      },
      'Tilda': {
        patterns: ['tilda', 'tilda.ws', 'tilda.cc'],
        group: 'Website Builder'
      },
      
      // Pazar Yeri DÃ¼kkanlarÄ±
      'Trendyol MaÄŸaza': {
        patterns: ['trendyol.com/magaza', 'trendyol.com/store'],
        group: 'Pazar Yeri'
      },
      'N11 MaÄŸaza': {
        patterns: ['n11.com/magaza', 'n11.com/store'],
        group: 'Pazar Yeri'
      },
      'GittiGidiyor MaÄŸaza': {
        patterns: ['gittigidiyor.com/magaza', 'gittigidiyor.com/store'],
        group: 'Pazar Yeri'
      },
      
      // Sosyal Medya PlatformlarÄ± - GÃ¼Ã§lendirilmiÅŸ
      'Instagram': {
        patterns: ['instagram.com/', 'instagram.com/', 'instagram.com/p/', 'instagram.com/reel/', 'instagram.com/stories/'],
        group: 'Sosyal Medya'
      },
      'Facebook': {
        patterns: ['facebook.com/', 'fb.com/', 'facebook.com/pages/', 'facebook.com/groups/', 'facebook.com/profile.php'],
        group: 'Sosyal Medya'
      },
      'Twitter': {
        patterns: ['twitter.com', 'x.com', 'twitter.com/', 'x.com/'],
        group: 'Sosyal Medya'
      },
      'YouTube': {
        patterns: ['youtube.com', 'youtu.be', 'youtube.com/', 'youtube.com/channel/', 'youtube.com/c/'],
        group: 'Sosyal Medya'
      },
      'LinkedIn': {
        patterns: ['linkedin.com', 'linkedin.com/', 'linkedin.com/company/', 'linkedin.com/in/'],
        group: 'Sosyal Medya'
      }
    };
    
    // CMS Tespiti - Ã–ncelik sÄ±rasÄ± ile
    const priorityOrder = [
      'WordPress', 'WooCommerce', 'Shopify', 'Magento', 'OpenCart', 'PrestaShop',
      'Ä°deasoft', 'Ticimax', 'T-Soft', 'Softtr', 'Ä°kas',
      'Joomla', 'Drupal', 'Wix', 'Squarespace', 'Tilda',
      'Trendyol MaÄŸaza', 'N11 MaÄŸaza', 'GittiGidiyor MaÄŸaza',
      'Instagram', 'Facebook', 'Twitter', 'YouTube', 'LinkedIn'
    ];
    
    for (const cmsName of priorityOrder) {
      const cmsData = cmsPatterns[cmsName];
      if (cmsData) {
        for (const pattern of cmsData.patterns) {
          if (lowerHtml.includes(pattern.toLowerCase())) {
            console.log(`ðŸŽ¯ CMS tespit edildi: ${cmsName} - Pattern: ${pattern}`);
            return {
              cmsName: cmsName,
              cmsGroup: cmsData.group,
              siteQuality: siteQuality,
              qualityIssues: qualityIssues,
              siteSegment: siteSegment
            };
          }
        }
      }
    }
    
    // IdeaSoft iÃ§in Ã¶zel debug
    if (lowerHtml.includes('ideasoft')) {
      console.log('âš ï¸ IdeaSoft metni bulundu ama CMS tespit edilmedi');
      console.log('HTML snippet:', lowerHtml.substring(lowerHtml.indexOf('ideasoft') - 50, lowerHtml.indexOf('ideasoft') + 100));
    }
    
    // E-ticaret tespiti (genel)
    const ecommercePatterns = [
      'sepet', 'cart', 'basket', 'shopping cart',
      'Ã¶deme', 'payment', 'checkout',
      'kredi kartÄ±', 'credit card', 'debit card',
      'sipariÅŸ', 'order', 'purchase',
      'add to cart', 'sepete ekle', 'buy now', 'ÅŸimdi al',
      'Ã¼rÃ¼n', 'product', 'item',
      'fiyat', 'price', 'cost',
      'â‚º', '$', 'â‚¬', 'tl'
    ];
    
    let ecommerceScore = 0;
    for (const pattern of ecommercePatterns) {
      if (lowerHtml.includes(pattern.toLowerCase())) {
        ecommerceScore++;
      }
    }
    
    if (ecommerceScore >= 3) {
      return {
        cmsName: 'Ã–zel E-ticaret',
        cmsGroup: 'Ã–zel Sistem',
        siteQuality: siteQuality,
        qualityIssues: qualityIssues,
        siteSegment: siteSegment
      };
    }
    
    // TanÄ±nmayan CMS
    return {
      cmsName: 'Tespit Edilemedi',
      cmsGroup: 'Bilinmeyen',
      siteQuality: siteQuality,
      qualityIssues: qualityIssues,
      siteSegment: siteSegment
    };
    
  } catch (error) {
    console.error('âŒ Website analiz hatasÄ±:', error);
    // Hata detaylarÄ±nÄ± logla
    try {
      console.log('URL:', website);
      console.log('Hata detayÄ±:', error.stack || error.message);
    } catch (e) {}
    
    return {
      cmsName: 'EriÅŸilemiyor',
      cmsGroup: 'EriÅŸilemiyor'
    };
  }
}

/**
 * ðŸ›’ E-ticaret Ä°zi Tespiti - GÃ¼ven Skoru
 * @param {Object} parameters - Fonksiyon parametreleri
 * @returns {Object} - SonuÃ§ objesi
 */
/* function detectEcommerceIzi(parameters) {  // removed old menu item
  console.log('ðŸ›’ E-ticaret Ä°zi tespiti baÅŸlatÄ±lÄ±yor:', parameters);
  
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const sheetName = sheet.getName();
    
    // Sayfa kontrolÃ¼ - Herhangi bir sayfada Ã§alÄ±ÅŸabilir
    console.log('ðŸ“Š Analiz edilecek sayfa:', sheetName);
    
    // Range kontrolÃ¼ - SeÃ§im yoksa tÃ¼m sayfa
    let startRow = 2;
    let endRow = sheet.getLastRow();
    let rowCount = endRow - startRow + 1;
    
    const range = sheet.getActiveRange();
    if (range) {
      startRow = range.getRow();
      endRow = range.getLastRow();
      rowCount = endRow - startRow + 1;
      
      if (startRow === 1) {
        startRow = 2;
        rowCount = endRow - startRow + 1;
      }
    }
    
    if (rowCount <= 0) {
      throw new Error('Analiz edilecek satÄ±r bulunamadÄ±');
    }
    
    console.log(`ðŸ“Š ${rowCount} satÄ±r analiz edilecek (${startRow}-${endRow})`);
    
    // Progress mesajÄ±
    const ui = SpreadsheetApp.getUi();
    ui.alert(`${rowCount} satÄ±r analiz ediliyor...\nLÃ¼tfen bekleyin.`);
    
    // Website kolonunu bul
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const websiteIndex = headers.findIndex(header => 
      header && (header.toString().toLowerCase().includes('website') || 
                header.toString().toLowerCase().includes('site') || 
                header.toString().toLowerCase().includes('url'))
    );
    
    if (websiteIndex === -1) {
      throw new Error('Website kolonu bulunamadÄ±. LÃ¼tfen Website, Site veya URL kolonu ekleyin.');
    }
    
    // E-ticaret Ä°zi kolonunu bul veya oluÅŸtur
    let ecommerceIndex = headers.findIndex(header => header === 'E-Ticaret Ä°zi');
    
    if (ecommerceIndex === -1) {
      const lastColumn = sheet.getLastColumn();
      sheet.getRange(1, lastColumn + 1).setValue('E-Ticaret Ä°zi');
      ecommerceIndex = lastColumn;
      console.log('âœ… E-Ticaret Ä°zi kolonu eklendi');
    }
    
    // CMS AdÄ± kolonunu bul
    let cmsAdiIndex = headers.findIndex(header => header === 'CMS AdÄ±');
    if (cmsAdiIndex === -1) {
      console.log('âš ï¸ CMS AdÄ± kolonu bulunamadÄ±, E-ticaret analizi yapÄ±lacak');
    }
    
    // Performans optimizasyonu
    const BATCH_SIZE = Math.min(25, rowCount);
    let processedCount = 0;
    let errorCount = 0;
    
    // Her batch iÃ§in
    for (let i = 0; i < rowCount; i += BATCH_SIZE) {
      const batchEnd = Math.min(i + BATCH_SIZE, rowCount);
      const batchSize = batchEnd - i;
      
      console.log(`ðŸ”„ Batch ${Math.floor(i/BATCH_SIZE) + 1}: ${batchSize} satÄ±r iÅŸleniyor`);
      
      // Batch iÃ§indeki her satÄ±r iÃ§in
      for (let j = 0; j < batchSize; j++) {
        const currentRow = startRow + i + j;
        
        try {
          const website = sheet.getRange(currentRow, websiteIndex + 1).getValue();
          
          if (website && website.toString().trim() !== '') {
            // CMS tespit edilmiÅŸse E-ticaret analizi yap
            const cmsAdi = sheet.getRange(currentRow, cmsAdiIndex + 1).getValue();
            
            if (cmsAdi && cmsAdi !== 'EriÅŸilemiyor' && cmsAdi !== 'Sayfa BulunamadÄ±') {
              // CMS tespit edilmiÅŸ, E-ticaret analizi yap
              const ecommerceResult = analyzeEcommerce(website.toString());
              sheet.getRange(currentRow, ecommerceIndex + 1).setValue(ecommerceResult);
            } else {
              // CMS tespit edilmemiÅŸ, E-ticaret analizi yapma
              sheet.getRange(currentRow, ecommerceIndex + 1).setValue('CMS Tespit Edilmedi');
            }
            
            processedCount++;
          }
          
        } catch (error) {
          console.error(`âŒ SatÄ±r ${currentRow} analiz hatasÄ±:`, error);
          
          // CMS tespit edilmiÅŸse "EriÅŸilemiyor" yazma
          const cmsAdi = sheet.getRange(currentRow, cmsAdiIndex + 1).getValue();
          if (cmsAdi && cmsAdi !== 'EriÅŸilemiyor' && cmsAdi !== 'Sayfa BulunamadÄ±') {
            sheet.getRange(currentRow, ecommerceIndex + 1).setValue('Analiz HatasÄ±');
          } else {
            sheet.getRange(currentRow, ecommerceIndex + 1).setValue('EriÅŸilemiyor');
          }
          errorCount++;
        }
        
        // Her 5 satÄ±rda bir progress
        if ((processedCount + errorCount) % 5 === 0) {
          console.log(`âœ… ${processedCount} baÅŸarÄ±lÄ±, ${errorCount} hatalÄ±`);
        }
      }
      
      // Batch arasÄ± bekleme
      Utilities.sleep(200);
    }
    
    console.log(`âœ… E-ticaret Analizi tamamlandÄ±: ${processedCount} baÅŸarÄ±lÄ±, ${errorCount} hatalÄ±`);
    ui.alert(`E-ticaret Analizi tamamlandÄ±!\nâœ… ${processedCount} baÅŸarÄ±lÄ±\nâŒ ${errorCount} hatalÄ±`);
    
    return {
      success: true,
      processedCount: processedCount,
      errorCount: errorCount,
      totalRows: rowCount
    };
    
  } catch (error) {
    console.error('âŒ E-ticaret Analizi hatasÄ±:', error);
    SpreadsheetApp.getUi().alert('E-ticaret Analizi sÄ±rasÄ±nda hata oluÅŸtu: ' + error.message);
    throw error;
  }
*/

/**
 * ðŸ›’ Tekil E-ticaret Analizi - GÃ¼ven Skoru
 * @param {string} website - Website URL'i
 * @returns {string} - E-ticaret skoru
 */
function analyzeEcommerce(website) {
  try {
    // URL'yi temizle ve doÄŸrula
    let url = website.toString().trim();
    
    if (!url || url === '') {
      return 'BoÅŸ URL';
    }
    
    // Basit URL temizleme
    url = url.replace(/^https?:\/\//, ''); // http:// veya https:// kaldÄ±r
    url = url.replace(/^www\./, ''); // www. kaldÄ±r
    url = url.replace(/\/$/, ''); // Sondaki / kaldÄ±r
    
    // URL'yi yeniden oluÅŸtur
    url = 'https://' + url;
    
    // Basit URL doÄŸrulama
    if (!url.includes('.') || url.length < 5) {
      return 'GeÃ§ersiz URL';
    }
    
    // HTML kaynak kodunu al - yÃ¶nlendirmeleri takip et
    const response = UrlFetchApp.fetch(url, {
      muteHttpExceptions: true,
      timeout: 10000,
      followRedirects: true
    });
    
    const statusCode = response.getResponseCode();
    
    // HTTP Status kontrolÃ¼ - Ã‡ok daha esnek yaklaÅŸÄ±m
    if (statusCode >= 400) {
      if (statusCode === 404) {
        // 404 iÃ§in HTML iÃ§eriÄŸini kontrol et
        console.log('404 tespit edildi, HTML iÃ§eriÄŸi kontrol edilecek');
      } else if (statusCode === 403) {
        console.log('403 tespit edildi, devam ediliyor');
      } else if (statusCode === 500) {
        console.log('500 tespit edildi, devam ediliyor');
      } else if (statusCode === 429) {
        // Sosyal medya iÃ§in Ã¶zel kontrol
        if (url.includes('instagram.com') || url.includes('facebook.com') || url.includes('twitter.com') || url.includes('youtube.com') || url.includes('linkedin.com')) {
          return 'Sosyal Medya';
        } else {
          console.log('Rate Limit tespit edildi, devam ediliyor');
        }
      } else {
        console.log(`HTTP ${statusCode} tespit edildi, devam ediliyor`);
      }
    }
    
    const html = response.getContentText();
    
    if (!html || html.length < 50) {
      return 'BoÅŸ Sayfa';
    }
    
    // HTML iÃ§eriÄŸinde hata sayfasÄ± kontrolÃ¼ - Ã‡ok daha esnek
    const lowerHtml = html.toLowerCase();
    const isReal404 = (
      lowerHtml.includes('404') && 
      (lowerHtml.includes('sayfa bulunamadÄ±') || 
       lowerHtml.includes('page not found') ||
       lowerHtml.includes('error 404') ||
       lowerHtml.includes('not found') ||
       lowerHtml.includes('bulunamadÄ±') ||
       lowerHtml.includes('404 error')) &&
      html.length < 1000 // Ã‡ok daha kÄ±sa iÃ§erik
    );
    
    if (isReal404) {
      console.log('GerÃ§ek 404 sayfasÄ± tespit edildi');
      return '404 Sayfa BulunamadÄ±';
    }
    
    // E-ticaret Tespit AlgoritmasÄ±
    const ecommercePatterns = {
      // GÃ¼Ã§lÃ¼ E-ticaret Ä°mzalarÄ± (5 puan)
      strong: [
        'sepet', 'cart', 'basket', 'shopping cart',
        'Ã¶deme', 'payment', 'checkout',
        'kredi kartÄ±', 'credit card', 'debit card',
        'sipariÅŸ', 'order', 'purchase',
        'add to cart', 'sepete ekle', 'buy now', 'ÅŸimdi al',
        'woocommerce', 'shopify', 'magento', 'opencart',
        'ideasoft', 'ticimax', 't-soft', 'softtr', 'ikas'
      ],
      
      // Orta GÃ¼Ã§lÃ¼ E-ticaret Ä°mzalarÄ± (3 puan)
      medium: [
        'Ã¼rÃ¼n', 'product', 'item',
        'fiyat', 'price', 'cost',
        'â‚º', '$', 'â‚¬', 'tl',
        'kategori', 'category',
        'stok', 'stock', 'inventory',
        'kargo', 'shipping', 'delivery',
        'indirim', 'discount', 'sale'
      ],
      
      // ZayÄ±f E-ticaret Ä°mzalarÄ± (1 puan)
      weak: [
        'maÄŸaza', 'store', 'shop',
        'alÄ±ÅŸveriÅŸ', 'shopping',
        'satÄ±n al', 'buy', 'purchase',
        'mÃ¼ÅŸteri', 'customer',
        'hesap', 'account',
        'giriÅŸ', 'login', 'register'
      ]
    };
    
    let totalScore = 0;
    let maxPossibleScore = 0;
    
    // Her kategori iÃ§in skor hesapla
    for (const [strength, patterns] of Object.entries(ecommercePatterns)) {
      const points = strength === 'strong' ? 5 : strength === 'medium' ? 3 : 1;
      
      for (const pattern of patterns) {
        maxPossibleScore += points;
        if (lowerHtml.includes(pattern.toLowerCase())) {
          totalScore += points;
        }
      }
    }
    
    // GÃ¼ven skorunu hesapla (0-100%)
    const confidenceScore = Math.round((totalScore / maxPossibleScore) * 100);
    
    // Skor kategorileri
    if (confidenceScore >= 80) {
      return `${confidenceScore}% - E-ticaret`;
    } else if (confidenceScore >= 50) {
      return `${confidenceScore}% - Muhtemelen E-ticaret`;
    } else if (confidenceScore >= 20) {
      return `${confidenceScore}% - E-ticaret Ä°zi Var`;
    } else {
      return `${confidenceScore}% - E-ticaret Yok`;
    }
    
  } catch (error) {
    console.error('âŒ E-ticaret analiz hatasÄ±:', error);
    return 'EriÅŸilemiyor';
  }
}

/**
 * âš¡ Site HÄ±z Testi - Basit HÄ±z Ã–lÃ§Ã¼mÃ¼
 * @param {Object} parameters - Fonksiyon parametreleri
 * @returns {Object} - SonuÃ§ objesi
 */
/* function testSiteHizi(parameters) {  // removed old menu item (disabled)
  console.log('âš¡ Site HÄ±z Testi baÅŸlatÄ±lÄ±yor:', parameters);
  
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const sheetName = sheet.getName();
    
    // Sayfa kontrolÃ¼ - Herhangi bir sayfada Ã§alÄ±ÅŸabilir
    console.log('ðŸ“Š Analiz edilecek sayfa:', sheetName);
    
    // Range kontrolÃ¼ - SeÃ§im yoksa tÃ¼m sayfa
    let startRow = 2;
    let endRow = sheet.getLastRow();
    let rowCount = endRow - startRow + 1;
    
    const range = sheet.getActiveRange();
    if (range) {
      startRow = range.getRow();
      endRow = range.getLastRow();
      rowCount = endRow - startRow + 1;
      
      if (startRow === 1) {
        startRow = 2;
        rowCount = endRow - startRow + 1;
      }
    }
    
    if (rowCount <= 0) {
      throw new Error('Test edilecek satÄ±r bulunamadÄ±');
    }
    
    console.log(`ðŸ“Š ${rowCount} satÄ±r test edilecek (${startRow}-${endRow})`);
    
    // Progress mesajÄ±
    const ui = SpreadsheetApp.getUi();
    ui.alert(`${rowCount} satÄ±r test ediliyor...\nLÃ¼tfen bekleyin.`);
    
    // Website kolonunu bul
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const websiteIndex = headers.findIndex(header => 
      header && (header.toString().toLowerCase().includes('website') || 
                header.toString().toLowerCase().includes('site') || 
                header.toString().toLowerCase().includes('url'))
    );
    
    if (websiteIndex === -1) {
      throw new Error('Website kolonu bulunamadÄ±. LÃ¼tfen Website, Site veya URL kolonu ekleyin.');
    }
    
    // Site HÄ±zÄ± kolonunu bul veya oluÅŸtur
    let speedIndex = headers.findIndex(header => header === 'Site HÄ±zÄ±');
    
    if (speedIndex === -1) {
      const lastColumn = sheet.getLastColumn();
      sheet.getRange(1, lastColumn + 1).setValue('Site HÄ±zÄ±');
      speedIndex = lastColumn;
      console.log('âœ… Site HÄ±zÄ± kolonu eklendi');
    }
    
    // Performans optimizasyonu
    const BATCH_SIZE = Math.min(25, rowCount);
    let processedCount = 0;
    let errorCount = 0;
    
    // Her batch iÃ§in
    for (let i = 0; i < rowCount; i += BATCH_SIZE) {
      const batchEnd = Math.min(i + BATCH_SIZE, rowCount);
      const batchSize = batchEnd - i;
      
      console.log(`ðŸ”„ Batch ${Math.floor(i/BATCH_SIZE) + 1}: ${batchSize} satÄ±r iÅŸleniyor`);
      
      // Batch iÃ§indeki her satÄ±r iÃ§in
      for (let j = 0; j < batchSize; j++) {
        const currentRow = startRow + i + j;
        
        try {
          const website = sheet.getRange(currentRow, websiteIndex + 1).getValue();
          
          if (website && website.toString().trim() !== '') {
            const speedResult = measureSiteSpeed(website.toString());
            
            // Sonucu yaz
            sheet.getRange(currentRow, speedIndex + 1).setValue(speedResult);
            
            processedCount++;
          }
          
        } catch (error) {
          console.error(`âŒ SatÄ±r ${currentRow} test hatasÄ±:`, error);
          sheet.getRange(currentRow, speedIndex + 1).setValue('EriÅŸilemiyor');
          errorCount++;
        }
        
        // Her 5 satÄ±rda bir progress
        if ((processedCount + errorCount) % 5 === 0) {
          console.log(`âœ… ${processedCount} baÅŸarÄ±lÄ±, ${errorCount} hatalÄ±`);
        }
      }
      
      // Batch arasÄ± bekleme
      Utilities.sleep(200);
    }
    
    console.log(`âœ… HÄ±z Testi tamamlandÄ±: ${processedCount} baÅŸarÄ±lÄ±, ${errorCount} hatalÄ±`);
    ui.alert(`HÄ±z Testi tamamlandÄ±!\nâœ… ${processedCount} baÅŸarÄ±lÄ±\nâŒ ${errorCount} hatalÄ±`);
    
    return {
      success: true,
      processedCount: processedCount,
      errorCount: errorCount,
      totalRows: rowCount
    };
    
  } catch (error) {
    console.error('âŒ HÄ±z Testi hatasÄ±:', error);
    SpreadsheetApp.getUi().alert('HÄ±z Testi sÄ±rasÄ±nda hata oluÅŸtu: ' + error.message);
    throw error;
  }
*/

/**
 * âš¡ Tekil Site HÄ±z Ã–lÃ§Ã¼mÃ¼ - Basit Metrik
 * @param {string} website - Website URL'i
 * @returns {string} - HÄ±z sonucu
 */
function measureSiteSpeed(website) {
  try {
    // URL'yi temizle ve doÄŸrula
    let url = website.toString().trim();
    
    if (!url || url === '') {
      return 'BoÅŸ URL';
    }
    
    // Basit URL temizleme
    url = url.replace(/^https?:\/\//, ''); // http:// veya https:// kaldÄ±r
    url = url.replace(/^www\./, ''); // www. kaldÄ±r
    url = url.replace(/\/$/, ''); // Sondaki / kaldÄ±r
    
    // URL'yi yeniden oluÅŸtur
    url = 'https://' + url;
    
    // Basit URL doÄŸrulama
    if (!url.includes('.') || url.length < 5) {
      return 'GeÃ§ersiz URL';
    }
    
    // BaÅŸlangÄ±Ã§ zamanÄ±
    const startTime = new Date().getTime();
    
    // HTTP isteÄŸi
    const response = UrlFetchApp.fetch(url, {
      muteHttpExceptions: true,
      timeout: 10000,
      followRedirects: true
    });
    
    // BitiÅŸ zamanÄ±
    const endTime = new Date().getTime();
    const responseTime = endTime - startTime;
    
    // HTTP durum kodu
    const statusCode = response.getResponseCode();
    
    // HTTP Status kontrolÃ¼ - Ã‡ok daha esnek yaklaÅŸÄ±m
    if (statusCode >= 400) {
      if (statusCode === 404) {
        // 404 iÃ§in devam et - belki gerÃ§ekten eriÅŸilebilir
        console.log('404 tespit edildi, devam ediliyor');
      } else if (statusCode === 403) {
        console.log('403 tespit edildi, devam ediliyor');
      } else if (statusCode === 500) {
        console.log('500 tespit edildi, devam ediliyor');
      } else if (statusCode === 429) {
        // Sosyal medya iÃ§in Ã¶zel kontrol
        if (url.includes('instagram.com') || url.includes('facebook.com') || url.includes('twitter.com') || url.includes('youtube.com') || url.includes('linkedin.com')) {
          return 'Sosyal Medya';
        } else {
          console.log('Rate Limit tespit edildi, devam ediliyor');
        }
      } else {
        console.log(`HTTP ${statusCode} tespit edildi, devam ediliyor`);
      }
    }
    
    // Ä°Ã§erik boyutu
    const contentLength = response.getHeaders()['content-length'];
    const sizeKB = contentLength ? Math.round(contentLength / 1024) : 'Bilinmiyor';
    
    // HÄ±z kategorileri
    if (responseTime < 1000) {
      return `${responseTime}ms (Ã‡ok HÄ±zlÄ±)`;
    } else if (responseTime < 3000) {
      return `${responseTime}ms (HÄ±zlÄ±)`;
    } else if (responseTime < 5000) {
      return `${responseTime}ms (Orta)`;
    } else if (responseTime < 10000) {
      return `${responseTime}ms (YavaÅŸ)`;
    } else {
      return `${responseTime}ms (Ã‡ok YavaÅŸ)`;
    }
    
  } catch (error) {
    console.error('âŒ HÄ±z Ã¶lÃ§Ã¼m hatasÄ±:', error);
    return 'EriÅŸilemiyor';
  }
}

/**
 * ðŸŽ›ï¸ Admin MenÃ¼sÃ¼ne Website Analiz ButonlarÄ±nÄ± Ekle
 */
function addWebsiteAnalysisToAdminMenu() {
  try {
    const ui = SpreadsheetApp.getUi();
    
    // Mevcut Admin menÃ¼sÃ¼nÃ¼ bul
    const menus = ui.getMenus();
    let adminMenu = null;
    
    for (const menu of menus) {
      if (menu.getName() === 'Admin') {
        adminMenu = menu;
        break;
      }
    }
    
    if (!adminMenu) {
      console.log('Admin menÃ¼sÃ¼ bulunamadÄ±, yeni menÃ¼ oluÅŸturuluyor');
      ui.createMenu('Admin')
        .addItem('ðŸ” CMS ALTYAPI', 'detectCMSAltyapisi')
        .addItem('ðŸ›’ E-TÄ°CARET Ä°ZÄ°', 'detectEcommerceIzi')
        .addItem('âš¡ HIZ TESTÄ°', 'testSiteHizi')
        .addSeparator()
        .addItem('ðŸ§ª Tarih SÄ±ralama Test', 'testDateSorting')
        .addSeparator()
        .addItem('Yeni Tablo oluÅŸtur', 'showCreateTableDialog')
        .addToUi();
    } else {
      console.log('Admin menÃ¼sÃ¼ne Website Analiz butonlarÄ± ekleniyor');
      // Mevcut Admin menÃ¼sÃ¼ne butonlarÄ± ekle
      // Not: Google Apps Script'te mevcut menÃ¼ye dinamik ekleme yapÄ±lamÄ±yor
      // Bu yÃ¼zden menÃ¼yÃ¼ yeniden oluÅŸturmamÄ±z gerekiyor
    }
    
    console.log('âœ… Website Analiz butonlarÄ± Admin menÃ¼sÃ¼ne eklendi');
    
  } catch (error) {
    console.error('âŒ Admin menÃ¼sÃ¼ gÃ¼ncelleme hatasÄ±:', error);
  }
}

// ========================================
// ðŸŽ›ï¸ WEBSITE ANALÄ°Z SÄ°STEMÄ° - BAÅžLATMA
// ========================================

console.log('ðŸ” Website Analiz Sistemi yÃ¼klendi');
console.log('ðŸ“Š CMS AltyapÄ±sÄ± fonksiyonlarÄ± hazÄ±r');
console.log('ðŸ›’ E-ticaret Ä°zi fonksiyonlarÄ± hazÄ±r');
console.log('âš¡ HÄ±z Testi fonksiyonlarÄ± hazÄ±r');

// CMS fonksiyonlarÄ± src/managers/cms_detector.gs dosyasÄ±na taÅŸÄ±ndÄ±

// ========================================
// ðŸ§½ MÃœKERRER SÄ°LME (ONAYLI)
// ========================================
function deleteDuplicateRowsWithConfirm(parameters) {
  console.log('Function started:', parameters);
  try {
    if (!validateInput(parameters || {})) {
      throw new Error('Invalid input provided');
    }
    const ui = SpreadsheetApp.getUi();
    const sheet = SpreadsheetApp.getActiveSheet();
    const data = sheet.getDataRange().getValues();
    if (data.length <= 1) {
      ui.alert('Bilgi', 'Veri bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: true, deleted: 0 };
    }
    const headers = data[0];
    const rows = data.slice(1);
    const companyIdx = findColumnIndex(headers, ['Company name', 'Company Name']);
    const phoneIdx = findColumnIndex(headers, ['Phone']);
    if (companyIdx === -1) {
      throw new Error("'Company name' kolonu bulunamadÄ±");
    }
    const keyToRowIndexes = new Map();
    for (let i = 0; i < rows.length; i++) {
      const r = rows[i];
      const rowNumber = i + 2;
      const company = (r[companyIdx] || '').toString().trim();
      if (!company) continue;
      const phoneRaw = phoneIdx !== -1 ? (r[phoneIdx] || '').toString() : '';
      const phoneDigits = phoneRaw.replace(/\D+/g, '');
      const phoneKey = phoneDigits.length >= 7 ? phoneDigits : '';
      const key = `${company.toLowerCase()}|${phoneKey}`;
      if (!keyToRowIndexes.has(key)) keyToRowIndexes.set(key, []);
      keyToRowIndexes.get(key).push(rowNumber);
    }
    const dupGroups = [...keyToRowIndexes.entries()].filter(([, arr]) => arr.length > 1);
    if (dupGroups.length === 0) {
      ui.alert('MÃ¼kerrer bulunamadÄ±');
      return { success: true, deleted: 0 };
    }
    let deleted = 0;
    for (const [key, rowNums] of dupGroups) {
      const sorted = [...rowNums].sort((a,b) => b - a);
      const keep = Math.min(...sorted);
      for (const rowNum of sorted) {
        if (rowNum === keep) continue;
        const rowValues = sheet.getRange(rowNum, 1, 1, sheet.getLastColumn()).getValues()[0];
        const companyVal = rowValues[companyIdx];
        const phoneVal = phoneIdx !== -1 ? rowValues[phoneIdx] : '';
        const msg = `SatÄ±r ${rowNum} bulundu:\nÅžirket: ${companyVal || ''}\nTelefon: ${phoneVal || ''}\nBu mÃ¼kerrer kaydÄ± silmek istiyor musunuz?`;
        const res = ui.alert('MÃ¼kerrer Sil', msg, ui.ButtonSet.YES_NO);
        if (res === ui.Button.YES) {
          sheet.deleteRow(rowNum);
          deleted++;
        }
      }
    }
    ui.alert('Ä°ÅŸlem tamam', `${deleted} satÄ±r silindi.`, ui.ButtonSet.OK);
    console.log('Processing complete:', { deleted });
    return { success: true, deleted };
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/**
 * ðŸ—‘ï¸ MÃ¼kerrerleri Bul ve Hepsini Sil (Orijinal + Kopya TÃ¼mÃ¼nÃ¼)
 * Her mÃ¼kerrer grubundaki TÃœM satÄ±rlarÄ± siler (hiÃ§birini tutmaz)
 */
function deleteAllDuplicatesAuto(parameters) {
  console.log('Function started:', parameters);
  try {
    if (!validateInput(parameters || {})) {
      throw new Error('Invalid input provided');
    }
    
    const ui = SpreadsheetApp.getUi();
    const sheet = SpreadsheetApp.getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      ui.alert('Bilgi', 'Veri bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: true, deleted: 0 };
    }
    
    const headers = data[0];
    const rows = data.slice(1);
    const companyIdx = findColumnIndex(headers, ['Company name', 'Company Name']);
    const phoneIdx = findColumnIndex(headers, ['Phone']);
    
    if (companyIdx === -1) {
      throw new Error("'Company name' kolonu bulunamadÄ±");
    }
    
    // MÃ¼kerrer gruplarÄ±nÄ± bul
    const keyToRowIndexes = new Map();
    for (let i = 0; i < rows.length; i++) {
      const r = rows[i];
      const rowNumber = i + 2;
      const company = (r[companyIdx] || '').toString().trim();
      if (!company) continue;
      
      const phoneRaw = phoneIdx !== -1 ? (r[phoneIdx] || '').toString() : '';
      const phoneDigits = phoneRaw.replace(/\D+/g, '');
      const phoneKey = phoneDigits.length >= 7 ? phoneDigits : '';
      const key = `${company.toLowerCase()}|${phoneKey}`;
      
      if (!keyToRowIndexes.has(key)) keyToRowIndexes.set(key, []);
      keyToRowIndexes.get(key).push(rowNumber);
    }
    
    // Sadece mÃ¼kerrer gruplarÄ± (2 veya daha fazla satÄ±r)
    const dupGroups = [...keyToRowIndexes.entries()].filter(([, arr]) => arr.length > 1);
    
    if (dupGroups.length === 0) {
      ui.alert('MÃ¼kerrer bulunamadÄ±', 'Sayfada tekrar eden kayÄ±t bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: true, deleted: 0 };
    }
    
    // Silinecek tÃ¼m satÄ±r numaralarÄ±nÄ± topla (OPTÄ°MÄ°ZE: data array'inden oku, sheet'ten okuma)
    const rowsToDelete = [];
    const groupDetails = [];
    
    for (const [key, rowNums] of dupGroups) {
      const [companyKey, phoneKey] = key.split('|');
      const sortedRows = [...rowNums].sort((a, b) => a - b);
      
      // OPTÄ°MÄ°ZE: data array'inden oku (sheet.getRange Ã§ok yavaÅŸ!)
      const sampleCompany = companyKey || '';
      const samplePhone = phoneKey || '';
      
      groupDetails.push({
        company: sampleCompany,
        phone: samplePhone,
        count: sortedRows.length,
        rows: sortedRows
      });
      
      // TÃœM satÄ±rlarÄ± silinecek listesine ekle
      rowsToDelete.push(...sortedRows);
    }
    
    // Ã–zet mesaj hazÄ±rla (hÄ±zlÄ±)
    const totalGroups = dupGroups.length;
    const totalRows = rowsToDelete.length;
    
    let summaryMsg = `MÃ¼kerrer tarama sonucu:\n\n`;
    summaryMsg += `â€¢ Toplam tekrar grup: ${totalGroups}\n`;
    summaryMsg += `â€¢ Silinecek toplam satÄ±r: ${totalRows}\n\n`;
    
    if (groupDetails.length <= 10) {
      summaryMsg += `Gruplar:\n`;
      for (let i = 0; i < groupDetails.length; i++) {
        const g = groupDetails[i];
        summaryMsg += `\n${i + 1}. "${g.company}" (${g.count} adet): SatÄ±r ${g.rows.join(', ')}`;
      }
    } else {
      summaryMsg += `Ã–rnek gruplar (ilk 5):\n`;
      for (let i = 0; i < 5; i++) {
        const g = groupDetails[i];
        summaryMsg += `\n${i + 1}. "${g.company}" (${g.count} adet): SatÄ±r ${g.rows.join(', ')}`;
      }
      summaryMsg += `\n\n... ve ${groupDetails.length - 5} grup daha`;
    }
    
    summaryMsg += `\n\nâš ï¸ DÄ°KKAT: Her gruptaki TÃœM satÄ±rlar silinecek (orijinal + kopyalar).`;
    summaryMsg += `\n\nDevam etmek istiyor musunuz?`;
    
    // Onay al
    const confirm = ui.alert('ðŸ—‘ï¸ MÃ¼kerrerleri Hepsini Sil', summaryMsg, ui.ButtonSet.YES_NO);
    
    if (confirm !== ui.Button.YES) {
      ui.alert('Ä°ptal edildi', 'Silme iÅŸlemi iptal edildi.', ui.ButtonSet.OK);
      return { success: false, deleted: 0, cancelled: true };
    }
    
    // OPTÄ°MÄ°ZE: Toplu silme - satÄ±r numaralarÄ±nÄ± kÃ¼Ã§Ã¼kten bÃ¼yÃ¼ÄŸe sÄ±rala
    rowsToDelete.sort((a, b) => a - b);
    
    // ArdÄ±ÅŸÄ±k satÄ±rlarÄ± grupla ve batch sil
    let deleted = 0;
    let i = 0;
    
    while (i < rowsToDelete.length) {
      const startRow = rowsToDelete[i];
      let endRow = startRow;
      let consecutiveCount = 1;
      
      // ArdÄ±ÅŸÄ±k satÄ±rlarÄ± bul
      while (i + consecutiveCount < rowsToDelete.length && 
             rowsToDelete[i + consecutiveCount] === startRow + consecutiveCount) {
        endRow = rowsToDelete[i + consecutiveCount];
        consecutiveCount++;
      }
      
      // Toplu sil (ardÄ±ÅŸÄ±k satÄ±rlar iÃ§in)
      if (consecutiveCount === 1) {
        // Tek satÄ±r - normal sil
        try {
          sheet.deleteRow(startRow);
          deleted++;
        } catch (err) {
          console.error(`SatÄ±r ${startRow} silinirken hata:`, err);
        }
      } else {
        // Ã‡oklu ardÄ±ÅŸÄ±k satÄ±r - batch sil
        try {
          sheet.deleteRows(startRow, consecutiveCount);
          deleted += consecutiveCount;
        } catch (err) {
          console.error(`SatÄ±rlar ${startRow}-${endRow} silinirken hata:`, err);
          // Fallback: tek tek sil
          for (let j = startRow; j <= endRow; j++) {
            try {
              sheet.deleteRow(j);
              deleted++;
            } catch (e) {
              console.error(`SatÄ±r ${j} silinirken hata:`, e);
            }
          }
        }
      }
      
      i += consecutiveCount;
    }
    
    ui.alert('Ä°ÅŸlem tamamlandÄ±', `${deleted} satÄ±r baÅŸarÄ±yla silindi.\n${totalGroups} mÃ¼kerrer grup temizlendi.`, ui.ButtonSet.OK);
    console.log('Processing complete:', { deleted, totalGroups, totalRows });
    return { success: true, deleted, totalGroups, totalRows };
    
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

// ========================================
// ðŸ“… OTOMATÄ°K TARÄ°H SIRALAMA FONKSÄ°YONLARI
// ========================================

/**
 * ðŸ“… RandevularÄ±m sayfasÄ±nÄ± tarihe gÃ¶re sÄ±ralar (en yeni Ã¶nce)
 * @param {Sheet} sheet - RandevularÄ±m sayfasÄ±
 */
function sortRandevularimByDate(sheet) {
  try {
    console.log('ðŸ“… RandevularÄ±m tarihe gÃ¶re sÄ±ralanÄ±yor...');
    
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const randevuTarihiIndex = headers.indexOf('Randevu Tarihi');
    
    if (randevuTarihiIndex === -1) {
      console.log('âš ï¸ Randevu Tarihi kolonu bulunamadÄ±, sÄ±ralama atlanÄ±yor');
      return;
    }
    
    const dateColumnIndex = randevuTarihiIndex + 1;
    const dateColumnName = 'Randevu Tarihi';
    
    console.log(`ðŸ“… SÄ±ralama kolonu: ${dateColumnName} (${dateColumnIndex})`);
    
    // Veri aralÄ±ÄŸÄ±nÄ± al (header hariÃ§)
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('ðŸ“… SÄ±ralanacak veri yok');
      return;
    }
    
    const dataRange = sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn());
    
    // Tarihe gÃ¶re sÄ±rala (en eski Ã¶nce - kronolojik)
    // Google Sheets sort() fonksiyonu tarih formatÄ±nÄ± doÄŸru anlayamadÄ±ÄŸÄ± iÃ§in manuel sÄ±ralama yapÄ±yoruz
    const data = sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn()).getValues();
    
    // Tarih kolonundaki verileri al ve sÄ±rala
    const dateData = data.map((row, index) => {
      const dateValue = row[randevuTarihiIndex];
      return {
        rowIndex: index + 2, // +2 Ã§Ã¼nkÃ¼ header 1. satÄ±r ve data 2. satÄ±rdan baÅŸlÄ±yor
        dateValue: dateValue,
        originalRow: row
      };
    });
    
    // Tarihleri kronolojik sÄ±raya gÃ¶re sÄ±rala (en eski Ã¶nce)
    // BoÅŸ tarihleri en sona koy
    dateData.sort((a, b) => {
      // EÄŸer a'nÄ±n tarihi boÅŸsa, b'den sonra koy
      if (!a.dateValue || a.dateValue === '') return 1;
      // EÄŸer b'nin tarihi boÅŸsa, a'dan sonra koy
      if (!b.dateValue || b.dateValue === '') return -1;
      
      // Her ikisi de doluysa tarihe gÃ¶re sÄ±rala
      let dateA, dateB;
      
      // Tarih deÄŸerini kontrol et ve uygun ÅŸekilde dÃ¶nÃ¼ÅŸtÃ¼r
      if (a.dateValue instanceof Date) {
        dateA = a.dateValue;
      } else if (typeof a.dateValue === 'string') {
        dateA = new Date(a.dateValue.split('.').reverse().join('-'));
      } else {
        dateA = new Date(a.dateValue);
      }
      
      if (b.dateValue instanceof Date) {
        dateB = b.dateValue;
      } else if (typeof b.dateValue === 'string') {
        dateB = new Date(b.dateValue.split('.').reverse().join('-'));
      } else {
        dateB = new Date(b.dateValue);
      }
      
      return dateA - dateB; // En eski Ã¶nce
    });
    
    // SÄ±ralanmÄ±ÅŸ verileri sayfaya yaz
    const sortedData = dateData.map(item => item.originalRow);
    sheet.getRange(2, 1, sortedData.length, sheet.getLastColumn()).setValues(sortedData);
    
    console.log(`âœ… RandevularÄ±m ${dateColumnName} kolonuna gÃ¶re sÄ±ralandÄ± (en eski Ã¶nce - kronolojik)`);
    
  } catch (error) {
    console.error('âŒ RandevularÄ±m sÄ±ralama hatasÄ±:', error);
  }
}

/**
 * ðŸ“… FÄ±rsatlarÄ±m sayfasÄ±nÄ± tarihe gÃ¶re sÄ±ralar (en yeni Ã¶nce)
 * @param {Sheet} sheet - FÄ±rsatlarÄ±m sayfasÄ±
 */
function sortFirsatlarimByDate(sheet) {
  try {
    console.log('ðŸ“… FÄ±rsatlarÄ±m tarihe gÃ¶re sÄ±ralanÄ±yor...');
    
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const firsatTarihiIndex = headers.indexOf('FÄ±rsat Tarihi');
    
    if (firsatTarihiIndex === -1) {
      console.log('âš ï¸ FÄ±rsat Tarihi kolonu bulunamadÄ±, sÄ±ralama atlanÄ±yor');
      return;
    }
    
    const dateColumnIndex = firsatTarihiIndex + 1;
    const dateColumnName = 'FÄ±rsat Tarihi';
    
    console.log(`ðŸ“… SÄ±ralama kolonu: ${dateColumnName} (${dateColumnIndex})`);
    
    // Veri aralÄ±ÄŸÄ±nÄ± al (header hariÃ§)
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      console.log('ðŸ“… SÄ±ralanacak veri yok');
      return;
    }
    
    const dataRange = sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn());
    
    // Tarihe gÃ¶re sÄ±rala (en eski Ã¶nce - kronolojik)
    // Google Sheets sort() fonksiyonu tarih formatÄ±nÄ± doÄŸru anlayamadÄ±ÄŸÄ± iÃ§in manuel sÄ±ralama yapÄ±yoruz
    const data = sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn()).getValues();
    
    // Tarih kolonundaki verileri al ve sÄ±rala
    const dateData = data.map((row, index) => {
      const dateValue = row[firsatTarihiIndex];
      return {
        rowIndex: index + 2, // +2 Ã§Ã¼nkÃ¼ header 1. satÄ±r ve data 2. satÄ±rdan baÅŸlÄ±yor
        dateValue: dateValue,
        originalRow: row
      };
    });
    
    // Tarihleri kronolojik sÄ±raya gÃ¶re sÄ±rala (en eski Ã¶nce)
    // BoÅŸ tarihleri en sona koy
    dateData.sort((a, b) => {
      // EÄŸer a'nÄ±n tarihi boÅŸsa, b'den sonra koy
      if (!a.dateValue || a.dateValue === '') return 1;
      // EÄŸer b'nin tarihi boÅŸsa, a'dan sonra koy
      if (!b.dateValue || b.dateValue === '') return -1;
      
      // Her ikisi de doluysa tarihe gÃ¶re sÄ±rala
      let dateA, dateB;
      
      // Tarih deÄŸerini kontrol et ve uygun ÅŸekilde dÃ¶nÃ¼ÅŸtÃ¼r
      if (a.dateValue instanceof Date) {
        dateA = a.dateValue;
      } else if (typeof a.dateValue === 'string') {
        dateA = new Date(a.dateValue.split('.').reverse().join('-'));
      } else {
        dateA = new Date(a.dateValue);
      }
      
      if (b.dateValue instanceof Date) {
        dateB = b.dateValue;
      } else if (typeof b.dateValue === 'string') {
        dateB = new Date(b.dateValue.split('.').reverse().join('-'));
      } else {
        dateB = new Date(b.dateValue);
      }
      
      return dateA - dateB; // En eski Ã¶nce
    });
    
    // SÄ±ralanmÄ±ÅŸ verileri sayfaya yaz
    const sortedData = dateData.map(item => item.originalRow);
    sheet.getRange(2, 1, sortedData.length, sheet.getLastColumn()).setValues(sortedData);
    
    console.log(`âœ… FÄ±rsatlarÄ±m ${dateColumnName} kolonuna gÃ¶re sÄ±ralandÄ± (en eski Ã¶nce - kronolojik)`);
    
  } catch (error) {
    console.error('âŒ FÄ±rsatlarÄ±m sÄ±ralama hatasÄ±:', error);
  }
}

// ========================================
// ðŸ§¹ DATA CLEANUP FUNCTIONS
// ========================================

/**
 * "Telefon olmayanlarÄ± sil" - Aktif sayfada Phone kolonu boÅŸ/geÃ§ersiz olan satÄ±rlarÄ± siler
 * @param {Object} parameters - { scope?: 'all' | 'selection' }
 * @returns {Object} - SonuÃ§ bilgisi
 */
function deleteRowsWithoutPhone(parameters) {
  console.log('Function started: deleteRowsWithoutPhone', parameters);
  
  try {
    if (!validateInput(parameters || {})) {
      throw new Error('Invalid input provided');
    }
    
    const sheet = SpreadsheetApp.getActiveSheet();
    const ui = SpreadsheetApp.getUi();
    const sheetName = sheet.getName();
    console.log('ðŸ§¹ Target sheet:', sheetName);
    
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const phoneIdx = headers.indexOf('Phone');
    if (phoneIdx === -1) {
      throw new Error("'Phone' kolonu bulunamadÄ±");
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      ui.alert('Silinecek satÄ±r bulunamadÄ±');
      return { success: true, deleted: 0 };
    }
    
    // Kapsam: seÃ§im varsa seÃ§im, yoksa tÃ¼m veri
    const range = sheet.getActiveRange();
    let startRow = 2;
    let endRow = lastRow;
    if (range && range.getRow() > 1) {
      startRow = range.getRow();
      endRow = range.getLastRow();
      if (startRow === 1) startRow = 2;
    }
    
    console.log(`ðŸ”Ž Scan rows: ${startRow}-${endRow}`);
    const values = sheet.getRange(startRow, 1, endRow - startRow + 1, sheet.getLastColumn()).getValues();
    
    // SÄ±ralÄ± silme iÃ§in alt->Ã¼st
    const rowsToDelete = [];
    for (let i = 0; i < values.length; i++) {
      const row = values[i];
      const phoneRaw = row[phoneIdx];
      const phoneStr = (phoneRaw || '').toString();
      const digits = phoneStr.replace(/\D+/g, '');
      const hasValidPhone = digits.length >= 7; // esnek eÅŸik
      if (!hasValidPhone) {
        rowsToDelete.push(startRow + i);
      }
    }
    
    console.log('ðŸ—‘ï¸ Rows to delete (no phone):', rowsToDelete);
    
    // Sil
    let deleted = 0;
    for (let i = rowsToDelete.length - 1; i >= 0; i--) {
      sheet.deleteRow(rowsToDelete[i]);
      deleted++;
    }
    
    ui.alert(`ðŸ“µ Telefonu olmayan satÄ±rlar silindi: ${deleted}`);
    console.log('Processing complete:', { deleted });
    
    return { success: true, deleted };
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/**
 * "Website olmayanlarÄ± sil" - Aktif sayfada Website kolonu boÅŸ/geÃ§ersiz olan satÄ±rlarÄ± siler
 * @param {Object} parameters - { scope?: 'all' | 'selection' }
 * @returns {Object} - SonuÃ§ bilgisi
 */
function deleteRowsWithoutWebsite(parameters) {
  console.log('Function started: deleteRowsWithoutWebsite', parameters);
  
  try {
    if (!validateInput(parameters || {})) {
      throw new Error('Invalid input provided');
    }
    
    const sheet = SpreadsheetApp.getActiveSheet();
    const ui = SpreadsheetApp.getUi();
    const sheetName = sheet.getName();
    console.log('ðŸ§¹ Target sheet:', sheetName);
    
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const websiteIdx = headers.indexOf('Website');
    if (websiteIdx === -1) {
      throw new Error("'Website' kolonu bulunamadÄ±");
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      ui.alert('Silinecek satÄ±r bulunamadÄ±');
      return { success: true, deleted: 0 };
    }
    
    const range = sheet.getActiveRange();
    let startRow = 2;
    let endRow = lastRow;
    if (range && range.getRow() > 1) {
      startRow = range.getRow();
      endRow = range.getLastRow();
      if (startRow === 1) startRow = 2;
    }
    
    console.log(`ðŸ”Ž Scan rows: ${startRow}-${endRow}`);
    const values = sheet.getRange(startRow, 1, endRow - startRow + 1, sheet.getLastColumn()).getValues();
    
    const rowsToDelete = [];
    for (let i = 0; i < values.length; i++) {
      const row = values[i];
      const websiteRaw = (row[websiteIdx] || '').toString().trim();
      const hasWebsite = websiteRaw.length > 0;
      if (!hasWebsite) {
        rowsToDelete.push(startRow + i);
      }
    }
    
    console.log('ðŸ—‘ï¸ Rows to delete (no website):', rowsToDelete);
    
    let deleted = 0;
    for (let i = rowsToDelete.length - 1; i >= 0; i--) {
      sheet.deleteRow(rowsToDelete[i]);
      deleted++;
    }
    
    ui.alert(`ðŸŒ Websitesi olmayan satÄ±rlar silindi: ${deleted}`);
    console.log('Processing complete:', { deleted });
    
    return { success: true, deleted };
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/**
 * ðŸ§¹ URL Temizle (1. AÅŸama) - Website kolonundaki URL'leri normalize eder
 * - http:// ve https:// ekler
 * - www. kontrolÃ¼ yapar
 * - Trailing slash temizler
 * - GeÃ§ersiz URL'leri dÃ¼zeltir
 */
function urlTemizleTumunu(parameters) {
  console.log('Function started: urlTemizleTumunu', parameters);
  
  try {
    if (!validateInput(parameters || {})) {
      throw new Error('Invalid input provided');
    }
    
    const sheet = SpreadsheetApp.getActiveSheet();
    const ui = SpreadsheetApp.getUi();
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      ui.alert('Bilgi', 'Veri bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: true, updated: 0 };
    }
    
    const headers = data[0];
    const websiteIdx = findColumnIndex(headers, ['Website', 'website']);
    
    if (websiteIdx === -1) {
      ui.alert('Hata', "'Website' kolonu bulunamadÄ±.", ui.ButtonSet.OK);
      return { success: false, updated: 0 };
    }
    
    // URL normalize fonksiyonu
    function normalizeUrl(url) {
      if (!url) return '';
      let cleaned = String(url).trim();
      if (!cleaned) return '';
      
      // BoÅŸluklarÄ± temizle
      cleaned = cleaned.replace(/\s+/g, '');
      
      // zaten normalize edilmiÅŸse atla
      if (/^https?:\/\//i.test(cleaned)) {
        cleaned = cleaned.replace(/\/+$/, ''); // trailing slash temizle
        return cleaned;
      }
      
      // http/https yoksa ekle
      if (!/^https?:\/\//i.test(cleaned)) {
        cleaned = 'https://' + cleaned;
      }
      
      // www. kontrolÃ¼ (isteÄŸe baÄŸlÄ± - zaten varsa dokunma)
      
      // trailing slash temizle
      cleaned = cleaned.replace(/\/+$/, '');
      
      return cleaned;
    }
    
    let updated = 0;
    const updates = [];
    
    // URL'leri kontrol et ve normalize et
    for (let i = 1; i < data.length; i++) {
      const rowNum = i + 1;
      const currentUrl = (data[i][websiteIdx] || '').toString().trim();
      
      if (!currentUrl) continue;
      
      const normalized = normalizeUrl(currentUrl);
      
      if (normalized !== currentUrl && normalized !== '') {
        updates.push({ row: rowNum, old: currentUrl, new: normalized });
      }
    }
    
    if (updates.length === 0) {
      ui.alert('Bilgi', 'Temizlenecek URL bulunamadÄ±. TÃ¼m URL\'ler zaten temiz gÃ¶rÃ¼nÃ¼yor.', ui.ButtonSet.OK);
      return { success: true, updated: 0 };
    }
    
    // Ã–zet gÃ¶ster
    let summaryMsg = `Toplam ${updates.length} URL temizlenecek.\n\n`;
    summaryMsg += `Ã–rnekler (ilk 5):\n`;
    for (let i = 0; i < Math.min(5, updates.length); i++) {
      const u = updates[i];
      summaryMsg += `\nSatÄ±r ${u.row}:\n  "${u.old}"\n  â†’ "${u.new}"`;
    }
    if (updates.length > 5) {
      summaryMsg += `\n\n... ve ${updates.length - 5} URL daha`;
    }
    summaryMsg += `\n\nDevam etmek istiyor musunuz?`;
    
    const confirm = ui.alert('ðŸ§¹ URL Temizle', summaryMsg, ui.ButtonSet.YES_NO);
    
    if (confirm !== ui.Button.YES) {
      ui.alert('Ä°ptal edildi', 'URL temizleme iptal edildi.', ui.ButtonSet.OK);
      return { success: false, updated: 0, cancelled: true };
    }
    
    // URL'leri gÃ¼ncelle
    for (const u of updates) {
      sheet.getRange(u.row, websiteIdx + 1).setValue(u.new);
      updated++;
    }
    
    ui.alert('Ä°ÅŸlem tamamlandÄ±', `${updated} URL baÅŸarÄ±yla temizlendi.`, ui.ButtonSet.OK);
    console.log('Processing complete:', { updated });
    return { success: true, updated };
    
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/**
 * ðŸ—‘ï¸ URL TekrarlarÄ± Sil (2. AÅŸama) - AynÄ± URL'ye sahip mÃ¼kerrer satÄ±rlarÄ± siler
 * Her URL iÃ§in ilk satÄ±rÄ± tutar, diÄŸerlerini siler
 */
function urlTekrarlariniSil(parameters) {
  console.log('Function started: urlTekrarlariniSil', parameters);
  
  try {
    if (!validateInput(parameters || {})) {
      throw new Error('Invalid input provided');
    }
    
    const sheet = SpreadsheetApp.getActiveSheet();
    const ui = SpreadsheetApp.getUi();
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      ui.alert('Bilgi', 'Veri bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: true, deleted: 0 };
    }
    
    const headers = data[0];
    const websiteIdx = findColumnIndex(headers, ['Website', 'website']);
    
    if (websiteIdx === -1) {
      ui.alert('Hata', "'Website' kolonu bulunamadÄ±.", ui.ButtonSet.OK);
      return { success: false, deleted: 0 };
    }
    
    // URL'ye gÃ¶re grupla
    const urlToRows = new Map();
    
    for (let i = 1; i < data.length; i++) {
      const rowNum = i + 1;
      const url = (data[i][websiteIdx] || '').toString().trim().toLowerCase();
      
      if (!url) continue;
      
      if (!urlToRows.has(url)) {
        urlToRows.set(url, []);
      }
      urlToRows.get(url).push(rowNum);
    }
    
    // MÃ¼kerrer URL gruplarÄ± (2 veya daha fazla satÄ±r)
    const dupGroups = [...urlToRows.entries()].filter(([, rows]) => rows.length > 1);
    
    if (dupGroups.length === 0) {
      ui.alert('MÃ¼kerrer bulunamadÄ±', 'AynÄ± URL\'ye sahip tekrar eden satÄ±r bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: true, deleted: 0 };
    }
    
    // Silinecek satÄ±rlarÄ± topla (ilk satÄ±rÄ± tut, diÄŸerlerini sil)
    const rowsToDelete = [];
    const groupDetails = [];
    
    for (const [url, rowNums] of dupGroups) {
      const sortedRows = [...rowNums].sort((a, b) => a - b);
      const keepRow = sortedRows[0]; // Ä°lk satÄ±rÄ± tut
      const deleteRows = sortedRows.slice(1); // DiÄŸerlerini sil
      
      groupDetails.push({
        url: url,
        count: sortedRows.length,
        keep: keepRow,
        delete: deleteRows
      });
      
      rowsToDelete.push(...deleteRows);
    }
    
    // SatÄ±r numaralarÄ±nÄ± bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe sÄ±rala
    rowsToDelete.sort((a, b) => b - a);
    
    const totalGroups = dupGroups.length;
    const totalRows = rowsToDelete.length;
    
    // Ã–zet mesaj
    let summaryMsg = `URL mÃ¼kerrer tarama sonucu:\n\n`;
    summaryMsg += `â€¢ Toplam tekrar grup: ${totalGroups}\n`;
    summaryMsg += `â€¢ Silinecek satÄ±r: ${totalRows}\n`;
    summaryMsg += `â€¢ Korunacak satÄ±r: ${totalGroups}\n\n`;
    summaryMsg += `Ã–rnek gruplar (ilk 5):\n`;
    
    for (let i = 0; i < Math.min(5, groupDetails.length); i++) {
      const g = groupDetails[i];
      summaryMsg += `\n${i + 1}. "${g.url.substring(0, 50)}${g.url.length > 50 ? '...' : ''}"\n`;
      summaryMsg += `   Korunacak: SatÄ±r ${g.keep}\n`;
      summaryMsg += `   Silinecek: SatÄ±r ${g.delete.join(', ')}`;
    }
    
    if (groupDetails.length > 5) {
      summaryMsg += `\n\n... ve ${groupDetails.length - 5} grup daha`;
    }
    
    summaryMsg += `\n\nâš ï¸ Her grupta ilk satÄ±r korunacak, diÄŸerleri silinecek.`;
    summaryMsg += `\n\nDevam etmek istiyor musunuz?`;
    
    const confirm = ui.alert('ðŸ—‘ï¸ URL TekrarlarÄ±nÄ± Sil', summaryMsg, ui.ButtonSet.YES_NO);
    
    if (confirm !== ui.Button.YES) {
      ui.alert('Ä°ptal edildi', 'Silme iÅŸlemi iptal edildi.', ui.ButtonSet.OK);
      return { success: false, deleted: 0, cancelled: true };
    }
    
    // SatÄ±rlarÄ± sil (bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe)
    let deleted = 0;
    for (const rowNum of rowsToDelete) {
      try {
        sheet.deleteRow(rowNum);
        deleted++;
      } catch (err) {
        console.error(`SatÄ±r ${rowNum} silinirken hata:`, err);
      }
    }
    
    ui.alert('Ä°ÅŸlem tamamlandÄ±', `${deleted} satÄ±r baÅŸarÄ±yla silindi.\n${totalGroups} mÃ¼kerrer grup temizlendi.`, ui.ButtonSet.OK);
    console.log('Processing complete:', { deleted, totalGroups });
    return { success: true, deleted, totalGroups };
    
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/**
 * ðŸŽ¨ E-ticaret SÄ±caklÄ±k Analizi - SADECE Category bazÄ±nda Ã§alÄ±ÅŸÄ±r
 * 
 * Algoritma:
 * 1. IdeaSoft var â†’ "IdeaSoft var" (EN Ã–NCELÄ°K)
 * 2. PahalÄ± rakipler var (Ticimax, T-Soft, Ä°kas) â†’ "PahalÄ± rakipler var"
 * 3. Ucuz e-ticaret paketleri var â†’ "Ucuz e-ticaret paketleri var"
 * 4. HiÃ§biri yok â†’ "E-ticaret firmasÄ± yok (silinmeye aday)"
 * 
 * Sadece CMS Grubu sÃ¼tununa yazÄ±lÄ±r, renk yok, Keyword analizi yok.
 */
function generateCategoryKeywordCMSReport(parameters) {
  console.log('Function started: generateCategoryKeywordCMSReport', parameters);
  
  try {
    if (!validateInput(parameters || {})) {
      throw new Error('Invalid input provided');
    }
    
    const ui = SpreadsheetApp.getUi();
    const sheet = SpreadsheetApp.getActiveSheet();
    const sheetName = sheet.getName();
    
    console.log(`Using active sheet: ${sheetName}`);
    
    // Veri topla
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      ui.alert('Hata', 'Sayfada veri bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: false };
    }
    
    const headers = data[0];
    const categoryIdx = findColumnIndex(headers, ['Category', 'category', 'Kategori']);
    const cmsIdx = findColumnIndex(headers, ['CMS AdÄ±', 'CMS adÄ±', 'cms adÄ±', 'CMS']);
    const cmsGroupIdx = findColumnIndex(headers, ['CMS Grubu', 'CMS grubu', 'cms grubu']);
    // Hem eski hem yeni sÃ¼tun isimlerini ara (ikinci Ã§alÄ±ÅŸtÄ±rmada yeni isimler olacak)
    const eTicaretIziIdx = findColumnIndex(headers, ['E-Ticaret Ä°zi', 'E-Ticaret Ä°zi', 'e-ticaret izi', 'IdeaSoft OranÄ±', 'IdeaSoft OranÄ±', 'ideasoft oranÄ±']);
    const siteHiziIdx = findColumnIndex(headers, ['Site HÄ±zÄ±', 'Site HÄ±zÄ±', 'site hÄ±zÄ±', 'PahalÄ± Paket OranÄ±', 'PahalÄ± Paket OranÄ±', 'pahalÄ± paket oranÄ±']);
    const siteTrafigiIdx = findColumnIndex(headers, ['Site TrafiÄŸi', 'Site trafiÄŸi', 'site trafiÄŸi', 'Ucuz Paket OranÄ±', 'Ucuz Paket OranÄ±', 'ucuz paket oranÄ±']);
    
    // SÃ¼tun baÅŸlÄ±klarÄ±nÄ± yeni gÃ¶revlerine gÃ¶re deÄŸiÅŸtir (daha okunabilir ve anlaÅŸÄ±lÄ±r)
    if (eTicaretIziIdx !== -1) {
      sheet.getRange(1, eTicaretIziIdx + 1).setValue('IdeaSoft OranÄ±');
      console.log('âœ… E-Ticaret Ä°zi baÅŸlÄ±ÄŸÄ± gÃ¼ncellendi: "IdeaSoft OranÄ±"');
    }
    
    if (siteHiziIdx !== -1) {
      sheet.getRange(1, siteHiziIdx + 1).setValue('PahalÄ± Paket OranÄ±');
      console.log('âœ… Site HÄ±zÄ± baÅŸlÄ±ÄŸÄ± gÃ¼ncellendi: "PahalÄ± Paket OranÄ±"');
    }
    
    if (siteTrafigiIdx !== -1) {
      sheet.getRange(1, siteTrafigiIdx + 1).setValue('Ucuz Paket OranÄ±');
      console.log('âœ… Site TrafiÄŸi baÅŸlÄ±ÄŸÄ± gÃ¼ncellendi: "Ucuz Paket OranÄ±"');
    }
    
    if (categoryIdx === -1) {
      ui.alert('Hata', "'Category' kolonu bulunamadÄ±.", ui.ButtonSet.OK);
      return { success: false };
    }
    
    if (cmsIdx === -1) {
      ui.alert('Hata', "'CMS AdÄ±' kolonu bulunamadÄ±.", ui.ButtonSet.OK);
      return { success: false };
    }
    
    if (cmsGroupIdx === -1) {
      ui.alert('Hata', "'CMS Grubu' kolonu bulunamadÄ±. LÃ¼tfen Ã¶nce CMS Grubu kolonunu ekleyin.", ui.ButtonSet.OK);
      return { success: false };
    }
    
    // Eski "Silinmeye Aday" yazÄ±larÄ±nÄ± toplu olarak temizle (sadece iÃ§erik, format korunacak)
    console.log('Eski yazÄ±lar temizleniyor (formatlar korunuyor)...');
    if (data.length > 1) {
      const lastRow = data.length;
      const firstDataRow = 2;
      try {
        // CMS Grubu sÃ¼tununu temizle (sadece iÃ§erik, formatlar korunacak)
        const cmsGroupRange = sheet.getRange(firstDataRow, cmsGroupIdx + 1, lastRow - 1, 1);
        cmsGroupRange.clearContent();
        // NOT: clearFormat() kullanmÄ±yoruz - kenarlÄ±klar ve diÄŸer formatlar korunacak
      } catch (e) {
        console.error('Temizleme hatasÄ±:', e);
      }
    }
    
    // Platform listeleri
    const ideasoftPlatform = 'IdeaSoft';
    const pahaliRakipler = ['Ticimax', 'T-Soft', 'Ä°kas'];
    
    const ucuzPaketler = [
      'WooCommerce', 'Magento', 'PrestaShop', 'OpenCart', 'BigCommerce', 'Ecwid',
      'PlatinMarket', 'Projesoft', 'Faprika', 'Neticaret', 'E-Ticaret Soft', 
      'Smart E-Ticaret', 'ShopPHP', 'Softtr', 'Demresa', 'Quka Soft', 'Quka', 
      'iMaÄŸaza', 'AkÄ±nsoft', 'HipotenÃ¼s', 'Ticifly', 'Alkissoft', 'Kobimaster', 
      'Vatansoft', 'Inplato', 'eticaretim', 'JettyCart', 'DoÄŸru Ajans', 'Ã–zel E-ticaret'
    ];
    
    // Category bazÄ±nda analiz - Her category iÃ§in platform kontrolÃ¼ yap
    const categoryAnalysis = new Map(); // category -> { hasIdeaSoft, hasPahaliRakip, hasUcuzPaket, rowNumbers, ideasoftCount, pahaliPaketCount, totalCount }
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const category = (row[categoryIdx] || '').toString().trim();
      const cms = (row[cmsIdx] || '').toString().trim();
      const rowNum = i + 1;
      
      // Category zorunlu, CMS boÅŸ olabilir (o durumda category "silinmeye aday" olur)
      if (!category) continue;
      
      const catKey = category.toLowerCase();
      if (!categoryAnalysis.has(catKey)) {
        categoryAnalysis.set(catKey, {
          category,
          hasIdeaSoft: false,
          hasPahaliRakip: false,
          hasUcuzPaket: false,
          rowNumbers: [],
          ideasoftCount: 0,
          pahaliPaketCount: 0,
          ucuzPaketCount: 0,
          totalCount: 0
        });
      }
      
      const catData = categoryAnalysis.get(catKey);
      catData.rowNumbers.push(rowNum);
      catData.totalCount++;
      
      // CMS boÅŸsa, bu category'de hiÃ§ web sitesi yok demektir
      // Bu durumda kontrol yapma (zaten "silinmeye aday" olacak)
      if (!cms || cms.trim() === '') {
        continue; // CMS boÅŸ, kontrol yapma
      }
      
      // CMS kontrolÃ¼ (case-insensitive)
      const cmsLower = cms.toLowerCase();
      
      // 1. IdeaSoft kontrolÃ¼ (EN Ã–NCELÄ°K)
      if (!catData.hasIdeaSoft && cmsLower.includes(ideasoftPlatform.toLowerCase())) {
        catData.hasIdeaSoft = true;
      }
      // IdeaSoft mÃ¼ÅŸterisi sayÄ±sÄ±nÄ± hesapla
      if (cmsLower.includes(ideasoftPlatform.toLowerCase())) {
        catData.ideasoftCount++;
      }
      
      // 2. PahalÄ± rakipler kontrolÃ¼ (sadece IdeaSoft yoksa)
      if (!catData.hasIdeaSoft && !catData.hasPahaliRakip) {
        for (const rakip of pahaliRakipler) {
          if (cmsLower.includes(rakip.toLowerCase())) {
            catData.hasPahaliRakip = true;
            break;
          }
        }
      }
      // PahalÄ± Paket mÃ¼ÅŸterisi sayÄ±sÄ±nÄ± hesapla
      for (const rakip of pahaliRakipler) {
        if (cmsLower.includes(rakip.toLowerCase())) {
          catData.pahaliPaketCount++;
          break; // Bir tane bulduktan sonra dÃ¶ngÃ¼yÃ¼ durdur
        }
      }
      
      // 3. Ucuz paketler kontrolÃ¼ (sadece IdeaSoft ve pahalÄ± rakip yoksa)
      if (!catData.hasIdeaSoft && !catData.hasPahaliRakip && !catData.hasUcuzPaket) {
        for (const paket of ucuzPaketler) {
          if (cmsLower.includes(paket.toLowerCase())) {
            catData.hasUcuzPaket = true;
            break;
          }
        }
      }
      // Ucuz Paket mÃ¼ÅŸterisi sayÄ±sÄ±nÄ± hesapla
      for (const paket of ucuzPaketler) {
        if (cmsLower.includes(paket.toLowerCase())) {
          catData.ucuzPaketCount++;
          break; // Bir tane bulduktan sonra dÃ¶ngÃ¼yÃ¼ durdur
        }
      }
    }
    
    // Renklendirme iÃ§in yardÄ±mcÄ± fonksiyonlar
    // Oran deÄŸerinden yÃ¼zdeyi Ã§Ä±kar (Ã¶rn: "12/40 â†’ %30.00" -> 30.00)
    function extractPercentage(value) {
      if (!value || typeof value !== 'string') return 0;
      const match = value.match(/%([\d.]+)/);
      return match ? parseFloat(match[1]) : 0;
    }
    
    // Renklendirme sadece %50'den fazla olanlarda yapÄ±lacak (gÃ¶z yormamak iÃ§in)
    // IdeaSoft iÃ§in: YeÅŸil tonlarÄ± (sadece %50+)
    function getIdeaSoftColor(percentage) {
      if (percentage >= 50) return '#C8E6C9'; // Koyu yeÅŸil (yÃ¼ksek oran)
      return '#FFFFFF'; // Beyaz (50'nin altÄ±ndaysa renk yok)
    }
    
    // PahalÄ± Paket iÃ§in: Mavi tonlarÄ± (sadece %50+)
    function getPahaliPaketColor(percentage) {
      if (percentage >= 50) return '#BBDEFB'; // Koyu mavi
      return '#FFFFFF'; // Beyaz
    }
    
    // Ucuz Paket iÃ§in: Turuncu/sarÄ± tonlarÄ± (sadece %50+)
    function getUcuzPaketColor(percentage) {
      if (percentage >= 50) return '#FFE0B2'; // Koyu turuncu
      return '#FFFFFF'; // Beyaz
    }
    
    // Category renklendirme kaldÄ±rÄ±ldÄ± - artÄ±k sadece kategori kodu var, renk yok
    
    // Category bazÄ±nda sonuÃ§larÄ± CMS Grubu sÃ¼tununa yaz ve oranlarÄ± hesapla
    let ideasoftCount = 0;
    let pahaliRakipCount = 0;
    let ucuzPaketCount = 0;
    let silinebilirCount = 0;
    
    let categoryIndex = 0;
    for (const catData of categoryAnalysis.values()) {
      let result = '';
      
      // Ã–ncelik sÄ±rasÄ±na gÃ¶re kontrol
      if (catData.hasIdeaSoft) {
        result = 'IdeaSoft var';
        ideasoftCount += catData.rowNumbers.length;
      } else if (catData.hasPahaliRakip) {
        result = 'PahalÄ± rakipler var';
        pahaliRakipCount += catData.rowNumbers.length;
      } else if (catData.hasUcuzPaket) {
        result = 'Ucuz e-ticaret paketleri var';
        ucuzPaketCount += catData.rowNumbers.length;
      } else {
        result = 'E-ticaret firmasÄ± yok (silinmeye aday)';
        silinebilirCount += catData.rowNumbers.length;
      }
      
      // OranlarÄ± hesapla
      const ideasoftOrani = catData.totalCount > 0 
        ? (catData.ideasoftCount / catData.totalCount * 100).toFixed(2) 
        : '0.00';
      
      const pahaliPaketOrani = catData.totalCount > 0 
        ? (catData.pahaliPaketCount / catData.totalCount * 100).toFixed(2) 
        : '0.00';
      
      const ucuzPaketOrani = catData.totalCount > 0 
        ? (catData.ucuzPaketCount / catData.totalCount * 100).toFixed(2) 
        : '0.00';
      
      // Kategori kodu (K1, K2, K3...) - oran sÃ¼tunlarÄ±na eklenecek
      const kategoriKodu = `K${categoryIndex + 1}`;
      
      // SayÄ±, oran ve kategori kodu - sÃ¼tun baÅŸlÄ±ÄŸÄ±nda kriter adÄ± yazÄ±lacak
      // Format: "K1 | SayÄ±/Toplam â†’ %Oran" - okunabilir ve temiz
      const ideasoftDeger = `${kategoriKodu} | ${catData.ideasoftCount}/${catData.totalCount} â†’ %${ideasoftOrani}`;
      const pahaliPaketDeger = `${kategoriKodu} | ${catData.pahaliPaketCount}/${catData.totalCount} â†’ %${pahaliPaketOrani}`;
      const ucuzPaketDeger = `${kategoriKodu} | ${catData.ucuzPaketCount}/${catData.totalCount} â†’ %${ucuzPaketOrani}`;
      
      console.log(`ðŸ“Š Category: ${catData.category}`);
      console.log(`   Toplam: ${catData.totalCount}, IdeaSoft: ${catData.ideasoftCount}, PahalÄ± Paket: ${catData.pahaliPaketCount}, Ucuz Paket: ${catData.ucuzPaketCount}`);
      console.log(`   IdeaSoft: ${ideasoftDeger}, PahalÄ± Paket: ${pahaliPaketDeger}, Ucuz Paket: ${ucuzPaketDeger}`);
      
      // Oran deÄŸerlerinden yÃ¼zdeleri Ã§Ä±kar
      const ideasoftOranDeger = extractPercentage(ideasoftDeger);
      const pahaliPaketOranDeger = extractPercentage(pahaliPaketDeger);
      const ucuzPaketOranDeger = extractPercentage(ucuzPaketDeger);
      
      // Bu category'deki TÃœM satÄ±rlara yaz ve renklendir
      for (const rowNum of catData.rowNumbers) {
        try {
          // CMS Grubu sÃ¼tununa yaz (sadece deÄŸer, format deÄŸiÅŸmeyecek)
          sheet.getRange(rowNum, cmsGroupIdx + 1).setValue(result);
          
          // Category sÃ¼tununa HÄ°Ã‡BÄ°R ÅžEY YAPMIYORUZ - format ve deÄŸer aynen kalacak
          
          // E-Ticaret Ä°zi sÃ¼tununa IdeaSoft sayÄ±sÄ± ve oranÄ± yaz + sadece %50+ ise renklendir
          if (eTicaretIziIdx !== -1) {
            const ideasoftRange = sheet.getRange(rowNum, eTicaretIziIdx + 1);
            ideasoftRange.setValue(ideasoftDeger); // Sadece deÄŸer deÄŸiÅŸiyor, format (kenarlÄ±klar vs.) korunuyor
            // Sadece %50'den fazla olanlarda background color set et
            // %50'nin altÄ±ndakilere dokunmuyoruz - mevcut formatlar (kenarlÄ±klar vs.) korunacak
            if (ideasoftOranDeger >= 50) {
              ideasoftRange.setBackground(getIdeaSoftColor(ideasoftOranDeger));
            }
          }
          
          // Site HÄ±zÄ± sÃ¼tununa PahalÄ± Paket sayÄ±sÄ± ve oranÄ± yaz + sadece %50+ ise renklendir
          if (siteHiziIdx !== -1) {
            const pahaliPaketRange = sheet.getRange(rowNum, siteHiziIdx + 1);
            pahaliPaketRange.setValue(pahaliPaketDeger); // Sadece deÄŸer deÄŸiÅŸiyor, format korunuyor
            // Sadece %50'den fazla olanlarda background color set et
            if (pahaliPaketOranDeger >= 50) {
              pahaliPaketRange.setBackground(getPahaliPaketColor(pahaliPaketOranDeger));
            }
          }
          
          // Site TrafiÄŸi sÃ¼tununa Ucuz Paket sayÄ±sÄ± ve oranÄ± yaz + sadece %50+ ise renklendir
          if (siteTrafigiIdx !== -1) {
            const ucuzPaketRange = sheet.getRange(rowNum, siteTrafigiIdx + 1);
            ucuzPaketRange.setValue(ucuzPaketDeger); // Sadece deÄŸer deÄŸiÅŸiyor, format korunuyor
            // Sadece %50'den fazla olanlarda background color set et
            if (ucuzPaketOranDeger >= 50) {
              ucuzPaketRange.setBackground(getUcuzPaketColor(ucuzPaketOranDeger));
            }
          }
        } catch (e) {
          console.error(`Row ${rowNum} yazÄ±lÄ±rken hata:`, e);
        }
      }
      
      categoryIndex++;
    }
    
    const totalRows = data.length - 1;
    const totalProcessed = ideasoftCount + pahaliRakipCount + ucuzPaketCount + silinebilirCount;
    
    const oranBilgisi = (eTicaretIziIdx !== -1 && siteHiziIdx !== -1 && siteTrafigiIdx !== -1) 
      ? `\n\nðŸ“ˆ Oranlar (Okunabilir Format):\n` +
        `  ðŸ’¡ IdeaSoft OranÄ±: "K1 | SayÄ±/Toplam â†’ %Oran" (Sadece %50+ olanlar renkli - yeÅŸil)\n` +
        `  ðŸ’Ž PahalÄ± Paket OranÄ±: "K1 | SayÄ±/Toplam â†’ %Oran" (Sadece %50+ olanlar renkli - mavi)\n` +
        `  ðŸ’¼ Ucuz Paket OranÄ±: "K1 | SayÄ±/Toplam â†’ %Oran" (Sadece %50+ olanlar renkli - turuncu)\n` +
        `  Ã–rnek: "K1 | 12/40 â†’ %30.00" â†’ Kategori 1, 40 mÃ¼ÅŸteriden 12'si IdeaSoft, %30 oran\n\n` +
        `ðŸŽ¨ Renklendirme:\n` +
        `  âœ… Sadece %50'den fazla olan oranlar renklendirildi (gÃ¶z yormamak iÃ§in)\n` +
        `  âœ… Category sÃ¼tununda renk yok - sadece kategori kodlarÄ± var\n` +
        `  âœ… Oran sÃ¼tunlarÄ±nda da sadece yÃ¼ksek deÄŸerler vurgulandÄ±\n\n` +
        `ðŸ·ï¸ Kategori Kodlama:\n` +
        `  âœ… Her kategoriye kod eklendi (K1, K2, K3...)\n` +
        `  âœ… Kodlar sadece oran sÃ¼tunlarÄ±nda gÃ¶rÃ¼nÃ¼yor (Category sÃ¼tununa dokunulmadÄ±)\n` +
        `  âœ… Format: "K1 | 12/40 â†’ %30.00" - aynÄ± kategoriye ait tÃ¼m satÄ±rlarda aynÄ± kod\n` +
        `  âœ… BÃ¶ylece 40 satÄ±rda aynÄ± istatistiÄŸi 40 kere okumaya gerek yok!\n` +
        `  âœ… SÃ¼tun baÅŸlÄ±klarÄ± yeni gÃ¶revlerine gÃ¶re gÃ¼ncellendi`
      : `\n\nâš ï¸ Oranlar yazÄ±lamadÄ±: E-Ticaret Ä°zi, Site HÄ±zÄ± veya Site TrafiÄŸi sÃ¼tunlarÄ± bulunamadÄ±.`;
    
    ui.alert('SÄ±caklÄ±k Analizi tamamlandÄ±', 
      `ðŸŽ¨ E-ticaret SÄ±caklÄ±k Analizi tamamlandÄ±.\n\n` +
      `â€¢ Toplam ${totalRows} satÄ±r kontrol edildi\n` +
      `â€¢ ${totalProcessed} kayÄ±t iÅŸlendi\n\n` +
      `ðŸ“Š SonuÃ§lar (Category bazÄ±nda):\n` +
      `  ðŸ”¥ IdeaSoft var: ${ideasoftCount} satÄ±r\n` +
      `  ðŸ’Ž PahalÄ± rakipler var: ${pahaliRakipCount} satÄ±r\n` +
      `  ðŸ’¼ Ucuz e-ticaret paketleri var: ${ucuzPaketCount} satÄ±r\n` +
      `  ðŸ§Š E-ticaret firmasÄ± yok (silinmeye aday): ${silinebilirCount} satÄ±r\n\n` +
      `âœ… TÃ¼m sonuÃ§lar CMS Grubu sÃ¼tununa yazÄ±ldÄ±.${oranBilgisi}`, 
      ui.ButtonSet.OK);
    
    console.log('Processing complete:', { 
      totalRows,
      totalProcessed,
      ideasoftCount,
      pahaliRakipCount,
      ucuzPaketCount,
      silinebilirCount
    });
    
    return { 
      success: true, 
      totalRows,
      totalProcessed,
      ideasoftCount,
      pahaliRakipCount,
      ucuzPaketCount,
      silinebilirCount,
      oranlarHesaplandi: (eTicaretIziIdx !== -1 && siteHiziIdx !== -1 && siteTrafigiIdx !== -1)
    };
    
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/**
 * ðŸ—‘ï¸ Silinmeye Aday SatÄ±rlarÄ± Sil - CMS Grubu sÃ¼tununda "E-ticaret firmasÄ± yok (silinmeye aday)" yazan satÄ±rlarÄ± siler
 */
function deleteSilinmeyeAdayRows(parameters) {
  console.log('Function started: deleteSilinmeyeAdayRows', parameters);
  
  try {
    if (!validateInput(parameters || {})) {
      throw new Error('Invalid input provided');
    }
    
    const sheet = SpreadsheetApp.getActiveSheet();
    const ui = SpreadsheetApp.getUi();
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      ui.alert('Bilgi', 'Veri bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: true, deleted: 0 };
    }
    
    const headers = data[0];
    const cmsGroupIdx = findColumnIndex(headers, ['CMS Grubu', 'CMS grubu', 'cms grubu']);
    
    if (cmsGroupIdx === -1) {
      ui.alert('Hata', "'CMS Grubu' kolonu bulunamadÄ±.", ui.ButtonSet.OK);
      return { success: false };
    }
    
    // "E-ticaret firmasÄ± yok (silinmeye aday)" yazan satÄ±rlarÄ± bul
    const rowsToDelete = [];
    
    for (let i = 1; i < data.length; i++) {
      const rowNum = i + 1;
      const cmsGroup = (data[i][cmsGroupIdx] || '').toString().trim();
      
      if (cmsGroup && cmsGroup.includes('E-ticaret firmasÄ± yok (silinmeye aday)')) {
        rowsToDelete.push(rowNum);
      }
    }
    
    if (rowsToDelete.length === 0) {
      ui.alert('Bilgi', 'Silinmeye aday satÄ±r bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: true, deleted: 0 };
    }
    
    // Ã–zet gÃ¶ster
    let summaryMsg = `Toplam ${rowsToDelete.length} "E-ticaret firmasÄ± yok (silinmeye aday)" satÄ±r bulundu.\n\n`;
    summaryMsg += `âš ï¸ Bu satÄ±rlarÄ± silmek istiyor musunuz?`;
    
    const confirm = ui.alert('ðŸ—‘ï¸ Silinmeye Aday SatÄ±rlarÄ± Sil', summaryMsg, ui.ButtonSet.YES_NO);
    
    if (confirm !== ui.Button.YES) {
      ui.alert('Ä°ptal edildi', 'Silme iÅŸlemi iptal edildi.', ui.ButtonSet.OK);
      return { success: false, deleted: 0, cancelled: true };
    }
    
    // SatÄ±rlarÄ± sil (bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe)
    rowsToDelete.sort((a, b) => b - a);
    let deleted = 0;
    
    for (const rowNum of rowsToDelete) {
      try {
        sheet.deleteRow(rowNum);
        deleted++;
      } catch (err) {
        console.error(`SatÄ±r ${rowNum} silinirken hata:`, err);
      }
    }
    
    ui.alert('Ä°ÅŸlem tamamlandÄ±', `${deleted} "silinmeye aday" satÄ±r baÅŸarÄ±yla silindi.`, ui.ButtonSet.OK);
    console.log('Processing complete:', { deleted, total: rowsToDelete.length });
    return { success: true, deleted, total: rowsToDelete.length };
    
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/**
 * ðŸ—‘ï¸ Silinmeye Aday SatÄ±rlarÄ± Sil - CMS Grubu sÃ¼tununda "E-ticaret firmasÄ± yok (silinmeye aday)" yazan satÄ±rlarÄ± siler
 */
function deleteSilinmeyeAdayRows(parameters) {
  console.log('Function started: deleteSilinmeyeAdayRows', parameters);
  
  try {
    if (!validateInput(parameters || {})) {
      throw new Error('Invalid input provided');
    }
    
    const sheet = SpreadsheetApp.getActiveSheet();
    const ui = SpreadsheetApp.getUi();
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      ui.alert('Bilgi', 'Veri bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: true, deleted: 0 };
    }
    
    const headers = data[0];
    const cmsGroupIdx = findColumnIndex(headers, ['CMS Grubu', 'CMS grubu', 'cms grubu']);
    
    if (cmsGroupIdx === -1) {
      ui.alert('Hata', "'CMS Grubu' kolonu bulunamadÄ±.", ui.ButtonSet.OK);
      return { success: false };
    }
    
    // "E-ticaret firmasÄ± yok (silinmeye aday)" yazan satÄ±rlarÄ± bul
    const rowsToDelete = [];
    
    for (let i = 1; i < data.length; i++) {
      const rowNum = i + 1;
      const cmsGroup = (data[i][cmsGroupIdx] || '').toString().trim();
      
      if (cmsGroup && cmsGroup.includes('E-ticaret firmasÄ± yok (silinmeye aday)')) {
        rowsToDelete.push(rowNum);
      }
    }
    
    if (rowsToDelete.length === 0) {
      ui.alert('Bilgi', 'Silinmeye aday satÄ±r bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: true, deleted: 0 };
    }
    
    // Ã–zet gÃ¶ster
    let summaryMsg = `Toplam ${rowsToDelete.length} "E-ticaret firmasÄ± yok (silinmeye aday)" satÄ±r bulundu.\n\n`;
    summaryMsg += `âš ï¸ Bu satÄ±rlarÄ± silmek istiyor musunuz?`;
    
    const confirm = ui.alert('ðŸ—‘ï¸ Silinmeye Aday SatÄ±rlarÄ± Sil', summaryMsg, ui.ButtonSet.YES_NO);
    
    if (confirm !== ui.Button.YES) {
      ui.alert('Ä°ptal edildi', 'Silme iÅŸlemi iptal edildi.', ui.ButtonSet.OK);
      return { success: false, deleted: 0, cancelled: true };
    }
    
    // SatÄ±rlarÄ± sil (bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe)
    rowsToDelete.sort((a, b) => b - a);
    let deleted = 0;
    
    for (const rowNum of rowsToDelete) {
      try {
        sheet.deleteRow(rowNum);
        deleted++;
      } catch (err) {
        console.error(`SatÄ±r ${rowNum} silinirken hata:`, err);
      }
    }
    
    ui.alert('Ä°ÅŸlem tamamlandÄ±', `${deleted} "silinmeye aday" satÄ±r baÅŸarÄ±yla silindi.`, ui.ButtonSet.OK);
    console.log('Processing complete:', { deleted, total: rowsToDelete.length });
    return { success: true, deleted, total: rowsToDelete.length };
    
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/**
 * ðŸ”´ KÄ±rmÄ±zÄ± SatÄ±rlarÄ± Sil (Her Ä°kisinde de Yok) - Hem Category hem Keyword'de e-ticaret olmayan kÄ±rmÄ±zÄ± satÄ±rlarÄ± siler
 */
function deleteRedRowsBoth(parameters) {
  console.log('Function started: deleteRedRowsBoth', parameters);
  
  try {
    if (!validateInput(parameters || {})) {
      throw new Error('Invalid input provided');
    }
    
    const sheet = SpreadsheetApp.getActiveSheet();
    const ui = SpreadsheetApp.getUi();
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      ui.alert('Bilgi', 'Veri bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: true, deleted: 0 };
    }
    
    const headers = data[0];
    const categoryIdx = findColumnIndex(headers, ['Category', 'category', 'Kategori']);
    const keywordIdx = findColumnIndex(headers, ['Keyword', 'keyword', 'Anahtar Kelime', 'Anahtar Kelimeler']);
    const cmsIdx = findColumnIndex(headers, ['CMS AdÄ±', 'CMS adÄ±', 'cms adÄ±', 'CMS']);
    
    if (categoryIdx === -1 || keywordIdx === -1 || cmsIdx === -1) {
      ui.alert('Hata', 'Category, Keyword veya CMS AdÄ± kolonu bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: false };
    }
    
    // KÄ±rmÄ±zÄ± renkli satÄ±rlarÄ± bul (#FFCCCC - Hem Category hem Keyword'de e-ticaret yok)
    const rowsToDelete = [];
    
    for (let i = 1; i < data.length; i++) {
      const rowNum = i + 1;
      try {
        const bgColor = sheet.getRange(rowNum, 1).getBackground();
        // KÄ±rmÄ±zÄ± renk kontrolÃ¼ (#FFCCCC)
        if (bgColor === '#ffcccc' || bgColor === '#FFCCCC' || bgColor.toLowerCase() === '#ffcccc') {
          const category = (data[i][categoryIdx] || '').toString().trim();
          const keyword = (data[i][keywordIdx] || '').toString().trim();
          const cms = (data[i][cmsIdx] || '').toString().trim();
          
          rowsToDelete.push({ row: rowNum, category, keyword, cms });
        }
      } catch (e) {
        console.error(`Row ${rowNum} check failed:`, e);
      }
    }
    
    if (rowsToDelete.length === 0) {
      ui.alert('Bilgi', 'Silinecek kÄ±rmÄ±zÄ± satÄ±r bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: true, deleted: 0 };
    }
    
    // Ã–zet gÃ¶ster
    let summaryMsg = `Toplam ${rowsToDelete.length} kÄ±rmÄ±zÄ± satÄ±r bulundu (Hem Category hem Keyword'de e-ticaret yok).\n\n`;
    summaryMsg += `Ã–rnekler (ilk 5):\n`;
    for (let i = 0; i < Math.min(5, rowsToDelete.length); i++) {
      const r = rowsToDelete[i];
      summaryMsg += `\nSatÄ±r ${r.row}: "${r.keyword}" - ${r.category}`;
    }
    if (rowsToDelete.length > 5) {
      summaryMsg += `\n\n... ve ${rowsToDelete.length - 5} satÄ±r daha`;
    }
    summaryMsg += `\n\nâš ï¸ Bu satÄ±rlarÄ± silmek istiyor musunuz?`;
    
    const confirm = ui.alert('ðŸ”´ KÄ±rmÄ±zÄ± SatÄ±rlarÄ± Sil (Her Ä°kisinde de Yok)', summaryMsg, ui.ButtonSet.YES_NO);
    
    if (confirm !== ui.Button.YES) {
      ui.alert('Ä°ptal edildi', 'Silme iÅŸlemi iptal edildi.', ui.ButtonSet.OK);
      return { success: false, deleted: 0, cancelled: true };
    }
    
    // SatÄ±rlarÄ± sil (bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe)
    rowsToDelete.sort((a, b) => b.row - a.row);
    let deleted = 0;
    
    for (const item of rowsToDelete) {
      try {
        sheet.deleteRow(item.row);
        deleted++;
      } catch (err) {
        console.error(`SatÄ±r ${item.row} silinirken hata:`, err);
      }
    }
    
    ui.alert('Ä°ÅŸlem tamamlandÄ±', `${deleted} kÄ±rmÄ±zÄ± satÄ±r baÅŸarÄ±yla silindi.`, ui.ButtonSet.OK);
    console.log('Processing complete:', { deleted, total: rowsToDelete.length });
    return { success: true, deleted, total: rowsToDelete.length };
    
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/**
 * ðŸŸ¡ SarÄ± SatÄ±rlarÄ± Sil (Category) - Category bazÄ±nda e-ticaret olmayan sarÄ± satÄ±rlarÄ± siler
 */
function deleteYellowRowsCategory(parameters) {
  console.log('Function started: deleteYellowRowsCategory', parameters);
  
  try {
    if (!validateInput(parameters || {})) {
      throw new Error('Invalid input provided');
    }
    
    const sheet = SpreadsheetApp.getActiveSheet();
    const ui = SpreadsheetApp.getUi();
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      ui.alert('Bilgi', 'Veri bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: true, deleted: 0 };
    }
    
    const headers = data[0];
    const categoryIdx = findColumnIndex(headers, ['Category', 'category', 'Kategori']);
    const keywordIdx = findColumnIndex(headers, ['Keyword', 'keyword', 'Anahtar Kelime', 'Anahtar Kelimeler']);
    const cmsIdx = findColumnIndex(headers, ['CMS AdÄ±', 'CMS adÄ±', 'cms adÄ±', 'CMS']);
    
    if (categoryIdx === -1 || keywordIdx === -1 || cmsIdx === -1) {
      ui.alert('Hata', 'Category, Keyword veya CMS AdÄ± kolonu bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: false };
    }
    
    // TÃ¼rkiye e-ticaret platformlarÄ± (cms_detector.gs'deki TR HazÄ±r + diÄŸer e-ticaret platformlarÄ±)
    const eticaretPlatforms = [
      // TR HazÄ±r E-ticaret (cms_detector.gs'den)
      'IdeaSoft', 'Ticimax', 'T-Soft', 'Ä°kas', 'PlatinMarket', 'Projesoft', 
      'Faprika', 'Neticaret', 'E-Ticaret Soft', 'Smart E-Ticaret', 'ShopPHP',
      'Softtr', 'Demresa', 'Quka Soft', 'Quka', 'iMaÄŸaza',
      'AkÄ±nsoft', 'HipotenÃ¼s', 'Ticifly', 'Alkissoft', 'Kobimaster', 
      'Vatansoft', 'Inplato', 'eticaretim', 'JettyCart', 'DoÄŸru Ajans',
      // SaaS & AÃ§Ä±k Kaynak E-ticaret
      'Shopify', 'WooCommerce', 'Magento', 'PrestaShop', 'OpenCart', 
      'BigCommerce', 'Ecwid',
      // Ã–zel E-ticaret (YÃ¼ksek Kalite e-ticaret siteleri)
      'Ã–zel E-ticaret'
    ];
    
    // SarÄ± renkli satÄ±rlarÄ± bul (RGB: 255, 250, 205 = #FFFACD)
    const rowsToDelete = [];
    
    for (let i = 1; i < data.length; i++) {
      const rowNum = i + 1;
      try {
        const bgColor = sheet.getRange(rowNum, 1).getBackground();
        // SarÄ± renk kontrolÃ¼ (#FFFACD - Category bazÄ±nda e-ticaret yok)
        if (bgColor === '#fffacd' || bgColor === '#FFFACD' || bgColor.toLowerCase() === '#fffacd') {
          const category = (data[i][categoryIdx] || '').toString().trim();
          const keyword = (data[i][keywordIdx] || '').toString().trim();
          const cms = (data[i][cmsIdx] || '').toString().trim();
          
          rowsToDelete.push({ row: rowNum, category, keyword, cms });
        }
      } catch (e) {
        console.error(`Row ${rowNum} check failed:`, e);
      }
    }
    
    if (rowsToDelete.length === 0) {
      ui.alert('Bilgi', 'Silinecek sarÄ± satÄ±r bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: true, deleted: 0 };
    }
    
    // Ã–zet gÃ¶ster
    let summaryMsg = `Toplam ${rowsToDelete.length} sarÄ± satÄ±r bulundu (Category bazÄ±nda e-ticaret yok).\n\n`;
    summaryMsg += `Ã–rnekler (ilk 5):\n`;
    for (let i = 0; i < Math.min(5, rowsToDelete.length); i++) {
      const r = rowsToDelete[i];
      summaryMsg += `\nSatÄ±r ${r.row}: "${r.keyword}" - ${r.category}`;
    }
    if (rowsToDelete.length > 5) {
      summaryMsg += `\n\n... ve ${rowsToDelete.length - 5} satÄ±r daha`;
    }
    summaryMsg += `\n\nâš ï¸ Bu satÄ±rlarÄ± silmek istiyor musunuz?`;
    
    const confirm = ui.alert('ðŸŸ¡ SarÄ± SatÄ±rlarÄ± Sil (Category)', summaryMsg, ui.ButtonSet.YES_NO);
    
    if (confirm !== ui.Button.YES) {
      ui.alert('Ä°ptal edildi', 'Silme iÅŸlemi iptal edildi.', ui.ButtonSet.OK);
      return { success: false, deleted: 0, cancelled: true };
    }
    
    // SatÄ±rlarÄ± sil (bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe)
    rowsToDelete.sort((a, b) => b.row - a.row);
    let deleted = 0;
    
    for (const item of rowsToDelete) {
      try {
        sheet.deleteRow(item.row);
        deleted++;
      } catch (err) {
        console.error(`SatÄ±r ${item.row} silinirken hata:`, err);
      }
    }
    
    ui.alert('Ä°ÅŸlem tamamlandÄ±', `${deleted} sarÄ± satÄ±r baÅŸarÄ±yla silindi.`, ui.ButtonSet.OK);
    console.log('Processing complete:', { deleted, total: rowsToDelete.length });
    return { success: true, deleted, total: rowsToDelete.length };
    
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}

/**
 * ðŸŸ  Turuncu SatÄ±rlarÄ± Sil (Keyword) - Keyword bazÄ±nda e-ticaret olmayan turuncu satÄ±rlarÄ± siler
 */
function deleteOrangeRowsKeyword(parameters) {
  console.log('Function started: deleteOrangeRowsKeyword', parameters);
  
  try {
    if (!validateInput(parameters || {})) {
      throw new Error('Invalid input provided');
    }
    
    const sheet = SpreadsheetApp.getActiveSheet();
    const ui = SpreadsheetApp.getUi();
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      ui.alert('Bilgi', 'Veri bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: true, deleted: 0 };
    }
    
    const headers = data[0];
    const categoryIdx = findColumnIndex(headers, ['Category', 'category', 'Kategori']);
    const keywordIdx = findColumnIndex(headers, ['Keyword', 'keyword', 'Anahtar Kelime', 'Anahtar Kelimeler']);
    const cmsIdx = findColumnIndex(headers, ['CMS AdÄ±', 'CMS adÄ±', 'cms adÄ±', 'CMS']);
    
    if (categoryIdx === -1 || keywordIdx === -1 || cmsIdx === -1) {
      ui.alert('Hata', 'Category, Keyword veya CMS AdÄ± kolonu bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: false };
    }
    
    // Turuncu renkli satÄ±rlarÄ± bul (#FFE5CC - Keyword bazÄ±nda e-ticaret yok)
    const rowsToDelete = [];
    
    for (let i = 1; i < data.length; i++) {
      const rowNum = i + 1;
      try {
        const bgColor = sheet.getRange(rowNum, 1).getBackground();
        // Turuncu renk kontrolÃ¼ (#FFE5CC)
        if (bgColor === '#ffe5cc' || bgColor === '#FFE5CC' || bgColor.toLowerCase() === '#ffe5cc') {
          const category = (data[i][categoryIdx] || '').toString().trim();
          const keyword = (data[i][keywordIdx] || '').toString().trim();
          const cms = (data[i][cmsIdx] || '').toString().trim();
          
          rowsToDelete.push({ row: rowNum, category, keyword, cms });
        }
      } catch (e) {
        console.error(`Row ${rowNum} check failed:`, e);
      }
    }
    
    if (rowsToDelete.length === 0) {
      ui.alert('Bilgi', 'Silinecek turuncu satÄ±r bulunamadÄ±.', ui.ButtonSet.OK);
      return { success: true, deleted: 0 };
    }
    
    // Ã–zet gÃ¶ster
    let summaryMsg = `Toplam ${rowsToDelete.length} turuncu satÄ±r bulundu (Keyword bazÄ±nda e-ticaret yok).\n\n`;
    summaryMsg += `Ã–rnekler (ilk 5):\n`;
    for (let i = 0; i < Math.min(5, rowsToDelete.length); i++) {
      const r = rowsToDelete[i];
      summaryMsg += `\nSatÄ±r ${r.row}: "${r.keyword}" - ${r.category}`;
    }
    if (rowsToDelete.length > 5) {
      summaryMsg += `\n\n... ve ${rowsToDelete.length - 5} satÄ±r daha`;
    }
    summaryMsg += `\n\nâš ï¸ Bu satÄ±rlarÄ± silmek istiyor musunuz?`;
    
    const confirm = ui.alert('ðŸŸ  Turuncu SatÄ±rlarÄ± Sil (Keyword)', summaryMsg, ui.ButtonSet.YES_NO);
    
    if (confirm !== ui.Button.YES) {
      ui.alert('Ä°ptal edildi', 'Silme iÅŸlemi iptal edildi.', ui.ButtonSet.OK);
      return { success: false, deleted: 0, cancelled: true };
    }
    
    // SatÄ±rlarÄ± sil (bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe)
    rowsToDelete.sort((a, b) => b.row - a.row);
    let deleted = 0;
    
    for (const item of rowsToDelete) {
      try {
        sheet.deleteRow(item.row);
        deleted++;
      } catch (err) {
        console.error(`SatÄ±r ${item.row} silinirken hata:`, err);
      }
    }
    
    ui.alert('Ä°ÅŸlem tamamlandÄ±', `${deleted} turuncu satÄ±r baÅŸarÄ±yla silindi.`, ui.ButtonSet.OK);
    console.log('Processing complete:', { deleted, total: rowsToDelete.length });
    return { success: true, deleted, total: rowsToDelete.length };
    
  } catch (error) {
    console.error('Function failed:', error);
    SpreadsheetApp.getUi().alert('Hata: ' + error.message);
    throw error;
  }
}
