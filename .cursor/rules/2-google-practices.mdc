---
alwaysApply: true
description: "Google Apps Script best practices ve batch operations"
---


# Google Apps Script Best Practices
Her zaman uygulanmasÄ± gereken temel kurallar.
---
## BATCH OPERATIONS (ZORUNLU!)
### Temel Kural
**ASLA loop iÃ§inde API call yapma!**
### âŒ ANTÄ°-PATTERN (YavaÅŸ)
```javascript
// 100 satÄ±r iÃ§in 100 API call = 10+ saniye!
for (let i = 2; i <= 101; i++) {
  const value = sheet.getRange(i, 1).getValue();
  processValue(value);
}
// Her satÄ±r iÃ§in ayrÄ± yazma
for (let i = 0; i < data.length; i++) {
  sheet.getRange(i + 2, 1).setValue(data[i]);
}
// Her hÃ¼creye ayrÄ± renk
for (let i = 2; i <= 151; i++) {
  sheet.getRange(i, 1, 1, 10).setBackground('#E8F5E8');
}
âœ… BEST PRACTICE (HÄ±zlÄ±)

// Tek seferde oku (1 API call = 0.5s!)
const values = sheet.getRange(2, 1, 100, 1).getValues();
values.forEach(row => processValue(row[0]));
// Batch yazma
const writeData = data.map(item => [item]);
sheet.getRange(2, 1, data.length, 1).setValues(writeData);
// Batch renklendirme
const colors = Array(150).fill(Array(10).fill('#E8F5E8'));
sheet.getRange(2, 1, 150, 10).setBackgrounds(colors);
KazanÃ§: 100x daha hÄ±zlÄ±!

CACHE KULLANIMI (Zorunlu!)
Her Veriyi Cache'le

const cache = CacheService.getScriptCache();
// Reusable cache function
function getCachedData(key, fetchFunction, ttl = 3600) {
  const cached = cache.get(key);
  if (cached) {
    console.log(`âœ… Cache hit: ${key}`);
    return JSON.parse(cached);
  }
  
  console.log(`âŒ Cache miss: ${key}`);
  const fresh = fetchFunction();
  cache.put(key, JSON.stringify(fresh), ttl);
  return fresh;
}
// KullanÄ±m
const employeeSheet = getCachedData(
  `sheet_SB004`,
  () => SpreadsheetApp.openById(fileId).getSheetByName('RandevularÄ±m'),
  3600
);
Ä°lk Ã§aÄŸrÄ±: 5s, sonrakiler: 0.01s!

PERFORMANCE HEDEFLERÄ°
Hedefler
Tek iÅŸlem: <1s
Batch iÅŸlem: <3s
Rapor: <5s
Senkronizasyon: <10s
Her Ä°ÅŸlemde Ã–lÃ§

function measurePerformance(funcName, func) {
  const start = Date.now();
  const result = func();
  const duration = (Date.now() - start) / 1000;
  
  const status = duration < 2 ? 'âœ…' : duration < 5 ? 'âš ï¸' : 'âŒ';
  console.log(`â±ï¸ ${status} ${funcName}: ${duration.toFixed(2)}s`);
  
  if (duration > 3) {
    console.warn(`âš ï¸ YAVAÅ! ${funcName} optimize edilmeli!`);
  }
  
  return { result, duration };
}
API QUOTA YÃ–NETÄ°MÄ°
Google Sheets Quotas

const QUOTAS = {
  executionTime: 360,
  dailyAPIcalls: 20000,
  concurrentExecutions: 30,
  cellLimit: 5000000
};
Quota Tasarrufu
âœ… YAP:

Batch operations kullan
Cache kullan
Incremental sync
Parallel processing
âŒ YAPMA:

Loop iÃ§inde API call
Her iÅŸlemde flush
Cache'siz Ã§alÄ±ÅŸma
ERROR HANDLING (Zorunlu!)
Her Fonksiyonda Try-Catch

function safeOperation(operationName, operation) {
  try {
    console.log(`ğŸ”„ ${operationName} baÅŸladÄ±`);
    const result = operation();
    console.log(`âœ… ${operationName} baÅŸarÄ±lÄ±`);
    return { success: true, result };
    
  } catch (error) {
    console.error(`âŒ ${operationName}: ${error.message}`);
    
    console.error(JSON.stringify({
      timestamp: new Date().toISOString(),
      operation: operationName,
      error: error.message,
      stack: error.stack
    }));
    
    return { success: false, error: error.message };
  }
}
Validation Error Handling

try {
  sheet.getRange(row, col, 1, values.length).setValues([values]);
} catch (error) {
  if (error.message.includes('validation')) {
    const range = sheet.getRange(row, col, 1, values.length);
    range.clearDataValidations();
    range.setValues([values]);
    console.log('âœ… Validation temizlendi, yazÄ±ldÄ±');
  } else {
    throw error;
  }
}
ARRAY-HEADER SYNC (Kritik!)
Her Yazmadan Ã–nce Kontrol

function validateArrayHeaderSync(array, headers) {
  if (array.length !== headers.length) {
    console.error('âŒ KRÄ°TÄ°K: Array-Header uyumsuz!');
    console.error(`Headers (${headers.length}):`, headers);
    console.error(`Array (${array.length}):`, array);
    throw new Error(`Array (${array.length}) â‰  Headers (${headers.length})`);
  }
  
  console.log('âœ… Array-Header sync OK');
  return true;
}
const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
const dataRow = [value1, value2, value3];
validateArrayHeaderSync(dataRow, headers);
sheet.getRange(newRow, 1, 1, dataRow.length).setValues([dataRow]);

STRUCTURED LOGGING
Her Zaman JSON Format

function log(level, message, metadata = {}) {
  console.log(JSON.stringify({
    timestamp: new Date().toISOString(),
    level: level,
    service: 'CRM-Backend',
    message: message,
    ...metadata
  }));
}
log('INFO', 'Randevu eklendi', { customerId: '123', duration: 1.2 });
log('ERROR', 'Validation hatasÄ±', { column: 'L', row: 85 });
log('WARN', 'YavaÅŸ iÅŸlem', { duration: 8.5, threshold: 3 });
INCREMENTAL SYNC
Sadece Yeni Veriyi Ä°ÅŸle

function incrementalSync(sheetName) {
  const cache = CacheService.getScriptCache();
  const cacheKey = `lastProcessedRow_${sheetName}`;
  
  const lastRow = parseInt(cache.get(cacheKey) || '1');
  const currentLastRow = sheet.getLastRow();
  
  const newRowCount = currentLastRow - lastRow;
  if (newRowCount > 0) {
    const newData = sheet.getRange(lastRow + 1, 1, newRowCount, 10).getValues();
    
    console.log(`ğŸ“Š ${newRowCount} yeni satÄ±r iÅŸlenecek`);
    processData(newData);
    
    cache.put(cacheKey, currentLastRow.toString(), 3600);
    console.log(`âœ… Son iÅŸlenen satÄ±r: ${currentLastRow}`);
  } else {
    console.log('â„¹ï¸ Yeni veri yok');
  }
}
Ä°lk Ã§alÄ±ÅŸtÄ±rma: YavaÅŸ, sonrakiler: 100x hÄ±zlÄ±!

PARALLEL PROCESSING
6'ÅŸar Chunk

function parallelProcess(items) {
  const chunkSize = 6;
  
  for (let i = 0; i < items.length; i += chunkSize) {
    const chunk = items.slice(i, i + chunkSize);
    console.log(`ğŸ“Š Chunk ${Math.floor(i/chunkSize) + 1} iÅŸleniyor...`);
    chunk.map(item => processItem(item));
  }
  
  console.log(`âœ… ${items.length} item iÅŸlendi`);
}
12 item: 96s â†’ 16s (6x hÄ±zlÄ±!)



## FLUSH KULLANIMI (KRÄ°TÄ°K!)
### ğŸ¯ flush() NE ZAMAN KULLANILIR?
**1ï¸âƒ£ ZORUNLU (hemen flush!):**
```javascript
// clearDataValidations() sonrasÄ± â†’ ZORUNLU!
range.clearDataValidations();
SpreadsheetApp.flush(); // â† ZORUNLU!
range.setValues([values]);
// setDataValidation() sonrasÄ± â†’ ZORUNLU!
range.setDataValidation(validation);
SpreadsheetApp.flush(); // â† ZORUNLU!
2ï¸âƒ£ Ã–NERÄ°LÄ°R (toplu iÅŸlemden sonra):


// Batch renklendirme sonrasÄ±
const colors = Array(150).fill(Array(10).fill('#E8F5E8'));
sheet.getRange(2, 1, 150, 10).setBackgrounds(colors);
SpreadsheetApp.flush(); // â† Ã–NERÄ°LÄ°R
// Batch veri yazma sonrasÄ±
sheet.getRange(2, 1, data.length, 10).setValues(data);
SpreadsheetApp.flush(); // â† Ã–NERÄ°LÄ°R
3ï¸âƒ£ YASAK (her kÃ¼Ã§Ã¼k iÅŸlemde):


// âŒ YANLIÅ (Ã§ok yavaÅŸ!)
sheet.getRange('A1').setValue('Test1');
SpreadsheetApp.flush(); // â† Gereksiz!
sheet.getRange('A2').setValue('Test2');
SpreadsheetApp.flush(); // â† Gereksiz!
// âœ… DOÄRU (hÄ±zlÄ±!)
sheet.getRange('A1').setValue('Test1');
sheet.getRange('A2').setValue('Test2');
sheet.getRange('A3').setValue('Test3');
SpreadsheetApp.flush(); // â† En sonda 1 kere!
ğŸ’¡ NET KURAL:

Validation iÅŸlemleri â†’ Hemen flush() (uygulanmasÄ± ZORUNLU)
Batch iÅŸlemler â†’ En sonda 1 flush() (performans iÃ§in)
Tek hÃ¼cre iÅŸlemleri â†’ flush() YAPMA! (gereksiz yavaÅŸlatÄ±r)




VALIDATION CONFLICT
Ã‡Ã¶zÃ¼m AdÄ±mlarÄ±

// 1. Validation temizle + flush
sheet.getRange("A2:Z1000").clearDataValidations();
SpreadsheetApp.flush(); // â† ZORUNLU!
// 2. Veri yaz
sheet.getRange("A2:Z100").setValues(rawData);
// 3. Format dÃ¼zelt
const timeColumn = sheet.getRange("N2:N100").getValues();
const fixedTimes = timeColumn.map(row => {
  const time = row[0];
  if (time === "09:30") return ["09:00"];
  if (time === "10:30") return ["10:00"];
  return row;
});
sheet.getRange("N2:N100").setValues(fixedTimes);
// 4. Validation ekle + flush
const timeValidation = SpreadsheetApp.newDataValidation()
  .requireValueInList(["09:00", "10:00", "11:00"])
  .build();
sheet.getRange("N2:N100").setDataValidation(timeValidation);
SpreadsheetApp.flush(); // â† ZORUNLU!



SÄ±k Hatalar
âŒ YanlÄ±ÅŸ	âœ… DoÄŸru
Validation sonra dÃ¼zelt	Ã–nce temizle
setValue tek tek	setValues batch
Eski validation kalsÄ±n	clearDataValidations
Veri dropdown dÄ±ÅŸÄ±	Ã–nce uyarla

COMMON ERRORS
ReferenceError: X is not defined â†’ DeÄŸiÅŸken tanÄ±msÄ±z

TypeError: Cannot read property X of undefined â†’ Obje null/undefined

Exception: Range not found â†’ A1 notation yanlÄ±ÅŸ

Exception: Service invoked too many times â†’ Batch kullan

Data validation error in cell X â†’ clearDataValidations ekle

Exception: Invalid range coordinates â†’ getRange parametreleri yanlÄ±ÅŸ




CHECKLIST
â–¡ Batch operations kullanÄ±lÄ±yor
â–¡ Cache kullanÄ±lÄ±yor
â–¡ Try-catch var
â–¡ Performance Ã¶lÃ§Ã¼lÃ¼yor
â–¡ Array-Header sync kontrol
â–¡ Validation error handling var
â–¡ Structured logging yapÄ±lÄ±yor
â–¡ flush() kurallarÄ±na uyuluyor

Ã–ZET
âœ… YAP
Batch operations (100x hÄ±zlÄ±)
Cache kullan (ilk yavaÅŸ sonrasÄ± hÄ±zlÄ±)
Try-catch (production-ready)
Performance Ã¶lÃ§ (<3s hedef)
Structured logging (JSON)
Validation: Temizle + flush â†’ Yaz â†’ DÃ¼zelt â†’ Ekle + flush
âŒ YAPMA
Loop iÃ§inde API call
flush() kurallarÄ±nÄ± ihlal etme
Cache'siz Ã§alÄ±ÅŸma
Validation conflict ignore
Array-Header sync kontrolsÃ¼z

## ğŸš¨ Deploy GÃ¼venliÄŸi
**KURAL:** Deploy yaparken tek dosya push etme, tÃ¼m dosyalarÄ± push et!
```bash
# âŒ YANLIÅ
clasp push src/agents/backend.js  # DiÄŸer dosyalar SÄ°LÄ°NÄ°R!
# âœ… DOÄRU
cd ~/Desktop/Google-Sheets-CRM
clasp push  # TÃ¼m dosyalar gÃ¼venli
Sebep: Google Apps Script'te tek dosya push edince, diÄŸer dosyalar silinir.

ğŸ“š DÃ¶kÃ¼man Senkronizasyonu
KURAL: Kod deÄŸiÅŸince ilgili dÃ¶kÃ¼manlarÄ± gÃ¼ncelle!

Format Tablo deÄŸiÅŸti â†’ docs/sayfa_kolonlari.md gÃ¼ncelle
Renk deÄŸiÅŸti â†’ docs/RENK_KODLARI.md gÃ¼ncelle
Mapping deÄŸiÅŸti â†’ src/shared/smart-column-mapping.js gÃ¼ncelle
âœ… Ä°ÅŸ Tamamlama ProtokolÃ¼
KURAL: Ä°ÅŸ bitince sÄ±rayla:

Test et
DÃ¶kÃ¼man gÃ¼ncelle
Deploy et (clasp push)
Git commit & push
Rapor ver
